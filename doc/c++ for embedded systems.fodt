<?xml version="1.0" encoding="UTF-8"?>

<office:document xmlns:office="urn:oasis:names:tc:opendocument:xmlns:office:1.0" xmlns:style="urn:oasis:names:tc:opendocument:xmlns:style:1.0" xmlns:text="urn:oasis:names:tc:opendocument:xmlns:text:1.0" xmlns:table="urn:oasis:names:tc:opendocument:xmlns:table:1.0" xmlns:draw="urn:oasis:names:tc:opendocument:xmlns:drawing:1.0" xmlns:fo="urn:oasis:names:tc:opendocument:xmlns:xsl-fo-compatible:1.0" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:meta="urn:oasis:names:tc:opendocument:xmlns:meta:1.0" xmlns:number="urn:oasis:names:tc:opendocument:xmlns:datastyle:1.0" xmlns:svg="urn:oasis:names:tc:opendocument:xmlns:svg-compatible:1.0" xmlns:chart="urn:oasis:names:tc:opendocument:xmlns:chart:1.0" xmlns:dr3d="urn:oasis:names:tc:opendocument:xmlns:dr3d:1.0" xmlns:math="http://www.w3.org/1998/Math/MathML" xmlns:form="urn:oasis:names:tc:opendocument:xmlns:form:1.0" xmlns:script="urn:oasis:names:tc:opendocument:xmlns:script:1.0" xmlns:config="urn:oasis:names:tc:opendocument:xmlns:config:1.0" xmlns:ooo="http://openoffice.org/2004/office" xmlns:ooow="http://openoffice.org/2004/writer" xmlns:oooc="http://openoffice.org/2004/calc" xmlns:dom="http://www.w3.org/2001/xml-events" xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:rpt="http://openoffice.org/2005/report" xmlns:of="urn:oasis:names:tc:opendocument:xmlns:of:1.2" xmlns:xhtml="http://www.w3.org/1999/xhtml" xmlns:grddl="http://www.w3.org/2003/g/data-view#" xmlns:officeooo="http://openoffice.org/2009/office" xmlns:tableooo="http://openoffice.org/2009/table" xmlns:drawooo="http://openoffice.org/2010/draw" xmlns:calcext="urn:org:documentfoundation:names:experimental:calc:xmlns:calcext:1.0" xmlns:loext="urn:org:documentfoundation:names:experimental:office:xmlns:loext:1.0" xmlns:field="urn:openoffice:names:experimental:ooo-ms-interop:xmlns:field:1.0" xmlns:formx="urn:openoffice:names:experimental:ooxml-odf-interop:xmlns:form:1.0" xmlns:css3t="http://www.w3.org/TR/css3-text/" office:version="1.2" office:mimetype="application/vnd.oasis.opendocument.text">
 <office:meta><meta:initial-creator>arkady </meta:initial-creator><meta:creation-date>2015-04-24T15:47:16.425999108</meta:creation-date><dc:date>2015-05-24T21:54:01.244626186</dc:date><dc:creator>arkady </dc:creator><meta:editing-duration>P8DT20H3M24S</meta:editing-duration><meta:editing-cycles>3348</meta:editing-cycles><meta:generator>LibreOffice/4.2.8.2$Linux_X86_64 LibreOffice_project/420m0$Build-2</meta:generator><meta:document-statistic meta:table-count="1" meta:image-count="0" meta:object-count="0" meta:page-count="177" meta:paragraph-count="1935" meta:word-count="13781" meta:character-count="97869" meta:non-whitespace-character-count="79969"/></office:meta>
 <office:settings>
  <config:config-item-set config:name="ooo:view-settings">
   <config:config-item config:name="ViewAreaTop" config:type="long">4179863</config:config-item>
   <config:config-item config:name="ViewAreaLeft" config:type="long">0</config:config-item>
   <config:config-item config:name="ViewAreaWidth" config:type="long">22661</config:config-item>
   <config:config-item config:name="ViewAreaHeight" config:type="long">10904</config:config-item>
   <config:config-item config:name="ShowRedlineChanges" config:type="boolean">true</config:config-item>
   <config:config-item config:name="InBrowseMode" config:type="boolean">false</config:config-item>
   <config:config-item-map-indexed config:name="Views">
    <config:config-item-map-entry>
     <config:config-item config:name="ViewId" config:type="string">view2</config:config-item>
     <config:config-item config:name="ViewLeft" config:type="long">16489</config:config-item>
     <config:config-item config:name="ViewTop" config:type="long">4183320</config:config-item>
     <config:config-item config:name="VisibleLeft" config:type="long">0</config:config-item>
     <config:config-item config:name="VisibleTop" config:type="long">4179863</config:config-item>
     <config:config-item config:name="VisibleRight" config:type="long">22659</config:config-item>
     <config:config-item config:name="VisibleBottom" config:type="long">4190765</config:config-item>
     <config:config-item config:name="ZoomType" config:type="short">3</config:config-item>
     <config:config-item config:name="ViewLayoutColumns" config:type="short">1</config:config-item>
     <config:config-item config:name="ViewLayoutBookMode" config:type="boolean">false</config:config-item>
     <config:config-item config:name="ZoomFactor" config:type="short">289</config:config-item>
     <config:config-item config:name="IsSelectedFrame" config:type="boolean">false</config:config-item>
    </config:config-item-map-entry>
   </config:config-item-map-indexed>
  </config:config-item-set>
  <config:config-item-set config:name="ooo:configuration-settings">
   <config:config-item config:name="PrintFaxName" config:type="string"/>
   <config:config-item config:name="PrintAnnotationMode" config:type="short">0</config:config-item>
   <config:config-item config:name="PrintControls" config:type="boolean">true</config:config-item>
   <config:config-item config:name="PrintPageBackground" config:type="boolean">true</config:config-item>
   <config:config-item config:name="PrintRightPages" config:type="boolean">true</config:config-item>
   <config:config-item config:name="PrintProspect" config:type="boolean">false</config:config-item>
   <config:config-item config:name="PrintSingleJobs" config:type="boolean">false</config:config-item>
   <config:config-item config:name="PrintEmptyPages" config:type="boolean">false</config:config-item>
   <config:config-item config:name="ApplyParagraphMarkFormatToNumbering" config:type="boolean">true</config:config-item>
   <config:config-item config:name="TabOverMargin" config:type="boolean">false</config:config-item>
   <config:config-item config:name="EmbedSystemFonts" config:type="boolean">false</config:config-item>
   <config:config-item config:name="EmbedFonts" config:type="boolean">false</config:config-item>
   <config:config-item config:name="BackgroundParaOverDrawings" config:type="boolean">false</config:config-item>
   <config:config-item config:name="UnbreakableNumberings" config:type="boolean">false</config:config-item>
   <config:config-item config:name="TabOverflow" config:type="boolean">true</config:config-item>
   <config:config-item config:name="SmallCapsPercentage66" config:type="boolean">false</config:config-item>
   <config:config-item config:name="PrintDrawings" config:type="boolean">true</config:config-item>
   <config:config-item config:name="CollapseEmptyCellPara" config:type="boolean">true</config:config-item>
   <config:config-item config:name="RsidRoot" config:type="int">1049985</config:config-item>
   <config:config-item config:name="UnxForceZeroExtLeading" config:type="boolean">false</config:config-item>
   <config:config-item config:name="ClipAsCharacterAnchoredWriterFlyFrames" config:type="boolean">false</config:config-item>
   <config:config-item config:name="ClippedPictures" config:type="boolean">false</config:config-item>
   <config:config-item config:name="DoNotCaptureDrawObjsOnPage" config:type="boolean">false</config:config-item>
   <config:config-item config:name="LoadReadonly" config:type="boolean">false</config:config-item>
   <config:config-item config:name="IgnoreTabsAndBlanksForLineCalculation" config:type="boolean">false</config:config-item>
   <config:config-item config:name="DoNotResetParaAttrsForNumFont" config:type="boolean">false</config:config-item>
   <config:config-item config:name="DoNotJustifyLinesWithManualBreak" config:type="boolean">false</config:config-item>
   <config:config-item config:name="PrintBlackFonts" config:type="boolean">false</config:config-item>
   <config:config-item config:name="UseFormerTextWrapping" config:type="boolean">false</config:config-item>
   <config:config-item config:name="TabsRelativeToIndent" config:type="boolean">false</config:config-item>
   <config:config-item config:name="AddParaSpacingToTableCells" config:type="boolean">true</config:config-item>
   <config:config-item config:name="TableRowKeep" config:type="boolean">false</config:config-item>
   <config:config-item config:name="UseOldPrinterMetrics" config:type="boolean">false</config:config-item>
   <config:config-item config:name="UseFormerLineSpacing" config:type="boolean">false</config:config-item>
   <config:config-item config:name="TabAtLeftIndentForParagraphsInList" config:type="boolean">false</config:config-item>
   <config:config-item config:name="AllowPrintJobCancel" config:type="boolean">true</config:config-item>
   <config:config-item config:name="UseOldNumbering" config:type="boolean">false</config:config-item>
   <config:config-item config:name="AddExternalLeading" config:type="boolean">true</config:config-item>
   <config:config-item config:name="FloattableNomargins" config:type="boolean">false</config:config-item>
   <config:config-item config:name="SurroundTextWrapSmall" config:type="boolean">true</config:config-item>
   <config:config-item config:name="IsLabelDocument" config:type="boolean">false</config:config-item>
   <config:config-item config:name="PrintReversed" config:type="boolean">false</config:config-item>
   <config:config-item config:name="IgnoreFirstLineIndentInNumbering" config:type="boolean">false</config:config-item>
   <config:config-item config:name="UseFormerObjectPositioning" config:type="boolean">false</config:config-item>
   <config:config-item config:name="PrintTables" config:type="boolean">true</config:config-item>
   <config:config-item config:name="PrinterIndependentLayout" config:type="string">high-resolution</config:config-item>
   <config:config-item config:name="SaveVersionOnClose" config:type="boolean">false</config:config-item>
   <config:config-item config:name="CurrentDatabaseCommand" config:type="string"/>
   <config:config-item config:name="CurrentDatabaseDataSource" config:type="string"/>
   <config:config-item config:name="OutlineLevelYieldsNumbering" config:type="boolean">false</config:config-item>
   <config:config-item config:name="ConsiderTextWrapOnObjPos" config:type="boolean">false</config:config-item>
   <config:config-item config:name="CurrentDatabaseCommandType" config:type="int">0</config:config-item>
   <config:config-item config:name="RedlineProtectionKey" config:type="base64Binary"/>
   <config:config-item config:name="Rsid" config:type="int">1767925</config:config-item>
   <config:config-item config:name="PrintProspectRTL" config:type="boolean">false</config:config-item>
   <config:config-item config:name="PrinterSetup" config:type="base64Binary"/>
   <config:config-item config:name="AlignTabStopPosition" config:type="boolean">true</config:config-item>
   <config:config-item config:name="ProtectForm" config:type="boolean">false</config:config-item>
   <config:config-item config:name="InvertBorderSpacing" config:type="boolean">false</config:config-item>
   <config:config-item config:name="AddParaTableSpacingAtStart" config:type="boolean">true</config:config-item>
   <config:config-item config:name="CharacterCompressionType" config:type="short">0</config:config-item>
   <config:config-item config:name="ApplyUserData" config:type="boolean">true</config:config-item>
   <config:config-item config:name="AddParaTableSpacing" config:type="boolean">false</config:config-item>
   <config:config-item config:name="PrintPaperFromSetup" config:type="boolean">false</config:config-item>
   <config:config-item config:name="ChartAutoUpdate" config:type="boolean">true</config:config-item>
   <config:config-item config:name="FieldAutoUpdate" config:type="boolean">true</config:config-item>
   <config:config-item config:name="PrintHiddenText" config:type="boolean">false</config:config-item>
   <config:config-item config:name="IsKernAsianPunctuation" config:type="boolean">false</config:config-item>
   <config:config-item config:name="PrintTextPlaceholder" config:type="boolean">false</config:config-item>
   <config:config-item config:name="PrintGraphics" config:type="boolean">true</config:config-item>
   <config:config-item config:name="StylesNoDefault" config:type="boolean">true</config:config-item>
   <config:config-item config:name="AddFrameOffsets" config:type="boolean">false</config:config-item>
   <config:config-item config:name="UpdateFromTemplate" config:type="boolean">true</config:config-item>
   <config:config-item config:name="MathBaselineAlignment" config:type="boolean">true</config:config-item>
   <config:config-item config:name="PrinterName" config:type="string"/>
   <config:config-item config:name="LinkUpdateMode" config:type="short">1</config:config-item>
   <config:config-item config:name="PrintLeftPages" config:type="boolean">true</config:config-item>
   <config:config-item config:name="SaveGlobalDocumentLinks" config:type="boolean">false</config:config-item>
  </config:config-item-set>
 </office:settings>
 <office:scripts>
  <office:script script:language="ooo:Basic">
   <ooo:libraries xmlns:ooo="http://openoffice.org/2004/office" xmlns:xlink="http://www.w3.org/1999/xlink">
    <ooo:library-embedded ooo:name="Standard"/>
   </ooo:libraries>
  </office:script>
 </office:scripts>
 <office:font-face-decls>
  <style:font-face style:name="OpenSymbol" svg:font-family="OpenSymbol" style:font-charset="x-symbol"/>
  <style:font-face style:name="DejaVuSansMono" svg:font-family="DejaVuSansMono, &apos;DejaVu Sans Mono&apos;, courier, monospace"/>
  <style:font-face style:name="Times New Roman" svg:font-family="&apos;Times New Roman&apos;"/>
  <style:font-face style:name="arial" svg:font-family="arial"/>
  <style:font-face style:name="arial1" svg:font-family="arial, helvetica, clean, sans-serif"/>
  <style:font-face style:name="Monospace1" svg:font-family="Monospace" style:font-family-generic="roman"/>
  <style:font-face style:name="FreeSans1" svg:font-family="FreeSans" style:font-family-generic="swiss"/>
  <style:font-face style:name="Monospace" svg:font-family="Monospace" style:font-pitch="fixed"/>
  <style:font-face style:name="Liberation Mono" svg:font-family="&apos;Liberation Mono&apos;" style:font-adornments="Regular" style:font-family-generic="modern" style:font-pitch="fixed"/>
  <style:font-face style:name="Liberation Serif" svg:font-family="&apos;Liberation Serif&apos;" style:font-family-generic="roman" style:font-pitch="variable"/>
  <style:font-face style:name="Liberation Sans" svg:font-family="&apos;Liberation Sans&apos;" style:font-family-generic="swiss" style:font-pitch="variable"/>
  <style:font-face style:name="Droid Sans Fallback" svg:font-family="&apos;Droid Sans Fallback&apos;" style:font-family-generic="system" style:font-pitch="variable"/>
  <style:font-face style:name="FreeSans" svg:font-family="FreeSans" style:font-family-generic="system" style:font-pitch="variable"/>
 </office:font-face-decls>
 <office:styles>
  <style:default-style style:family="graphic">
   <style:graphic-properties svg:stroke-color="#3465a4" draw:fill-color="#729fcf" fo:wrap-option="no-wrap" draw:shadow-offset-x="0.1181in" draw:shadow-offset-y="0.1181in" draw:start-line-spacing-horizontal="0.1114in" draw:start-line-spacing-vertical="0.1114in" draw:end-line-spacing-horizontal="0.1114in" draw:end-line-spacing-vertical="0.1114in" style:flow-with-text="false"/>
   <style:paragraph-properties style:text-autospace="ideograph-alpha" style:line-break="strict" style:writing-mode="lr-tb" style:font-independent-line-spacing="false">
    <style:tab-stops/>
   </style:paragraph-properties>
   <style:text-properties style:use-window-font-color="true" style:font-name="Liberation Serif" fo:font-size="12pt" fo:language="en" fo:country="US" style:letter-kerning="true" style:font-name-asian="Droid Sans Fallback" style:font-size-asian="10.5pt" style:language-asian="zh" style:country-asian="CN" style:font-name-complex="FreeSans" style:font-size-complex="12pt" style:language-complex="hi" style:country-complex="IN"/>
  </style:default-style>
  <style:default-style style:family="paragraph">
   <style:paragraph-properties fo:hyphenation-ladder-count="no-limit" style:text-autospace="ideograph-alpha" style:punctuation-wrap="hanging" style:line-break="strict" style:tab-stop-distance="0.5in" style:writing-mode="lr-tb"/>
   <style:text-properties style:use-window-font-color="true" style:font-name="Liberation Serif" fo:font-size="12pt" fo:language="en" fo:country="US" style:letter-kerning="true" style:font-name-asian="Droid Sans Fallback" style:font-size-asian="10.5pt" style:language-asian="zh" style:country-asian="CN" style:font-name-complex="FreeSans" style:font-size-complex="12pt" style:language-complex="hi" style:country-complex="IN" fo:hyphenate="false" fo:hyphenation-remain-char-count="2" fo:hyphenation-push-char-count="2"/>
  </style:default-style>
  <style:default-style style:family="table">
   <style:table-properties table:border-model="collapsing"/>
  </style:default-style>
  <style:default-style style:family="table-row">
   <style:table-row-properties fo:keep-together="auto"/>
  </style:default-style>
  <style:style style:name="Standard" style:family="paragraph" style:class="text"/>
  <style:style style:name="Heading" style:family="paragraph" style:parent-style-name="Standard" style:next-style-name="Text_20_body" style:class="text">
   <style:paragraph-properties fo:margin-top="0.1665in" fo:margin-bottom="0.0835in" style:contextual-spacing="false" fo:keep-with-next="always"/>
   <style:text-properties style:font-name="Liberation Sans" fo:font-family="&apos;Liberation Sans&apos;" style:font-family-generic="swiss" style:font-pitch="variable" fo:font-size="14pt" style:font-name-asian="Droid Sans Fallback" style:font-family-asian="&apos;Droid Sans Fallback&apos;" style:font-family-generic-asian="system" style:font-pitch-asian="variable" style:font-size-asian="14pt" style:font-name-complex="FreeSans" style:font-family-complex="FreeSans" style:font-family-generic-complex="system" style:font-pitch-complex="variable" style:font-size-complex="14pt"/>
  </style:style>
  <style:style style:name="Text_20_body" style:display-name="Text body" style:family="paragraph" style:parent-style-name="Standard" style:class="text">
   <style:paragraph-properties fo:margin-top="0in" fo:margin-bottom="0.0972in" style:contextual-spacing="false" fo:line-height="120%"/>
  </style:style>
  <style:style style:name="List" style:family="paragraph" style:parent-style-name="Text_20_body" style:class="list">
   <style:text-properties style:font-size-asian="12pt" style:font-name-complex="FreeSans1" style:font-family-complex="FreeSans" style:font-family-generic-complex="swiss"/>
  </style:style>
  <style:style style:name="Caption" style:family="paragraph" style:parent-style-name="Standard" style:class="extra">
   <style:paragraph-properties fo:margin-top="0.0835in" fo:margin-bottom="0.0835in" style:contextual-spacing="false" text:number-lines="false" text:line-number="0"/>
   <style:text-properties fo:font-size="12pt" fo:font-style="italic" style:font-size-asian="12pt" style:font-style-asian="italic" style:font-name-complex="FreeSans1" style:font-family-complex="FreeSans" style:font-family-generic-complex="swiss" style:font-size-complex="12pt" style:font-style-complex="italic"/>
  </style:style>
  <style:style style:name="Index" style:family="paragraph" style:parent-style-name="Standard" style:class="index">
   <style:paragraph-properties text:number-lines="false" text:line-number="0"/>
   <style:text-properties style:font-size-asian="12pt" style:font-name-complex="FreeSans1" style:font-family-complex="FreeSans" style:font-family-generic-complex="swiss"/>
  </style:style>
  <style:style style:name="Heading_20_1" style:display-name="Heading 1" style:family="paragraph" style:parent-style-name="Heading" style:next-style-name="Text_20_body" style:default-outline-level="1" style:class="text">
   <style:paragraph-properties fo:margin-top="0.1665in" fo:margin-bottom="0.0835in" style:contextual-spacing="false"/>
   <style:text-properties fo:font-size="130%" fo:font-weight="bold" style:font-size-asian="130%" style:font-weight-asian="bold" style:font-size-complex="130%" style:font-weight-complex="bold"/>
  </style:style>
  <style:style style:name="Text_20_body_20_indent" style:display-name="Text body indent" style:family="paragraph" style:parent-style-name="Text_20_body" style:class="text">
   <style:paragraph-properties fo:margin-left="0.1965in" fo:margin-right="0in" fo:margin-top="0in" fo:margin-bottom="0in" style:contextual-spacing="false" fo:text-indent="0in" style:auto-text-indent="false"/>
  </style:style>
  <style:style style:name="Heading_20_2" style:display-name="Heading 2" style:family="paragraph" style:parent-style-name="Heading" style:next-style-name="Text_20_body" style:default-outline-level="2" style:class="text">
   <style:paragraph-properties fo:margin-top="0.139in" fo:margin-bottom="0.0835in" style:contextual-spacing="false"/>
   <style:text-properties fo:font-size="115%" fo:font-weight="bold" style:font-size-asian="115%" style:font-weight-asian="bold" style:font-size-complex="115%" style:font-weight-complex="bold"/>
  </style:style>
  <style:style style:name="First_20_line_20_indent" style:display-name="First line indent" style:family="paragraph" style:parent-style-name="Text_20_body" style:class="text">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:margin-top="0in" fo:margin-bottom="0in" style:contextual-spacing="false" fo:text-indent="0.1965in" style:auto-text-indent="false"/>
  </style:style>
  <style:style style:name="Hanging_20_indent" style:display-name="Hanging indent" style:family="paragraph" style:parent-style-name="Text_20_body" style:class="text">
   <style:paragraph-properties fo:margin-left="0.3937in" fo:margin-right="0in" fo:margin-top="0in" fo:margin-bottom="0in" style:contextual-spacing="false" fo:text-indent="-0.1965in" style:auto-text-indent="false">
    <style:tab-stops>
     <style:tab-stop style:position="0in"/>
    </style:tab-stops>
   </style:paragraph-properties>
  </style:style>
  <style:style style:name="Preformatted_20_Text" style:display-name="Preformatted Text" style:family="paragraph" style:parent-style-name="Standard" style:class="html" style:master-page-name="">
   <style:paragraph-properties fo:keep-together="always" style:page-number="auto" fo:break-before="auto" fo:break-after="auto" fo:background-color="transparent">
    <style:background-image/>
   </style:paragraph-properties>
   <style:text-properties style:font-name="Liberation Mono" fo:font-family="&apos;Liberation Mono&apos;" style:font-style-name="Regular" style:font-family-generic="modern" style:font-pitch="fixed" fo:font-size="10pt" style:font-size-asian="10.5pt"/>
  </style:style>
  <style:style style:name="Quotations" style:family="paragraph" style:parent-style-name="Standard" style:class="html" style:master-page-name="">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="3in" fo:margin-top="0in" fo:margin-bottom="0in" style:contextual-spacing="false" fo:text-indent="0in" style:auto-text-indent="false" style:page-number="auto" fo:background-color="transparent" style:shadow="none">
    <style:tab-stops/>
    <style:background-image/>
   </style:paragraph-properties>
   <style:text-properties fo:font-style="italic" style:font-size-asian="10.5pt"/>
  </style:style>
  <style:style style:name="Title" style:family="paragraph" style:parent-style-name="Heading" style:class="chapter"/>
  <style:style style:name="Subtitle" style:family="paragraph" style:parent-style-name="Heading" style:class="chapter"/>
  <style:style style:name="Heading_20_3" style:display-name="Heading 3" style:family="paragraph" style:parent-style-name="Heading" style:class="text"/>
  <style:style style:name="Marginalia" style:family="paragraph" style:parent-style-name="Text_20_body" style:class="text"/>
  <style:style style:name="Header_20_right" style:display-name="Header right" style:family="paragraph" style:parent-style-name="Standard" style:class="extra"/>
  <style:style style:name="List_20_1" style:display-name="List 1" style:family="paragraph" style:parent-style-name="List" style:class="list"/>
  <style:style style:name="Numbering_20_1" style:display-name="Numbering 1" style:family="paragraph" style:parent-style-name="List" style:class="list"/>
  <style:style style:name="List_20_Indent" style:display-name="List Indent" style:family="paragraph" style:parent-style-name="Text_20_body" style:class="text"/>
  <style:style style:name="Contents_20_Heading" style:display-name="Contents Heading" style:family="paragraph" style:parent-style-name="Heading" style:class="index">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:margin-top="0in" fo:margin-bottom="0in" style:contextual-spacing="false" fo:text-align="center" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false" text:number-lines="false" text:line-number="0"/>
   <style:text-properties fo:font-size="10pt" fo:font-weight="bold" style:font-size-asian="16pt" style:font-weight-asian="bold" style:font-size-complex="16pt" style:font-weight-complex="600"/>
  </style:style>
  <style:style style:name="Contents_20_1" style:display-name="Contents 1" style:family="paragraph" style:parent-style-name="Index" style:class="index">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:margin-top="0in" fo:margin-bottom="0in" style:contextual-spacing="false" fo:text-indent="0in" style:auto-text-indent="false">
    <style:tab-stops>
     <style:tab-stop style:position="6.9252in" style:type="right" style:leader-style="dotted" style:leader-text="."/>
    </style:tab-stops>
   </style:paragraph-properties>
   <style:text-properties fo:font-size="10pt"/>
  </style:style>
  <style:style style:name="Contents_20_2" style:display-name="Contents 2" style:family="paragraph" style:parent-style-name="Index" style:class="index">
   <style:paragraph-properties fo:margin-left="0.1965in" fo:margin-right="0in" fo:margin-top="0in" fo:margin-bottom="0in" style:contextual-spacing="false" fo:text-indent="0in" style:auto-text-indent="false">
    <style:tab-stops>
     <style:tab-stop style:position="6.7283in" style:type="right" style:leader-style="dotted" style:leader-text="."/>
    </style:tab-stops>
   </style:paragraph-properties>
   <style:text-properties fo:font-size="10pt"/>
  </style:style>
  <style:style style:name="Table_20_Contents" style:display-name="Table Contents" style:family="paragraph" style:parent-style-name="Standard" style:class="extra">
   <style:paragraph-properties fo:text-align="start" style:justify-single-word="false"/>
  </style:style>
  <style:style style:name="Table_20_Heading" style:display-name="Table Heading" style:family="paragraph" style:parent-style-name="Table_20_Contents" style:class="extra"/>
  <style:style style:name="Contents_20_3" style:display-name="Contents 3" style:family="paragraph" style:parent-style-name="Index" style:class="index">
   <style:text-properties fo:font-size="10pt"/>
  </style:style>
  <style:style style:name="Frame_20_contents" style:display-name="Frame contents" style:family="paragraph" style:parent-style-name="Standard" style:class="extra"/>
  <style:style style:name="Bullet_20_Symbols" style:display-name="Bullet Symbols" style:family="text">
   <style:text-properties style:font-name="OpenSymbol" fo:font-family="OpenSymbol" style:font-charset="x-symbol" style:font-name-asian="OpenSymbol" style:font-family-asian="OpenSymbol" style:font-charset-asian="x-symbol" style:font-name-complex="OpenSymbol" style:font-family-complex="OpenSymbol" style:font-charset-complex="x-symbol"/>
  </style:style>
  <style:style style:name="Emphasis" style:family="text">
   <style:text-properties fo:font-style="italic" style:font-style-asian="italic" style:font-style-complex="italic"/>
  </style:style>
  <style:style style:name="Internet_20_link" style:display-name="Internet link" style:family="text">
   <style:text-properties fo:color="#000080" fo:language="zxx" fo:country="none" style:text-underline-style="solid" style:text-underline-width="auto" style:text-underline-color="font-color" style:language-asian="zxx" style:country-asian="none" style:language-complex="zxx" style:country-complex="none"/>
  </style:style>
  <style:style style:name="Index_20_Link" style:display-name="Index Link" style:family="text"/>
  <style:style style:name="Citation" style:family="text">
   <style:text-properties fo:font-style="italic" style:font-style-asian="italic" style:font-style-complex="italic"/>
  </style:style>
  <style:style style:name="Numbering_20_Symbols" style:display-name="Numbering Symbols" style:family="text"/>
  <style:style style:name="Frame" style:family="graphic">
   <style:graphic-properties text:anchor-type="paragraph" svg:x="0in" svg:y="0in" fo:margin-left="0.0791in" fo:margin-right="0.0791in" fo:margin-top="0.0791in" fo:margin-bottom="0.0791in" style:wrap="parallel" style:number-wrapped-paragraphs="no-limit" style:wrap-contour="false" style:vertical-pos="top" style:vertical-rel="paragraph-content" style:horizontal-pos="center" style:horizontal-rel="paragraph-content" fo:padding="0.0591in" fo:border="0.06pt solid #000000"/>
  </style:style>
  <text:outline-style style:name="Outline">
   <text:outline-level-style text:level="1" style:num-format="">
    <style:list-level-properties text:list-level-position-and-space-mode="label-alignment">
     <style:list-level-label-alignment text:label-followed-by="listtab" text:list-tab-stop-position="0.3in" fo:text-indent="-0.3in" fo:margin-left="0.3in"/>
    </style:list-level-properties>
   </text:outline-level-style>
   <text:outline-level-style text:level="2" style:num-format="">
    <style:list-level-properties text:list-level-position-and-space-mode="label-alignment">
     <style:list-level-label-alignment text:label-followed-by="listtab" text:list-tab-stop-position="0.4in" fo:text-indent="-0.4in" fo:margin-left="0.4in"/>
    </style:list-level-properties>
   </text:outline-level-style>
   <text:outline-level-style text:level="3" style:num-format="">
    <style:list-level-properties text:list-level-position-and-space-mode="label-alignment">
     <style:list-level-label-alignment text:label-followed-by="listtab" text:list-tab-stop-position="0.5in" fo:text-indent="-0.5in" fo:margin-left="0.5in"/>
    </style:list-level-properties>
   </text:outline-level-style>
   <text:outline-level-style text:level="4" style:num-format="">
    <style:list-level-properties text:list-level-position-and-space-mode="label-alignment">
     <style:list-level-label-alignment text:label-followed-by="listtab" text:list-tab-stop-position="0.6in" fo:text-indent="-0.6in" fo:margin-left="0.6in"/>
    </style:list-level-properties>
   </text:outline-level-style>
   <text:outline-level-style text:level="5" style:num-format="">
    <style:list-level-properties text:list-level-position-and-space-mode="label-alignment">
     <style:list-level-label-alignment text:label-followed-by="listtab" text:list-tab-stop-position="0.7in" fo:text-indent="-0.7in" fo:margin-left="0.7in"/>
    </style:list-level-properties>
   </text:outline-level-style>
   <text:outline-level-style text:level="6" style:num-format="">
    <style:list-level-properties text:list-level-position-and-space-mode="label-alignment">
     <style:list-level-label-alignment text:label-followed-by="listtab" text:list-tab-stop-position="0.8in" fo:text-indent="-0.8in" fo:margin-left="0.8in"/>
    </style:list-level-properties>
   </text:outline-level-style>
   <text:outline-level-style text:level="7" style:num-format="">
    <style:list-level-properties text:list-level-position-and-space-mode="label-alignment">
     <style:list-level-label-alignment text:label-followed-by="listtab" text:list-tab-stop-position="0.9in" fo:text-indent="-0.9in" fo:margin-left="0.9in"/>
    </style:list-level-properties>
   </text:outline-level-style>
   <text:outline-level-style text:level="8" style:num-format="">
    <style:list-level-properties text:list-level-position-and-space-mode="label-alignment">
     <style:list-level-label-alignment text:label-followed-by="listtab" text:list-tab-stop-position="1in" fo:text-indent="-1in" fo:margin-left="1in"/>
    </style:list-level-properties>
   </text:outline-level-style>
   <text:outline-level-style text:level="9" style:num-format="">
    <style:list-level-properties text:list-level-position-and-space-mode="label-alignment">
     <style:list-level-label-alignment text:label-followed-by="listtab" text:list-tab-stop-position="1.1in" fo:text-indent="-1.1in" fo:margin-left="1.1in"/>
    </style:list-level-properties>
   </text:outline-level-style>
   <text:outline-level-style text:level="10" style:num-format="">
    <style:list-level-properties text:list-level-position-and-space-mode="label-alignment">
     <style:list-level-label-alignment text:label-followed-by="listtab" text:list-tab-stop-position="1.2in" fo:text-indent="-1.2in" fo:margin-left="1.2in"/>
    </style:list-level-properties>
   </text:outline-level-style>
  </text:outline-style>
  <text:notes-configuration text:note-class="footnote" style:num-format="1" text:start-value="0" text:footnotes-position="page" text:start-numbering-at="document"/>
  <text:notes-configuration text:note-class="endnote" style:num-format="i" text:start-value="0"/>
  <text:linenumbering-configuration text:number-lines="false" text:offset="0.1965in" style:num-format="1" text:number-position="left" text:increment="5"/>
  <style:default-page-layout>
   <style:page-layout-properties style:writing-mode="lr-tb" style:layout-grid-standard-mode="true"/>
  </style:default-page-layout>
 </office:styles>
 <office:automatic-styles>
  <style:style style:name="PIOUserInterface" style:family="table">
   <style:table-properties style:width="6.6875in" table:align="left"/>
  </style:style>
  <style:style style:name="PIOUserInterface.A" style:family="table-column">
   <style:table-column-properties style:column-width="0.8125in"/>
  </style:style>
  <style:style style:name="PIOUserInterface.B" style:family="table-column">
   <style:table-column-properties style:column-width="3.25in"/>
  </style:style>
  <style:style style:name="PIOUserInterface.C" style:family="table-column">
   <style:table-column-properties style:column-width="1.125in"/>
  </style:style>
  <style:style style:name="PIOUserInterface.D" style:family="table-column">
   <style:table-column-properties style:column-width="1.5in"/>
  </style:style>
  <style:style style:name="PIOUserInterface.A1" style:family="table-cell">
   <style:table-cell-properties fo:padding="0.0382in" fo:border-left="0.05pt solid #000000" fo:border-right="none" fo:border-top="0.05pt solid #000000" fo:border-bottom="0.05pt solid #000000"/>
  </style:style>
  <style:style style:name="PIOUserInterface.D1" style:family="table-cell">
   <style:table-cell-properties fo:padding="0.0382in" fo:border="0.05pt solid #000000"/>
  </style:style>
  <style:style style:name="PIOUserInterface.A2" style:family="table-cell">
   <style:table-cell-properties fo:padding="0.0382in" fo:border-left="0.05pt solid #000000" fo:border-right="none" fo:border-top="none" fo:border-bottom="0.05pt solid #000000"/>
  </style:style>
  <style:style style:name="PIOUserInterface.D2" style:family="table-cell">
   <style:table-cell-properties fo:padding="0.0382in" fo:border-left="0.05pt solid #000000" fo:border-right="0.05pt solid #000000" fo:border-top="none" fo:border-bottom="0.05pt solid #000000"/>
  </style:style>
  <style:style style:name="P1" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false"/>
  </style:style>
  <style:style style:name="P2" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false" style:text-autospace="none"/>
  </style:style>
  <style:style style:name="P3" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false"/>
   <style:text-properties officeooo:paragraph-rsid="0014cf23"/>
  </style:style>
  <style:style style:name="P4" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false"/>
   <style:text-properties officeooo:paragraph-rsid="0015f441"/>
  </style:style>
  <style:style style:name="P5" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false"/>
   <style:text-properties officeooo:paragraph-rsid="001761b8"/>
  </style:style>
  <style:style style:name="P6" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false"/>
   <style:text-properties style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P7" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false"/>
   <style:text-properties style:font-name="Monospace1" fo:font-size="10pt" officeooo:paragraph-rsid="001761b8" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P8" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false"/>
   <style:text-properties fo:color="#3f7f5f" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P9" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false"/>
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P10" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false"/>
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" officeooo:paragraph-rsid="001761b8" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P11" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false" style:text-autospace="none"/>
   <style:text-properties fo:color="#000000" style:font-name="Monospace" fo:font-size="10pt" style:font-name-asian="Monospace" style:font-size-asian="10pt" style:font-name-complex="Monospace" style:font-size-complex="10pt"/>
  </style:style>
  <style:style style:name="P12" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false" style:text-autospace="none"/>
   <style:text-properties fo:color="#000000" style:font-name="Monospace" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P13" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false"/>
   <style:text-properties fo:color="#7f0055" style:font-name="Monospace1" fo:font-size="10pt" fo:font-weight="bold" style:font-size-asian="10pt" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="P14" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false" style:text-autospace="none"/>
   <style:text-properties style:font-name="Monospace" fo:font-size="10pt" style:font-name-asian="Monospace" style:font-size-asian="10pt" style:font-name-complex="Monospace" style:font-size-complex="10pt"/>
  </style:style>
  <style:style style:name="P15" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false" style:text-autospace="none"/>
   <style:text-properties style:font-name="Monospace" fo:font-size="10pt" style:font-size-asian="10pt" style:font-size-complex="10pt"/>
  </style:style>
  <style:style style:name="P16" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false"/>
   <style:text-properties style:text-underline-style="none"/>
  </style:style>
  <style:style style:name="P17" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false" fo:break-before="page"/>
  </style:style>
  <style:style style:name="P18" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false" fo:break-before="page"/>
   <style:text-properties officeooo:paragraph-rsid="0014cf23"/>
  </style:style>
  <style:style style:name="P19" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:text-properties fo:color="#3f7f5f" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P20" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:text-properties fo:color="#7f0055" style:font-name="Monospace1" fo:font-size="10pt" fo:font-weight="bold" style:font-size-asian="10pt" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="P21" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:text-properties fo:color="#000000"/>
  </style:style>
  <style:style style:name="P22" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P23" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt" style:font-size-complex="10pt"/>
  </style:style>
  <style:style style:name="P24" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" officeooo:paragraph-rsid="00100581" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P25" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" officeooo:paragraph-rsid="0015f441" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P26" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" officeooo:paragraph-rsid="001761b8" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P27" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" fo:font-weight="bold" style:font-size-asian="10pt" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="P28" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:text-properties fo:font-size="10pt" style:font-size-asian="10pt" style:font-size-complex="10pt"/>
  </style:style>
  <style:style style:name="P29" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:text-properties style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt" style:font-size-complex="10pt"/>
  </style:style>
  <style:style style:name="P30" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:text-properties style:font-name="Monospace"/>
  </style:style>
  <style:style style:name="P31" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:text-properties style:font-name="Monospace" fo:font-size="10pt" style:font-size-asian="10pt" style:font-size-complex="10pt"/>
  </style:style>
  <style:style style:name="P32" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:text-properties officeooo:paragraph-rsid="00100581"/>
  </style:style>
  <style:style style:name="P33" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:text-properties officeooo:paragraph-rsid="0015f441"/>
  </style:style>
  <style:style style:name="P34" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:text-properties officeooo:paragraph-rsid="00175906"/>
  </style:style>
  <style:style style:name="P35" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:text-properties officeooo:paragraph-rsid="001761b8"/>
  </style:style>
  <style:style style:name="P36" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:text-properties officeooo:rsid="001761b8" officeooo:paragraph-rsid="001761b8"/>
  </style:style>
  <style:style style:name="P37" style:family="paragraph" style:parent-style-name="Standard">
   <style:text-properties fo:color="#3f7f5f" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P38" style:family="paragraph" style:parent-style-name="Standard">
   <style:text-properties style:font-name="Monospace" fo:font-size="10pt" style:font-name-asian="Monospace" style:font-size-asian="10pt" style:font-name-complex="Monospace" style:font-size-complex="10pt"/>
  </style:style>
  <style:style style:name="P39" style:family="paragraph" style:parent-style-name="Standard">
   <style:text-properties fo:color="#000000" style:font-name="Monospace" fo:font-size="10pt" style:font-name-asian="Monospace" style:font-size-asian="10pt" style:font-name-complex="Monospace" style:font-size-complex="10pt"/>
  </style:style>
  <style:style style:name="P40" style:family="paragraph" style:parent-style-name="Standard">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P41" style:family="paragraph" style:parent-style-name="Standard">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" officeooo:paragraph-rsid="001761b8" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P42" style:family="paragraph" style:parent-style-name="Standard">
   <style:text-properties officeooo:paragraph-rsid="0014cf23"/>
  </style:style>
  <style:style style:name="P43" style:family="paragraph" style:parent-style-name="Standard">
   <style:text-properties officeooo:rsid="001761b8" officeooo:paragraph-rsid="001761b8"/>
  </style:style>
  <style:style style:name="P44" style:family="paragraph" style:parent-style-name="Standard">
   <style:text-properties officeooo:paragraph-rsid="001761b8"/>
  </style:style>
  <style:style style:name="P45" style:family="paragraph" style:parent-style-name="Quotations">
   <style:paragraph-properties fo:text-align="start" style:justify-single-word="false"/>
  </style:style>
  <style:style style:name="P46" style:family="paragraph" style:parent-style-name="Quotations">
   <style:paragraph-properties fo:text-align="end" style:justify-single-word="false"/>
  </style:style>
  <style:style style:name="P47" style:family="paragraph" style:parent-style-name="Quotations">
   <style:text-properties officeooo:rsid="0012962e" officeooo:paragraph-rsid="00147669"/>
  </style:style>
  <style:style style:name="P48" style:family="paragraph" style:parent-style-name="Quotations">
   <style:text-properties officeooo:paragraph-rsid="00147669"/>
  </style:style>
  <style:style style:name="P49" style:family="paragraph" style:parent-style-name="Quotations">
   <style:text-properties officeooo:paragraph-rsid="0015f441"/>
  </style:style>
  <style:style style:name="P50" style:family="paragraph" style:parent-style-name="Quotations">
   <style:text-properties officeooo:paragraph-rsid="001761b8"/>
  </style:style>
  <style:style style:name="P51" style:family="paragraph" style:parent-style-name="Quotations">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="11.0102in" style:auto-text-indent="false"/>
  </style:style>
  <style:style style:name="P52" style:family="paragraph" style:parent-style-name="Quotations">
   <style:paragraph-properties fo:margin-left="11in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="11in" style:auto-text-indent="false">
    <style:tab-stops/>
   </style:paragraph-properties>
  </style:style>
  <style:style style:name="P53" style:family="paragraph" style:parent-style-name="Quotations">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="15.3752in" fo:text-indent="0in" style:auto-text-indent="false"/>
  </style:style>
  <style:style style:name="P54" style:family="paragraph" style:parent-style-name="Contents_20_2">
   <style:paragraph-properties>
    <style:tab-stops>
     <style:tab-stop style:position="6.9252in" style:type="right" style:leader-style="dotted" style:leader-text="."/>
    </style:tab-stops>
   </style:paragraph-properties>
  </style:style>
  <style:style style:name="P55" style:family="paragraph" style:parent-style-name="Contents_20_2">
   <style:paragraph-properties>
    <style:tab-stops>
     <style:tab-stop style:position="0in"/>
     <style:tab-stop style:position="2in"/>
    </style:tab-stops>
   </style:paragraph-properties>
  </style:style>
  <style:style style:name="P56" style:family="paragraph" style:parent-style-name="Contents_20_1">
   <style:paragraph-properties>
    <style:tab-stops>
     <style:tab-stop style:position="6.9252in" style:type="right" style:leader-style="dotted" style:leader-text="."/>
    </style:tab-stops>
   </style:paragraph-properties>
  </style:style>
  <style:style style:name="P57" style:family="paragraph" style:parent-style-name="Contents_20_1">
   <style:paragraph-properties>
    <style:tab-stops>
     <style:tab-stop style:position="0in"/>
     <style:tab-stop style:position="2in"/>
    </style:tab-stops>
   </style:paragraph-properties>
  </style:style>
  <style:style style:name="P58" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:paragraph-properties fo:break-before="page"/>
  </style:style>
  <style:style style:name="P59" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties fo:color="#000000"/>
  </style:style>
  <style:style style:name="P60" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties officeooo:rsid="0014cf23" officeooo:paragraph-rsid="0014cf23"/>
  </style:style>
  <style:style style:name="P61" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties officeooo:paragraph-rsid="0014cf23"/>
  </style:style>
  <style:style style:name="P62" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties officeooo:paragraph-rsid="0015f441"/>
  </style:style>
  <style:style style:name="P63" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties officeooo:rsid="0015f971" officeooo:paragraph-rsid="00160f60"/>
  </style:style>
  <style:style style:name="P64" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties officeooo:paragraph-rsid="0016246b"/>
  </style:style>
  <style:style style:name="P65" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties officeooo:rsid="001761b8" officeooo:paragraph-rsid="001761b8"/>
  </style:style>
  <style:style style:name="P66" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties officeooo:paragraph-rsid="001761b8"/>
  </style:style>
  <style:style style:name="P67" style:family="paragraph" style:parent-style-name="Heading_20_1">
   <style:paragraph-properties fo:break-before="page"/>
  </style:style>
  <style:style style:name="P68" style:family="paragraph" style:parent-style-name="Heading_20_2">
   <style:paragraph-properties fo:break-before="page"/>
  </style:style>
  <style:style style:name="P69" style:family="paragraph" style:parent-style-name="Heading_20_2">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties officeooo:rsid="0012962e"/>
  </style:style>
  <style:style style:name="P70" style:family="paragraph" style:parent-style-name="Heading_20_2">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties officeooo:paragraph-rsid="0012962e"/>
  </style:style>
  <style:style style:name="P71" style:family="paragraph" style:parent-style-name="Heading_20_2">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties officeooo:paragraph-rsid="001761b8"/>
  </style:style>
  <style:style style:name="P72" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:paragraph-properties fo:break-before="page"/>
  </style:style>
  <style:style style:name="P73" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties fo:font-size="10pt" style:font-size-asian="10pt" style:font-size-complex="10pt"/>
  </style:style>
  <style:style style:name="P74" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties style:font-name="Monospace"/>
  </style:style>
  <style:style style:name="P75" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P76" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties officeooo:paragraph-rsid="0015f441"/>
  </style:style>
  <style:style style:name="P77" style:family="paragraph" style:parent-style-name="Title">
   <style:paragraph-properties fo:break-before="page"/>
  </style:style>
  <style:style style:name="P78" style:family="paragraph" style:parent-style-name="Title">
   <style:paragraph-properties fo:text-align="center" style:justify-single-word="false" fo:break-before="page"/>
  </style:style>
  <style:style style:name="P79" style:family="paragraph" style:parent-style-name="Heading_20_3">
   <style:paragraph-properties fo:break-before="page"/>
  </style:style>
  <style:style style:name="P80" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:break-before="page"/>
  </style:style>
  <style:style style:name="P81" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties fo:color="#3f7f5f" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P82" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P83" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties officeooo:rsid="001761b8" officeooo:paragraph-rsid="001761b8"/>
  </style:style>
  <style:style style:name="P84" style:family="paragraph" style:parent-style-name="Title">
   <style:paragraph-properties fo:text-align="center" style:justify-single-word="false"/>
  </style:style>
  <style:style style:name="P85" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:text-properties fo:color="#000000"/>
  </style:style>
  <style:style style:name="P86" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:text-properties style:font-name="Monospace" fo:font-size="10pt" style:font-size-asian="10pt" style:font-size-complex="10pt"/>
  </style:style>
  <style:style style:name="P87" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:text-properties officeooo:rsid="0012962e" officeooo:paragraph-rsid="0014cf23"/>
  </style:style>
  <style:style style:name="P88" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:text-properties officeooo:paragraph-rsid="00147669"/>
  </style:style>
  <style:style style:name="P89" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:text-properties officeooo:rsid="00147669" officeooo:paragraph-rsid="00147669"/>
  </style:style>
  <style:style style:name="P90" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:text-properties officeooo:rsid="0014cf23" officeooo:paragraph-rsid="0014cf23"/>
  </style:style>
  <style:style style:name="P91" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:text-properties officeooo:paragraph-rsid="0015f441"/>
  </style:style>
  <style:style style:name="P92" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:text-properties officeooo:rsid="0015f971" officeooo:paragraph-rsid="0015f971"/>
  </style:style>
  <style:style style:name="P93" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:text-properties officeooo:rsid="00160f60" officeooo:paragraph-rsid="00160f60"/>
  </style:style>
  <style:style style:name="P94" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:text-properties officeooo:paragraph-rsid="0016246b"/>
  </style:style>
  <style:style style:name="P95" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:text-properties officeooo:rsid="001761b8" officeooo:paragraph-rsid="001761b8"/>
  </style:style>
  <style:style style:name="P96" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:text-properties officeooo:paragraph-rsid="001761b8"/>
  </style:style>
  <style:style style:name="P97" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:paragraph-properties fo:text-align="center" style:justify-single-word="false"/>
   <style:text-properties fo:font-size="24pt" style:font-size-asian="24pt" style:font-size-complex="24pt"/>
  </style:style>
  <style:style style:name="P98" style:family="paragraph" style:parent-style-name="Heading_20_1">
   <style:paragraph-properties fo:text-align="center" style:justify-single-word="false"/>
  </style:style>
  <style:style style:name="P99" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false"/>
  </style:style>
  <style:style style:name="P100" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:margin-left="0in" fo:margin-right="0in" fo:text-align="start" style:justify-single-word="false" fo:text-indent="0in" style:auto-text-indent="false"/>
   <style:text-properties style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P101" style:family="paragraph" style:parent-style-name="Standard">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" officeooo:paragraph-rsid="0015f441" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P102" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:paragraph-properties fo:break-before="page"/>
  </style:style>
  <style:style style:name="P103" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties officeooo:rsid="001761b8" officeooo:paragraph-rsid="001af9f5"/>
  </style:style>
  <style:style style:name="P104" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties officeooo:rsid="001af9f5" officeooo:paragraph-rsid="001af9f5"/>
  </style:style>
  <style:style style:name="P105" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties fo:color="#000000" officeooo:paragraph-rsid="001af9f5"/>
  </style:style>
  <style:style style:name="P106" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties officeooo:paragraph-rsid="001af9f5"/>
  </style:style>
  <style:style style:name="P107" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:text-properties officeooo:paragraph-rsid="001af9f5"/>
  </style:style>
  <style:style style:name="P108" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:text-properties officeooo:rsid="001af9f5" officeooo:paragraph-rsid="001af9f5"/>
  </style:style>
  <style:style style:name="P109" style:family="paragraph" style:parent-style-name="Text_20_body">
   <style:text-properties fo:color="#000000" officeooo:paragraph-rsid="001af9f5"/>
  </style:style>
  <style:style style:name="P110" style:family="paragraph" style:parent-style-name="Heading_20_1" style:list-style-name=""/>
  <style:style style:name="P111" style:family="paragraph" style:parent-style-name="Heading_20_1" style:list-style-name=""/>
  <style:style style:name="P112" style:family="paragraph" style:parent-style-name="Heading_20_1">
   <style:paragraph-properties fo:break-before="page"/>
  </style:style>
  <style:style style:name="P113" style:family="paragraph" style:parent-style-name="Heading_20_2" style:list-style-name=""/>
  <style:style style:name="P114" style:family="paragraph" style:parent-style-name="Heading_20_2">
   <style:paragraph-properties fo:break-before="page"/>
  </style:style>
  <style:style style:name="P115" style:family="paragraph" style:parent-style-name="Heading_20_2">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties officeooo:paragraph-rsid="0012962e"/>
  </style:style>
  <style:style style:name="P116" style:family="paragraph" style:parent-style-name="Heading_20_2">
   <style:paragraph-properties fo:break-before="page"/>
   <style:text-properties officeooo:paragraph-rsid="001761b8"/>
  </style:style>
  <style:style style:name="P117" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P118" style:family="paragraph" style:parent-style-name="Preformatted_20_Text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" officeooo:paragraph-rsid="0015f441" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="P119" style:family="paragraph" style:parent-style-name="Title">
   <style:paragraph-properties fo:text-align="center" style:justify-single-word="false"/>
  </style:style>
  <style:style style:name="P120" style:family="paragraph" style:parent-style-name="Contents_20_2">
   <style:paragraph-properties>
    <style:tab-stops>
     <style:tab-stop style:position="0in"/>
     <style:tab-stop style:position="2in"/>
    </style:tab-stops>
   </style:paragraph-properties>
  </style:style>
  <style:style style:name="P121" style:family="paragraph" style:parent-style-name="Contents_20_1">
   <style:paragraph-properties>
    <style:tab-stops>
     <style:tab-stop style:position="0in"/>
     <style:tab-stop style:position="2in"/>
    </style:tab-stops>
   </style:paragraph-properties>
  </style:style>
  <style:style style:name="T1" style:family="text">
   <style:text-properties fo:color="#3f7f5f"/>
  </style:style>
  <style:style style:name="T2" style:family="text">
   <style:text-properties fo:color="#3f7f5f" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T3" style:family="text">
   <style:text-properties fo:color="#3f7f5f" style:font-name="Monospace1" fo:font-size="10pt" style:text-underline-style="solid" style:text-underline-width="auto" style:text-underline-color="font-color" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T4" style:family="text">
   <style:text-properties fo:color="#3f7f5f" style:font-name-asian="Monospace" style:font-name-complex="Monospace"/>
  </style:style>
  <style:style style:name="T5" style:family="text">
   <style:text-properties fo:color="#7f0055" style:font-name="Monospace1" fo:font-size="10pt" fo:font-weight="bold" style:font-size-asian="10pt" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T6" style:family="text">
   <style:text-properties fo:color="#7f0055" style:font-name="Monospace1" fo:font-size="10pt" fo:font-weight="bold" style:font-size-asian="10pt" style:font-weight-asian="bold" style:font-size-complex="10pt"/>
  </style:style>
  <style:style style:name="T7" style:family="text">
   <style:text-properties fo:color="#7f0055" style:font-name="Monospace1" fo:font-size="10pt" fo:font-weight="bold" officeooo:rsid="0015f441" style:font-size-asian="10pt" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T8" style:family="text">
   <style:text-properties fo:color="#7f0055" style:font-name="Monospace1" fo:font-size="10pt" fo:font-weight="bold" officeooo:rsid="001761b8" style:font-size-asian="10pt" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T9" style:family="text">
   <style:text-properties fo:color="#7f0055" style:font-name="Monospace1" fo:font-weight="bold" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T10" style:family="text">
   <style:text-properties fo:color="#7f0055" fo:font-weight="bold" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T11" style:family="text">
   <style:text-properties fo:color="#7f0055" fo:font-weight="bold" style:font-weight-asian="bold" style:font-weight-complex="bold"/>
  </style:style>
  <style:style style:name="T12" style:family="text">
   <style:text-properties fo:color="#7f0055" style:font-name="Monospace" fo:font-size="10pt" fo:font-weight="bold" style:font-name-asian="Monospace" style:font-size-asian="10pt" style:font-weight-asian="bold" style:font-name-complex="Monospace" style:font-size-complex="10pt" style:font-weight-complex="bold"/>
  </style:style>
  <style:style style:name="T13" style:family="text">
   <style:text-properties fo:color="#7f0055" fo:font-size="10pt" fo:font-weight="bold" style:font-size-asian="10pt" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T14" style:family="text">
   <style:text-properties fo:color="#7f0055" style:font-name="Monospace1" fo:font-size="10pt" fo:font-weight="bold" style:font-size-asian="10pt" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T15" style:family="text">
   <style:text-properties fo:color="#7f0055" style:font-name="Monospace1" fo:font-weight="bold" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T16" style:family="text">
   <style:text-properties fo:color="#000000"/>
  </style:style>
  <style:style style:name="T17" style:family="text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1"/>
  </style:style>
  <style:style style:name="T18" style:family="text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T19" style:family="text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt" style:font-size-complex="10pt"/>
  </style:style>
  <style:style style:name="T20" style:family="text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" officeooo:rsid="00160f60" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T21" style:family="text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" officeooo:rsid="001761b8" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T22" style:family="text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" fo:font-weight="bold" style:font-size-asian="10pt" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T23" style:family="text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" fo:font-weight="bold" officeooo:rsid="001761b8" style:font-size-asian="10pt" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T24" style:family="text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" style:text-underline-style="none" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T25" style:family="text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" style:text-underline-style="solid" style:text-underline-width="auto" style:text-underline-color="font-color" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T26" style:family="text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" fo:font-style="italic" style:font-size-asian="10pt" style:font-style-asian="italic"/>
  </style:style>
  <style:style style:name="T27" style:family="text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-weight="bold" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T28" style:family="text">
   <style:text-properties fo:color="#000000" fo:font-weight="bold" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T29" style:family="text">
   <style:text-properties fo:color="#000000" fo:font-weight="bold" style:font-weight-asian="bold" style:font-weight-complex="bold"/>
  </style:style>
  <style:style style:name="T30" style:family="text">
   <style:text-properties fo:color="#000000" style:font-name-asian="Monospace" style:font-name-complex="Monospace"/>
  </style:style>
  <style:style style:name="T31" style:family="text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace" fo:font-size="10pt" style:font-name-asian="Monospace" style:font-size-asian="10pt" style:font-name-complex="Monospace" style:font-size-complex="10pt"/>
  </style:style>
  <style:style style:name="T32" style:family="text">
   <style:text-properties fo:color="#000000" style:font-name="Times New Roman" fo:font-size="14pt"/>
  </style:style>
  <style:style style:name="T33" style:family="text">
   <style:text-properties fo:color="#000000" style:font-name="arial" fo:font-size="10pt" fo:font-weight="bold"/>
  </style:style>
  <style:style style:name="T34" style:family="text">
   <style:text-properties fo:color="#000000" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T35" style:family="text">
   <style:text-properties fo:color="#000000" fo:font-size="10pt" fo:font-weight="bold" style:font-size-asian="10pt" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T36" style:family="text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T37" style:family="text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" officeooo:rsid="001af9f5" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T38" style:family="text">
   <style:text-properties fo:color="#000000" style:font-name="Monospace1" fo:font-size="10pt" fo:font-weight="bold" style:font-size-asian="10pt" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T39" style:family="text">
   <style:text-properties fo:color="#005032"/>
  </style:style>
  <style:style style:name="T40" style:family="text">
   <style:text-properties fo:color="#005032" style:font-name="Monospace1"/>
  </style:style>
  <style:style style:name="T41" style:family="text">
   <style:text-properties fo:color="#005032" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T42" style:family="text">
   <style:text-properties fo:color="#005032" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt" style:font-size-complex="10pt"/>
  </style:style>
  <style:style style:name="T43" style:family="text">
   <style:text-properties fo:color="#005032" style:font-name="Monospace1" fo:font-size="10pt" officeooo:rsid="001761b8" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T44" style:family="text">
   <style:text-properties fo:color="#005032" style:font-name="Monospace1" fo:font-size="10pt" officeooo:rsid="00182e7a" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T45" style:family="text">
   <style:text-properties fo:color="#005032" style:font-name="Monospace1" fo:font-size="10pt" style:text-underline-style="solid" style:text-underline-width="auto" style:text-underline-color="font-color" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T46" style:family="text">
   <style:text-properties fo:color="#005032" style:font-name="Monospace" fo:font-size="10pt" style:font-name-asian="Monospace" style:font-size-asian="10pt" style:font-name-complex="Monospace" style:font-size-complex="10pt"/>
  </style:style>
  <style:style style:name="T47" style:family="text">
   <style:text-properties fo:color="#005032" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T48" style:family="text">
   <style:text-properties fo:color="#005032" style:font-name="Monospace1"/>
  </style:style>
  <style:style style:name="T49" style:family="text">
   <style:text-properties fo:color="#005032" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T50" style:family="text">
   <style:text-properties fo:color="#2a00ff"/>
  </style:style>
  <style:style style:name="T51" style:family="text">
   <style:text-properties fo:color="#2a00ff" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T52" style:family="text">
   <style:text-properties fo:color="#2a00ff" style:font-name="Monospace1" fo:font-size="10pt" style:text-underline-style="solid" style:text-underline-width="auto" style:text-underline-color="font-color" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T53" style:family="text">
   <style:text-properties fo:color="#2a00ff" style:font-name="Monospace1" fo:font-size="10pt" style:text-underline-style="none" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T54" style:family="text">
   <style:text-properties fo:color="#2a00ff" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T55" style:family="text">
   <style:text-properties fo:color="#642880" style:font-name="Monospace1" fo:font-size="10pt" fo:font-weight="bold" style:font-size-asian="10pt" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T56" style:family="text">
   <style:text-properties fo:color="#644632" style:font-name="Monospace1" fo:font-size="10pt" fo:font-weight="bold" style:font-size-asian="10pt" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T57" style:family="text">
   <style:text-properties fo:color="#644632" style:font-name="Monospace1" fo:font-weight="bold" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T58" style:family="text">
   <style:text-properties fo:color="#644632" fo:font-weight="bold" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T59" style:family="text">
   <style:text-properties fo:color="#644632" fo:font-weight="bold" style:font-weight-asian="bold" style:font-weight-complex="bold"/>
  </style:style>
  <style:style style:name="T60" style:family="text">
   <style:text-properties fo:color="#644632" style:font-name="Monospace" fo:font-size="10pt" fo:font-weight="bold" style:font-name-asian="Monospace" style:font-size-asian="10pt" style:font-weight-asian="bold" style:font-name-complex="Monospace" style:font-size-complex="10pt" style:font-weight-complex="bold"/>
  </style:style>
  <style:style style:name="T61" style:family="text">
   <style:text-properties fo:color="#644632" fo:font-size="10pt" fo:font-weight="bold" style:font-size-asian="10pt" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T62" style:family="text">
   <style:text-properties fo:color="#644632" style:font-name="Monospace1" fo:font-size="10pt" fo:font-weight="bold" style:font-size-asian="10pt" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T63" style:family="text">
   <style:text-properties fo:color="#644632" style:font-name="Monospace1" fo:font-weight="bold" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T64" style:family="text">
   <style:text-properties fo:color="#0000c0"/>
  </style:style>
  <style:style style:name="T65" style:family="text">
   <style:text-properties fo:color="#0000c0" style:font-name="Monospace1"/>
  </style:style>
  <style:style style:name="T66" style:family="text">
   <style:text-properties fo:color="#0000c0" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T67" style:family="text">
   <style:text-properties fo:color="#0000c0" style:font-name="Monospace1" fo:font-size="10pt" fo:font-style="italic" style:font-size-asian="10pt" style:font-style-asian="italic"/>
  </style:style>
  <style:style style:name="T68" style:family="text">
   <style:text-properties fo:color="#0000c0" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T69" style:family="text">
   <style:text-properties fo:color="#0000c0" style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T70" style:family="text">
   <style:text-properties fo:font-weight="bold" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T71" style:family="text">
   <style:text-properties fo:font-weight="bold" style:font-weight-asian="bold" style:font-weight-complex="bold"/>
  </style:style>
  <style:style style:name="T72" style:family="text">
   <style:text-properties style:font-name="Monospace1"/>
  </style:style>
  <style:style style:name="T73" style:family="text">
   <style:text-properties style:font-name="Monospace1" fo:font-weight="bold" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="T74" style:family="text">
   <style:text-properties style:font-name="Monospace1" fo:font-size="10pt" style:font-size-asian="10pt"/>
  </style:style>
  <style:style style:name="T75" style:family="text">
   <style:text-properties fo:font-style="italic" style:font-style-asian="italic" style:font-style-complex="italic"/>
  </style:style>
  <style:style style:name="T76" style:family="text">
   <style:text-properties fo:font-variant="normal" fo:text-transform="none" fo:color="#a21f11" style:font-name="arial1" fo:font-size="9.75pt" fo:letter-spacing="normal" fo:font-style="normal" fo:font-weight="bold"/>
  </style:style>
  <style:style style:name="T77" style:family="text">
   <style:text-properties fo:font-variant="normal" fo:text-transform="none" fo:color="#000000" style:font-name="DejaVuSansMono" fo:font-size="9pt" fo:letter-spacing="normal" fo:font-style="normal" fo:font-weight="bold"/>
  </style:style>
  <style:style style:name="T78" style:family="text">
   <style:text-properties style:text-underline-style="none"/>
  </style:style>
  <style:style style:name="T79" style:family="text">
   <style:text-properties style:font-name-asian="Monospace" style:font-name-complex="Monospace" style:font-size-complex="10pt"/>
  </style:style>
  <style:style style:name="T80" style:family="text">
   <style:text-properties fo:font-size="10.5pt"/>
  </style:style>
  <style:style style:name="T81" style:family="text">
   <style:text-properties fo:font-size="10.5pt" fo:font-style="italic"/>
  </style:style>
  <style:style style:name="T82" style:family="text">
   <style:text-properties officeooo:rsid="00100581"/>
  </style:style>
  <style:style style:name="T83" style:family="text">
   <style:text-properties officeooo:rsid="00147669"/>
  </style:style>
  <style:style style:name="T84" style:family="text">
   <style:text-properties officeooo:rsid="0014cf23"/>
  </style:style>
  <style:style style:name="T85" style:family="text">
   <style:text-properties officeooo:rsid="0015f441"/>
  </style:style>
  <style:style style:name="T86" style:family="text">
   <style:text-properties officeooo:rsid="00160f60"/>
  </style:style>
  <style:style style:name="T87" style:family="text">
   <style:text-properties officeooo:rsid="0016246b"/>
  </style:style>
  <style:style style:name="T88" style:family="text">
   <style:text-properties officeooo:rsid="0016e197"/>
  </style:style>
  <style:style style:name="T89" style:family="text">
   <style:text-properties officeooo:rsid="00175906"/>
  </style:style>
  <style:style style:name="T90" style:family="text">
   <style:text-properties officeooo:rsid="001761b8"/>
  </style:style>
  <style:style style:name="T91" style:family="text">
   <style:text-properties style:text-underline-style="solid" style:text-underline-type="double" style:text-underline-width="auto" style:text-underline-color="font-color"/>
  </style:style>
  <style:style style:name="T92" style:family="text">
   <style:text-properties officeooo:rsid="001814b2"/>
  </style:style>
  <style:style style:name="T93" style:family="text">
   <style:text-properties officeooo:rsid="00182e7a"/>
  </style:style>
  <style:style style:name="T94" style:family="text">
   <style:text-properties officeooo:rsid="0019d7a5"/>
  </style:style>
  <style:style style:name="T95" style:family="text">
   <style:text-properties officeooo:rsid="001af9f5"/>
  </style:style>
  <style:style style:name="T96" style:family="text">
   <style:text-properties style:font-name="Monospace1"/>
  </style:style>
  <style:style style:name="T97" style:family="text">
   <style:text-properties style:font-name="Monospace1" fo:font-weight="bold" style:font-weight-asian="bold"/>
  </style:style>
  <style:style style:name="fr1" style:family="graphic" style:parent-style-name="Frame">
   <style:graphic-properties style:vertical-pos="middle" style:vertical-rel="page-content" style:horizontal-pos="center" style:horizontal-rel="page" fo:padding="0in" fo:border="none" style:shadow="none" draw:shadow-opacity="100%"/>
  </style:style>
  <style:style style:name="Sect1" style:family="section">
   <style:section-properties fo:background-color="transparent" style:editable="false">
    <style:columns fo:column-count="1" fo:column-gap="0in"/>
    <style:background-image/>
   </style:section-properties>
  </style:style>
  <style:style style:name="Sect2" style:family="section">
   <style:section-properties style:editable="false">
    <style:columns fo:column-count="1" fo:column-gap="0in"/>
   </style:section-properties>
  </style:style>
  <style:page-layout style:name="pm1">
   <style:page-layout-properties fo:page-width="8.5in" fo:page-height="11in" style:num-format="1" style:print-orientation="portrait" fo:margin-top="0.7874in" fo:margin-bottom="0.7874in" fo:margin-left="0.7874in" fo:margin-right="0.7874in" style:writing-mode="lr-tb" style:layout-grid-color="#c0c0c0" style:layout-grid-lines="44" style:layout-grid-base-height="0.2165in" style:layout-grid-ruby-height="0in" style:layout-grid-mode="none" style:layout-grid-ruby-below="false" style:layout-grid-print="true" style:layout-grid-display="true" style:layout-grid-base-width="0.1457in" style:layout-grid-snap-to="true" style:layout-grid-snap-to-characters="true" style:footnote-max-height="0in">
    <style:footnote-sep style:width="0.0071in" style:distance-before-sep="0.0398in" style:distance-after-sep="0.0398in" style:line-style="solid" style:adjustment="left" style:rel-width="25%" style:color="#000000"/>
   </style:page-layout-properties>
   <style:header-style/>
   <style:footer-style/>
  </style:page-layout>
 </office:automatic-styles>
 <office:master-styles>
  <style:master-page style:name="Standard" style:page-layout-name="pm1"/>
 </office:master-styles>
 <office:body>
  <office:text text:use-soft-page-breaks="true">
   <text:sequence-decls>
    <text:sequence-decl text:display-outline-level="0" text:name="Illustration"/>
    <text:sequence-decl text:display-outline-level="0" text:name="Table"/>
    <text:sequence-decl text:display-outline-level="0" text:name="Text"/>
    <text:sequence-decl text:display-outline-level="0" text:name="Drawing"/>
   </text:sequence-decls><draw:frame draw:style-name="fr1" draw:name="Frame1" text:anchor-type="page" text:anchor-page-number="1" svg:width="4.0902in" draw:z-index="0">
    <draw:text-box fo:min-height="1.2689in">
     <text:p text:style-name="P84"><text:bookmark-start text:name="__RefHeading__19255_308272890"/>C++ for embedded systems<text:bookmark-end text:name="__RefHeading__19255_308272890"/></text:p>
    </draw:text-box>
   </draw:frame>
   <text:p text:style-name="P84"/>
   <text:p text:style-name="P78"><text:bookmark-start text:name="__RefHeading__2311_977618933"/><text:bookmark-end text:name="__RefHeading__2311_977618933"/></text:p>
   <text:table-of-content text:style-name="Sect1" text:protected="true" text:name="Table of Contents1">
    <text:table-of-content-source text:outline-level="2">
     <text:index-title-template text:style-name="Contents_20_Heading">Table of Contents</text:index-title-template>
     <text:table-of-content-entry-template text:outline-level="1" text:style-name="Contents_20_1">
      <text:index-entry-link-start text:style-name="Index_20_Link"/>
      <text:index-entry-chapter/>
      <text:index-entry-text/>
      <text:index-entry-tab-stop style:type="left" style:position="0in" style:leader-char=" "/>
      <text:index-entry-tab-stop style:type="left" style:position="2in" style:leader-char=" "/>
      <text:index-entry-page-number/>
      <text:index-entry-link-end/>
     </text:table-of-content-entry-template>
     <text:table-of-content-entry-template text:outline-level="2" text:style-name="Contents_20_2">
      <text:index-entry-link-start text:style-name="Index_20_Link"/>
      <text:index-entry-chapter/>
      <text:index-entry-text/>
      <text:index-entry-tab-stop style:type="left" style:position="0in" style:leader-char=" "/>
      <text:index-entry-tab-stop style:type="left" style:position="2in" style:leader-char=" "/>
      <text:index-entry-page-number/>
      <text:index-entry-link-end/>
     </text:table-of-content-entry-template>
     <text:table-of-content-entry-template text:outline-level="3" text:style-name="Contents_20_3">
      <text:index-entry-link-start text:style-name="Index_20_Link"/>
      <text:index-entry-chapter/>
      <text:index-entry-text/>
      <text:index-entry-tab-stop style:type="left" style:position="0in" style:leader-char=" "/>
      <text:index-entry-tab-stop style:type="left" style:position="2in" style:leader-char=" "/>
      <text:index-entry-page-number/>
      <text:index-entry-link-end/>
     </text:table-of-content-entry-template>
     <text:table-of-content-entry-template text:outline-level="4" text:style-name="Contents_20_4">
      <text:index-entry-link-start text:style-name="Index_20_Link"/>
      <text:index-entry-chapter/>
      <text:index-entry-text/>
      <text:index-entry-tab-stop style:type="left" style:position="0in" style:leader-char=" "/>
      <text:index-entry-tab-stop style:type="left" style:position="2in" style:leader-char=" "/>
      <text:index-entry-page-number/>
      <text:index-entry-link-end/>
     </text:table-of-content-entry-template>
     <text:table-of-content-entry-template text:outline-level="5" text:style-name="Contents_20_5">
      <text:index-entry-link-start text:style-name="Index_20_Link"/>
      <text:index-entry-chapter/>
      <text:index-entry-text/>
      <text:index-entry-tab-stop style:type="left" style:position="0in" style:leader-char=" "/>
      <text:index-entry-tab-stop style:type="left" style:position="2in" style:leader-char=" "/>
      <text:index-entry-page-number/>
      <text:index-entry-link-end/>
     </text:table-of-content-entry-template>
     <text:table-of-content-entry-template text:outline-level="6" text:style-name="Contents_20_6">
      <text:index-entry-link-start text:style-name="Index_20_Link"/>
      <text:index-entry-chapter/>
      <text:index-entry-text/>
      <text:index-entry-tab-stop style:type="left" style:position="0in" style:leader-char=" "/>
      <text:index-entry-tab-stop style:type="left" style:position="2in" style:leader-char=" "/>
      <text:index-entry-page-number/>
      <text:index-entry-link-end/>
     </text:table-of-content-entry-template>
     <text:table-of-content-entry-template text:outline-level="7" text:style-name="Contents_20_7">
      <text:index-entry-link-start text:style-name="Index_20_Link"/>
      <text:index-entry-chapter/>
      <text:index-entry-text/>
      <text:index-entry-tab-stop style:type="left" style:position="0in" style:leader-char=" "/>
      <text:index-entry-tab-stop style:type="left" style:position="2in" style:leader-char=" "/>
      <text:index-entry-page-number/>
      <text:index-entry-link-end/>
     </text:table-of-content-entry-template>
     <text:table-of-content-entry-template text:outline-level="8" text:style-name="Contents_20_8">
      <text:index-entry-link-start text:style-name="Index_20_Link"/>
      <text:index-entry-chapter/>
      <text:index-entry-text/>
      <text:index-entry-tab-stop style:type="left" style:position="0in" style:leader-char=" "/>
      <text:index-entry-tab-stop style:type="left" style:position="2in" style:leader-char=" "/>
      <text:index-entry-page-number/>
      <text:index-entry-link-end/>
     </text:table-of-content-entry-template>
     <text:table-of-content-entry-template text:outline-level="9" text:style-name="Contents_20_9">
      <text:index-entry-link-start text:style-name="Index_20_Link"/>
      <text:index-entry-chapter/>
      <text:index-entry-text/>
      <text:index-entry-tab-stop style:type="left" style:position="0in" style:leader-char=" "/>
      <text:index-entry-tab-stop style:type="left" style:position="2in" style:leader-char=" "/>
      <text:index-entry-page-number/>
      <text:index-entry-link-end/>
     </text:table-of-content-entry-template>
     <text:table-of-content-entry-template text:outline-level="10" text:style-name="Contents_20_10">
      <text:index-entry-link-start text:style-name="Index_20_Link"/>
      <text:index-entry-chapter/>
      <text:index-entry-text/>
      <text:index-entry-tab-stop style:type="left" style:position="0in" style:leader-char=" "/>
      <text:index-entry-tab-stop style:type="left" style:position="2in" style:leader-char=" "/>
      <text:index-entry-page-number/>
      <text:index-entry-link-end/>
     </text:table-of-content-entry-template>
    </text:table-of-content-source>
    <text:index-body>
     <text:index-title text:style-name="Sect2" text:name="Table of Contents1_Head">
      <text:p text:style-name="Contents_20_Heading">Table of Contents</text:p>
     </text:index-title>
     <text:p text:style-name="P121"><text:a xlink:type="simple" xlink:href="#__RefHeading__2313_977618933" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">Introduction.<text:tab/><text:tab/>3</text:a></text:p>
     <text:p text:style-name="P121"><text:a xlink:type="simple" xlink:href="#__RefHeading__13919_1660174531" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">C++ code style.<text:tab/><text:tab/>4</text:a></text:p>
     <text:p text:style-name="P121"><text:a xlink:type="simple" xlink:href="#__RefHeading__2315_977618933" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">Software primitives.<text:tab/><text:tab/>4</text:a></text:p>
     <text:p text:style-name="P120"><text:a xlink:type="simple" xlink:href="#__RefHeading__10716_42486590" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">Mutual exclusion.<text:tab/><text:tab/>4</text:a></text:p>
     <text:p text:style-name="P120"><text:a xlink:type="simple" xlink:href="#__RefHeading__14882_1513893511" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">Parallel execution.<text:tab/><text:tab/>13</text:a></text:p>
     <text:p text:style-name="P120"><text:a xlink:type="simple" xlink:href="#__RefHeading__2317_977618933" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">Containers.<text:tab/><text:tab/>18</text:a></text:p>
     <text:p text:style-name="P120"><text:a xlink:type="simple" xlink:href="#__RefHeading__2646_977618933" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">C++ templates.<text:tab/><text:tab/>37</text:a></text:p>
     <text:p text:style-name="P120"><text:a xlink:type="simple" xlink:href="#__RefHeading__2948_1515059145" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">Memory management.<text:tab/><text:tab/>46</text:a></text:p>
     <text:p text:style-name="P120"><text:a xlink:type="simple" xlink:href="#__RefHeading__12039_1005710029" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">Operator new.<text:tab/><text:tab/>70</text:a></text:p>
     <text:p text:style-name="P121"><text:a xlink:type="simple" xlink:href="#__RefHeading__12421_1005710029" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">I/O access.<text:tab/><text:tab/>73</text:a></text:p>
     <text:p text:style-name="P120"><text:a xlink:type="simple" xlink:href="#__RefHeading__8080_1329019087" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">I/O access in C.<text:tab/><text:tab/>75</text:a></text:p>
     <text:p text:style-name="P120"><text:a xlink:type="simple" xlink:href="#__RefHeading__8082_1329019087" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">I/O access in C++.<text:tab/><text:tab/>83</text:a></text:p>
     <text:p text:style-name="P120"><text:a xlink:type="simple" xlink:href="#__RefHeading__11237_696237465" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">Indirect I/O access.<text:tab/><text:tab/>95</text:a></text:p>
     <text:p text:style-name="P121"><text:a xlink:type="simple" xlink:href="#__RefHeading__7726_2007975351" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">Code ROM and data RAM.<text:tab/><text:tab/>99</text:a></text:p>
     <text:p text:style-name="P120"><text:a xlink:type="simple" xlink:href="#__RefHeading__7728_2007975351" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">C++ Initialized data.<text:tab/><text:tab/>100</text:a></text:p>
     <text:p text:style-name="P120"><text:a xlink:type="simple" xlink:href="#__RefHeading__7954_2007975351" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">ROM patching.<text:tab/><text:tab/>102</text:a></text:p>
     <text:p text:style-name="P121"><text:a xlink:type="simple" xlink:href="#__RefHeading__12357_1195782936" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">Operating system.<text:tab/><text:tab/>105</text:a></text:p>
     <text:p text:style-name="P120"><text:a xlink:type="simple" xlink:href="#__RefHeading__13575_1195782936" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">Static (class) member.<text:tab/><text:tab/>106</text:a></text:p>
     <text:p text:style-name="P120"><text:a xlink:type="simple" xlink:href="#__RefHeading__13577_1195782936" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">Non static member.<text:tab/><text:tab/>115</text:a></text:p>
     <text:p text:style-name="P120"><text:a xlink:type="simple" xlink:href="#__RefHeading__16996_386140696" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">Interprocess communication.<text:tab/><text:tab/>118</text:a></text:p>
     <text:p text:style-name="P120"><text:a xlink:type="simple" xlink:href="#__RefHeading__14433_1195782936" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">Log.<text:tab/><text:tab/>129</text:a></text:p>
     <text:p text:style-name="P120"><text:a xlink:type="simple" xlink:href="#__RefHeading__14278_363426044" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">Software Timers.<text:tab/><text:tab/>150</text:a></text:p>
     <text:p text:style-name="P121"><text:a xlink:type="simple" xlink:href="#__RefHeading__12016_732733800" text:style-name="Index_20_Link" text:visited-style-name="Index_20_Link">Conclusion.<text:tab/><text:tab/>177</text:a></text:p>
    </text:index-body>
   </text:table-of-content>
   <text:h text:style-name="P110" text:outline-level="1"/>
   <text:h text:style-name="P67" text:outline-level="1"><text:bookmark-start text:name="__RefHeading__2313_977618933"/>Introduction.<text:bookmark-end text:name="__RefHeading__2313_977618933"/></text:h>
   <text:p text:style-name="Quotations">I&apos;ve come to the conclusion that any programmer that would prefer the project to be in C++ over C is likely a programmer that I really would prefer to piss off, so that he doesn&apos;t come and screw up any project I&apos;m involved with.</text:p>
   <text:p text:style-name="P46">Linus Torvalds</text:p>
   <text:p text:style-name="Quotations"/>
   <text:p text:style-name="Text_20_body">This book is intended for firmware developers who mainly use <text:span text:style-name="T84">the </text:span>C language. I assume that the reader is comfortable with ARM or Intel assembly language and has working knowledge of the C++ syntax. In this book, I <text:span text:style-name="T84">have tried</text:span> to give examples of C++ code in situations where, arguably, C is not <text:span text:style-name="T84">the</text:span> perfect tool for the task. Many C++ code examples come with snippets of the resulting assembly. The examples of code <text:span text:style-name="T84">have been</text:span> constructed in a way that allows immediate reuse in real‑world applications. Examples cover topics <text:span text:style-name="T84">such as</text:span> memory and speed optimization, organizing arrays, FIFOs, thread safety, <text:span text:style-name="T84">and</text:span> direct access to the hardware. The book addresses issues <text:span text:style-name="T84">such as</text:span> code bloat and <text:span text:style-name="T84">the </text:span>hidden performance costs of C++. </text:p>
   <text:p text:style-name="Text_20_body">In all examples I assume that the C++ compiler supports version 11 of the language. One example of such <text:span text:style-name="T84">a </text:span>compiler is GNUC 4.8. <text:span text:style-name="T84">The a</text:span>vailability of <text:span text:style-name="T84">a </text:span>C++ compiler supporting version 11 for specific hardware is not required, and most code examples can be rewritten for older C++ compilers. Through<text:span text:style-name="T84">out</text:span> the book, I <text:span text:style-name="T84">have </text:span>demonstrate<text:span text:style-name="T84">d</text:span> <text:span text:style-name="T84">some of the </text:span>less<text:span text:style-name="T84">er</text:span> known features of the C++11 standard, <text:span text:style-name="T84">such as</text:span> type traits, static assertion, constant expressions <text:span text:style-name="T84">and</text:span> <text:span text:style-name="T84">OpenMP support</text:span>.</text:p>
   <text:p text:style-name="Text_20_body"><text:span text:style-name="T84">P</text:span>roblem can be solved in <text:span text:style-name="T84">numerous</text:span> ways. Where it <text:span text:style-name="T84">wa</text:span>s possible and ma<text:span text:style-name="T84">de</text:span> sense, I provide<text:span text:style-name="T84">d</text:span> an alternative implementation in C and compare<text:span text:style-name="T84">d</text:span> <text:span text:style-name="T84">the </text:span>performance of <text:span text:style-name="T84">the </text:span>C and C++ solutions.</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:h text:style-name="P67" text:outline-level="1"><text:bookmark-start text:name="__RefHeading__13919_1660174531"/>C++ code style.<text:bookmark-end text:name="__RefHeading__13919_1660174531"/></text:h>
   <text:p text:style-name="Quotations">#define AND <text:s/>&amp;&amp; </text:p>
   <text:p text:style-name="Quotations">#define OR <text:s text:c="2"/>|| </text:p>
   <text:p text:style-name="Quotations">#define EQ <text:s text:c="2"/>==</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="Text_20_body">I <text:span text:style-name="T84">have done</text:span> my best to follow consistent C/C++ code style in all source code examples. In this book I <text:span text:style-name="T84">have not</text:span> plac<text:span text:style-name="T84">ed</text:span> curly brackets on a separate line. Please, do not send me hate mail. The only reason is to make the code snippets shorter. Shorter code has a better chance <text:span text:style-name="T84">of </text:span>fit<text:span text:style-name="T84">ting</text:span> <text:span text:style-name="T85">in </text:span>the smaller e‑reader displays. There are no comments in the code itself for the same reason. Hopefully, <text:span text:style-name="T84">the </text:span>lack of comments <text:span text:style-name="T84">has been</text:span> compensated <text:span text:style-name="T84">for </text:span>by the interspersed explanations. I am using <text:span text:style-name="T94">the </text:span>camelcase name convention. Types and class names <text:span text:style-name="T84">begin</text:span> with uppercase <text:span text:style-name="T84">and</text:span> variables <text:span text:style-name="T84">begin</text:span> with lower case, <text:span text:style-name="T84">while </text:span>constants are all upper case with the underscore delimiter. </text:p>
   <text:h text:style-name="Heading_20_1" text:outline-level="1"><text:bookmark-start text:name="__RefHeading__2315_977618933"/>Software primitives.<text:bookmark-end text:name="__RefHeading__2315_977618933"/></text:h>
   <text:h text:style-name="Heading_20_2" text:outline-level="2"><text:bookmark-start text:name="__RefHeading__10716_42486590"/>Mutual exclusion.<text:bookmark-end text:name="__RefHeading__10716_42486590"/></text:h>
   <text:p text:style-name="Quotations">The great thing about Object Oriented code is that it can make small, simple problems look like large, complex ones.</text:p>
   <text:p text:style-name="Quotations"/>
   <text:p text:style-name="Text_20_body">In the multi‑task environment, threads and interrupts can concurrently read and write data objects. I can use different tools to synchronize access to the data between different contexts and create thread safe APIs. Among <text:span text:style-name="T84">the </text:span>available tools are semaphores and mutual exclusion APIs provided by operating systems, <text:span text:style-name="T84">as well as </text:span>disabl<text:span text:style-name="T84">ing</text:span> all interrupts, disabl<text:span text:style-name="T84">ing</text:span> some interrupt<text:span text:style-name="T85">s</text:span>, disabl<text:span text:style-name="T84">ing the</text:span> operating system scheduler, <text:span text:style-name="T84">and using </text:span>spin locks. When I write a wrapper around an API provided by my real‑time operating system or by the hardware, I want the wrapper to be as thin as possible. Usually, I measure the overhead of the wrapper <text:span text:style-name="T84">using</text:span> a number of assembly instructions. <text:span text:style-name="T84">The n</text:span>umber of instructions provides a good approximation of the CPU cycles or execution time. </text:p>
   <text:p text:style-name="Text_20_body">I am starting <text:span text:style-name="T84">with</text:span> a code snippet <text:span text:style-name="T84">that</text:span> creates and calls a dummy lock object.</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> LockDummy {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>LockDummy() {</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>cout &lt;&lt; </text:span><text:span text:style-name="T51">&quot;Locked context&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; endl;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>~LockDummy() {</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>cout &lt;&lt; </text:span><text:span text:style-name="T51">&quot;Lock is freed&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; endl;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text">};</text:p>
   <text:p text:style-name="P6"/>
   <text:p text:style-name="Text_20_body">In the following usage example the C++ specifier “auto” tells to the compiler to automatically supply the correct type – <text:span text:style-name="T84">the </text:span>C++11 compiler knows to deduct <text:span text:style-name="T84">certain </text:span>types of variables in some situations. For example, <text:span text:style-name="T84">the </text:span>C++ compiler can figure out the return type of the left side of an assignment or <text:span text:style-name="T84">the </text:span>return type of a function. </text:p>
   <text:p text:style-name="P96">In the function main() compiler will call <text:span text:style-name="T84">the </text:span>output function two times and will not add any other code. The lock is released – <text:span text:style-name="T84">the </text:span>destructor ~LockDummy gets called – when the scope of the variable myDummyLock ends. The scope could be a while loop. I do not have to call “unlock” before each and every return from the function. <text:span text:style-name="T84">The </text:span>C++ compiler makes sure that the destructor is always called and called exactly once. This convenient service comes without any performance overhead. <text:span text:style-name="T84">The o</text:span>utput of the following code is going to be </text:p>
   <text:p text:style-name="Preformatted_20_Text">Locked context </text:p>
   <text:p text:style-name="Preformatted_20_Text">Protected context </text:p>
   <text:p text:style-name="Preformatted_20_Text">Lock is freed </text:p>
   <text:p text:style-name="P1"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">testDummyLock</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#if</text:span><text:span text:style-name="T18"> (__cplusplus &gt;= 201103) </text:span><text:span text:style-name="T2">// use &quot;auto&quot; if C++11 or better</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">auto</text:span><text:span text:style-name="T18"> myDummyLock = </text:span><text:span text:style-name="T41">LockDummySimple</text:span><text:span text:style-name="T18">();</text:span></text:p>
   <text:p text:style-name="P20">#else</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>LockDummySimple myDummyLock = LockDummySimple();</text:p>
   <text:p text:style-name="P20">#endif</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>cout &lt;&lt; </text:span><text:span text:style-name="T51">&quot;Protected context&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> 0;</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="P96">I want to stress this idea <text:span text:style-name="T84">using</text:span> another example. In the following code, I set a scope around the declaration of the lock variable. <text:span text:style-name="T90">The o</text:span>utput of the code is going to be </text:p>
   <text:p text:style-name="Preformatted_20_Text">Locked context </text:p>
   <text:p text:style-name="Preformatted_20_Text">Protected context </text:p>
   <text:p text:style-name="Preformatted_20_Text">Lock is freed </text:p>
   <text:p text:style-name="P36">End of main</text:p>
   <text:p text:style-name="P1"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> main() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>{</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="8"/>LockDummy <text:span text:style-name="T90">lock</text:span>;</text:p>
   <text:p text:style-name="P35"><text:span text:style-name="T18"><text:s text:c="8"/>cout &lt;&lt; </text:span><text:span text:style-name="T51">&quot;Protected context&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P35"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>cout &lt;&lt; </text:span><text:span text:style-name="T51">&quot;End of main&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; endl;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> 0;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Text_20_body">My second lock is a more realistic one, <text:span text:style-name="T85">and</text:span> <text:span text:style-name="T84">it</text:span> disables a hardware interrupt. I assume that there is an API <text:span text:style-name="T84">that</text:span> disables and enables an interrupt. I am refactoring the original lock code a little bit. First of all, I use a template, <text:span text:style-name="T84">which is </text:span>a feature of C++ that allows <text:span text:style-name="T84">you </text:span>to declare a class <text:span text:style-name="T84">that</text:span> operates with generic types. I am going to reuse the code in the template Lock for different synchronization objects. <text:span text:style-name="T84">The c</text:span>ode in the template Lock can manipulate any structure or class <text:span text:style-name="T84">that</text:span> implements two public methods: static methods get() and release(). I carefully avoid polymorphism here, I do not require synchronization objects to belong to the same hierarchy of classes. <text:span text:style-name="T84">The w</text:span>rapper around <text:span text:style-name="T84">the </text:span>disable/enable interrupts API, <text:span text:style-name="T84">which </text:span>likely writes to the hardware, is not going to be a child/friend/parent/relative/derivation of a wrapper for the operating system semaphore. </text:p>
   <text:p text:style-name="Text_20_body">This is <text:span text:style-name="T84">what</text:span> the API <text:span text:style-name="T84">that</text:span> disables and enables interrupts looks like:</text:p>
   <text:p text:style-name="P1"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">interruptDisable</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18">) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>cout &lt;&lt; </text:span><text:span text:style-name="T51">&quot;Disable&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">interruptEnable</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18">) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>cout &lt;&lt; </text:span><text:span text:style-name="T51">&quot;Enable&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Text_20_body">I am describing a synchronization object. The class implements two methods: “get” and “release”. Both methods are “inline”, which helps the optimizer to decide if calls to the methods should be substituted by the methods code. The end result is going to be similar to using a macro definition in C. <text:span text:style-name="T84">The d</text:span>efault constructor in the class SynchroObject is private, I do not want any objects of this type in the application. My C++ compiler so far <text:span text:style-name="T84">has</text:span> not add<text:span text:style-name="T84">ed</text:span> any object code to my executable file.</text:p>
   <text:p text:style-name="P1"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">SynchroObject</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">SynchroObject</text:span><text:span text:style-name="T18">() {};</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">get</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="8"/>interruptDisable();</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">release</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="8"/>interruptEnable();</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text">};</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P58"><text:span text:style-name="T84">The t</text:span>emplate class Lock can manipulate any type of synchronization objects <text:span text:style-name="T84">that</text:span> provide<text:span text:style-name="T85">s</text:span> <text:span text:style-name="T84">a </text:span>get/release API. All methods of the template class Lock are “inline”. <text:span text:style-name="T84">The </text:span>C++ compiler is not going to add any functions to the object code, but will <text:span text:style-name="T84">rather </text:span>replace <text:span text:style-name="T87">the </text:span>calls to the Lock methods <text:span text:style-name="T84">with</text:span> the code of <text:span text:style-name="T84">the </text:span>get/release from the synchronization object. </text:p>
   <text:p text:style-name="P1"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Mutex</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Lock</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">Lock</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T56">Mutex</text:span><text:span text:style-name="T18">::get();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">~Lock</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T56">Mutex</text:span><text:span text:style-name="T18">::release();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text">};</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="Text_20_body">Declare a new type MyLock <text:span text:style-name="T85">that</text:span> uses my SynchroObject to disable/enable interrupts. <text:span text:style-name="T85">There is s</text:span>till no additional data or code in my executable <text:span text:style-name="T85">except for the</text:span> calls to the interrupt enable and interrupt disable API.</text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T5">typedef</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Lock</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T41">SynchroObject</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T41">MyLock</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P6"/>
   <text:p text:style-name="Text_20_body">Output of <text:span text:style-name="T85">the function </text:span>main() is going to be two words: Disable, Enable</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">main</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>{</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">MyLock </text:span><text:span text:style-name="T43">lock</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> 0;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Text_20_body">Overhead of the wrapper around the functions <text:span text:style-name="T85">that</text:span> disable and enable interrupts is exactly zero. Indeed, <text:s/>if I check the disassembly, I will see two calls to the print function in the main routine and nothing else. I <text:span text:style-name="T85">have written</text:span> some C++ code which gets optimized to nothing. What did I gain? What is an added value? </text:p>
   <text:p text:style-name="Text_20_body">The code does not allow me to <text:span text:style-name="T94">leave</text:span> <text:span text:style-name="T94">out </text:span>enable interrupts after I called disable interrupt. No matter how many return points or breaks out of a loop my function has, <text:span text:style-name="T85">the </text:span>C++ compiler ensures that the function interruptEnable is called exactly once.</text:p>
   <text:h text:style-name="P70" text:outline-level="2"><text:bookmark-start text:name="__RefHeading__14882_1513893511"/>Parallel execution.<text:bookmark-end text:name="__RefHeading__14882_1513893511"/></text:h>
   <text:p text:style-name="P47">Some people, when confronted with a problem, think, &apos;I know, I&apos;ll use threads&apos; – and then two they hav erpoblems.</text:p>
   <text:p text:style-name="P47"/>
   <text:p text:style-name="P87">I have a quad core <text:span text:style-name="T84">CPU in my </text:span>system. <text:span text:style-name="T85">Compiler GCC 4.8 is available for my hardware. If I compile the code below with the compilation flag -fopenmp I will get the output “4”:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">testReduction</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18">) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> a = 0;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">#pragma</text:span><text:span text:style-name="T18"> omp parallel reduction (+:a)</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>{</text:p>
   <text:p text:style-name="P22"><text:s text:c="6"/>a = 1;</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>cout &lt;&lt; a &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="P89">Without <text:span text:style-name="T84">the </text:span>flag -fopenmp the output will be “1”. When <text:span text:style-name="T85">the C++ compiler</text:span> encounters pragma “omp parallel”, <text:span text:style-name="T85">it</text:span> adds <text:span text:style-name="T85">a chunk of </text:span>code which spawns a “team” of threads <text:span text:style-name="T86">(in Linux POSIX pthreads) </text:span>according to the number of cores in the system. <text:span text:style-name="T85">T</text:span>he following section is executed by <text:span text:style-name="T84">the group of</text:span> threads in parallel. </text:p>
   <text:p text:style-name="P92"/>
   <text:p text:style-name="P63">Execution of the following function on my system <text:span text:style-name="T86">requires</text:span> ~0.<text:span text:style-name="T86">179</text:span>s with OpenMP and ~0.<text:span text:style-name="T86">322</text:span>s without OpenMP:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">volatile</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint_fast8_t</text:span><text:span text:style-name="T18"> myArray[(</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18">)</text:span><text:span text:style-name="T20">512</text:span><text:span text:style-name="T18">*1024*1024];</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T41">uint_fast32_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">testOpenMPLoop</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">uint_fast32_t</text:span><text:span text:style-name="T18"> sum = 0;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">#pragma</text:span><text:span text:style-name="T18"> omp parallel </text:span><text:span text:style-name="T5">for</text:span><text:span text:style-name="T18"> reduction(+:sum)</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">for</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T41">uint64_t</text:span><text:span text:style-name="T18"> i=0; i &lt; </text:span><text:span text:style-name="T5">sizeof</text:span><text:span text:style-name="T18">(myArray); i++)</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>{</text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>sum += myArray[i];</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> sum;</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="P93">If the array size is under 10M entries the OpenMP overhead kicks in and the multi‑thread version of the loop requires more time than the single thread version. OpenMP implementation in the GCC compiler, GOMP library, calls malloc() from the C standard library to allocate pthread threads.</text:p>
   <text:p text:style-name="P90">My next synchronization object is based on the OpenMP lock.</text:p>
   <text:p text:style-name="P90"/>
   <text:p text:style-name="P61"><text:span text:style-name="T84">I restrict the instantiation of the class to one object. There is going to be only one instance of the class </text:span>SynchroObjectOmpLock<text:span text:style-name="T84">. This design pattern is called “singleton”:</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">SynchroObjectOmpLock</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">get</text:span><text:span text:style-name="T18">();</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">release</text:span><text:span text:style-name="T18">();</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">~SynchroObjectOmpLock</text:span><text:span text:style-name="T18">();</text:span></text:p>
   <text:p text:style-name="P6"/>
   <text:p text:style-name="P1"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">omp_lock_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">lock</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">SynchroObjectOmpLock</text:span><text:span text:style-name="T18"> *</text:span><text:span text:style-name="T67">instance</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P9"/>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">SynchroObjectOmpLock</text:span><text:span text:style-name="T18">();</text:span></text:p>
   <text:p text:style-name="P9">};</text:p>
   <text:p text:style-name="P3"><text:span text:style-name="T41">SynchroObjectOmpLock</text:span><text:span text:style-name="T18"> *</text:span><text:span text:style-name="T67">SynchroObjectOmpLock::instance</text:span><text:span text:style-name="T18"> </text:span></text:p>
   <text:p text:style-name="P3"><text:span text:style-name="T18"><text:s text:c="4"/>= </text:span><text:span text:style-name="T5">new</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">SynchroObjectOmpLock</text:span><text:span text:style-name="T18">();</text:span></text:p>
   <text:p text:style-name="P22"/>
   <text:p text:style-name="P90"/>
   <text:p text:style-name="P60"><text:span text:style-name="T85">The r</text:span>est of <text:span text:style-name="T85">the </text:span>class methods:</text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">SynchroObjectOmpLock::get</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T55">omp_set_lock</text:span><text:span text:style-name="T18">(&amp;</text:span><text:span text:style-name="T67">instance</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">lock</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="P9">}</text:p>
   <text:p text:style-name="P6"/>
   <text:p text:style-name="P1"><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">SynchroObjectOmpLock::release</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T55">omp_unset_lock</text:span><text:span text:style-name="T18">(&amp;</text:span><text:span text:style-name="T67">instance</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">lock</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="P9">}</text:p>
   <text:p text:style-name="P6"/>
   <text:p text:style-name="P1"><text:span text:style-name="T22">SynchroObjectOmpLock::SynchroObjectOmpLock</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T55">omp_init_lock</text:span><text:span text:style-name="T18">(&amp;</text:span><text:span text:style-name="T66">lock</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="P9">}</text:p>
   <text:p text:style-name="P6"/>
   <text:p text:style-name="P1"><text:span text:style-name="T22">SynchroObjectOmpLock::~SynchroObjectOmpLock</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T55">omp_destroy_lock</text:span><text:span text:style-name="T18">(&amp;</text:span><text:span text:style-name="T67">instance</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">lock</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="P9">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">I have a new type – a lock <text:span text:style-name="T85">which is </text:span>based on the <text:span text:style-name="T85">OpenMP </text:span>synchronization object:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">typedef</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Lock</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T41">SynchroObjectOmpLock</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T41">LockOmp</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P90">And usage example:</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>{</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">LockOmp </text:span><text:span text:style-name="T44">lock</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P92"/>
   <text:h text:style-name="P68" text:outline-level="2"><text:bookmark-start text:name="__RefHeading__2317_977618933"/>Containers.<text:bookmark-end text:name="__RefHeading__2317_977618933"/></text:h>
   <text:p text:style-name="Quotations">When your hammer is C++, everything begins to look like a thumb.</text:p>
   <text:p text:style-name="P45"/>
   <text:p text:style-name="P91">Standard template library (STL) contains a lot of smart and <text:span text:style-name="T85">very </text:span>convenient code dealing with vectors, stacks, queues, hash tables, trees, and many other types of dynamic and static data storage. Unfortunately, a firmware developer <text:span text:style-name="T85">often </text:span>needs something different. <text:span text:style-name="T85">There are </text:span>cases <text:span text:style-name="T85">when </text:span>high performance and small code/data footprint should coexist in one application. In this chapter I will demonstrate a container which makes sense in an embedded <text:span text:style-name="T85">system</text:span> with limited resources. The API should be reentrant and allow safe concurrent access. The performance of the container is going to be at least not worse than a<text:span text:style-name="T85">n </text:span>alternative <text:span text:style-name="T85">implementation in the C language</text:span>. All <text:span text:style-name="T85">memory</text:span> allocations are going to be static and done at build time – I will deal with the dynamic allocation<text:span text:style-name="T85">s</text:span> later in this book. </text:p>
   <text:h text:style-name="P113" text:outline-level="2"/>
   <text:p text:style-name="P79"><text:bookmark-start text:name="__RefHeading__2535_977618933"/>Cyclic buffer.<text:bookmark-end text:name="__RefHeading__2535_977618933"/></text:p>
   <text:p text:style-name="P48">Asking from C++ programmers more content, less bloat is unfair.</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="Text_20_body">My first example is going to be a cyclic buffer, <text:span text:style-name="T87">which is</text:span> also known as a ring buffer. A “producer” adds objects to the “tail” of the cyclic buffer and a “consumer” pulls the objects from the “head” of the cyclic buffer. An example of producer can be an interrupt routine which gets characters from <text:span text:style-name="T85">the </text:span>UART device (<text:span text:style-name="T85">RS232</text:span> port). A “consumer” <text:span text:style-name="T85">is</text:span> a function called from the application main loop which handles commands arriving from the UART. <text:span text:style-name="T85">The </text:span>CyclicBuffer class is a template class, which should help the optimizer to generate the most efficient code possible for the given integer type and <text:span text:style-name="T85">the </text:span>CPU architecture.</text:p>
   <text:p text:style-name="P37"/>
   <text:p text:style-name="P72"><text:span text:style-name="T10">template</text:span><text:span text:style-name="T16">&lt;</text:span><text:span text:style-name="T10">typename</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T58">ObjectType</text:span><text:span text:style-name="T16">, </text:span><text:span text:style-name="T10">typename</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T58">Lock</text:span><text:span text:style-name="T16">, std::</text:span><text:span text:style-name="T39">size_t</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T58">Size</text:span><text:span text:style-name="T16">&gt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">CyclicBufferSimple</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">CyclicBufferSimple</text:span><text:span text:style-name="T18">();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">~CyclicBufferSimple</text:span><text:span text:style-name="T18">() {}</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">add</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> object);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">remove</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> &amp;object);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">isEmpty</text:span><text:span text:style-name="T18">();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">isFull</text:span><text:span text:style-name="T18">();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">private</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">increment</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> index);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">errorOverflow</text:span><text:span text:style-name="T18">() {}</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">errorUnderflow</text:span><text:span text:style-name="T18">() {}</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">data</text:span><text:span text:style-name="T18">[</text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18"> + 1];</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">};</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P59">The CyclicBufferSimple constructor will fail the build if the application attempts to store in the buffer anything but integer. Storage for the objects larger than <text:span text:style-name="T85">the </text:span>size of <text:span text:style-name="T85">the </text:span>integer on the given CPU architecture should probably have a different API. </text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P74"><text:span text:style-name="T13">template</text:span><text:span text:style-name="T34">&lt;</text:span><text:span text:style-name="T13">typename</text:span><text:span text:style-name="T34"> </text:span><text:span text:style-name="T61">ObjectType</text:span><text:span text:style-name="T34">, </text:span><text:span text:style-name="T13">typename</text:span><text:span text:style-name="T34"> </text:span><text:span text:style-name="T61">Lock</text:span><text:span text:style-name="T34">, std::</text:span><text:span text:style-name="T47">size_t</text:span><text:span text:style-name="T34"> </text:span><text:span text:style-name="T61">Size</text:span><text:span text:style-name="T34">&gt;</text:span></text:p>
   <text:p text:style-name="P30"><text:span text:style-name="T35">CyclicBufferSimple&lt;ObjectType, Lock, Size&gt;::CyclicBufferSimple</text:span><text:span text:style-name="T34">() {</text:span></text:p>
   <text:p text:style-name="P30"/>
   <text:p text:style-name="P30"><text:span text:style-name="T13">#if</text:span><text:span text:style-name="T34"> (__cplusplus &gt;= 201103)</text:span></text:p>
   <text:p text:style-name="P30"><text:span text:style-name="T34"><text:s text:c="4"/></text:span><text:span text:style-name="T13">static_assert</text:span><text:span text:style-name="T34">(std::</text:span><text:span text:style-name="T47">numeric_limits</text:span><text:span text:style-name="T34">&lt;</text:span><text:span text:style-name="T61">ObjectType</text:span><text:span text:style-name="T34">&gt;::</text:span><text:span text:style-name="T68">is_integer</text:span><text:span text:style-name="T34">, </text:span><text:span text:style-name="T54">&quot;CyclicBuffer is intended to work only with integer types&quot;</text:span><text:span text:style-name="T34">);</text:span></text:p>
   <text:p text:style-name="P30"><text:span text:style-name="T13">#elif</text:span><text:span text:style-name="T34"> defined(__GNUC____)</text:span></text:p>
   <text:p text:style-name="P30"><text:span text:style-name="T34"><text:s text:c="4"/></text:span><text:span text:style-name="T13">__attribute__</text:span><text:span text:style-name="T34">((unused)) ObjectType val1 = 1;</text:span></text:p>
   <text:p text:style-name="P30">#else</text:p>
   <text:p text:style-name="P30"><text:span text:style-name="T34"><text:s text:c="4"/></text:span><text:span text:style-name="T13">volatile</text:span><text:span text:style-name="T34"> ObjectType val1;</text:span></text:p>
   <text:p text:style-name="P30"><text:s text:c="4"/>*(&amp;val1) = 1;</text:p>
   <text:p text:style-name="P30">#endif</text:p>
   <text:p text:style-name="P30"><text:span text:style-name="T34"><text:s text:c="4"/></text:span><text:span text:style-name="T13">this</text:span><text:span text:style-name="T34">-&gt;</text:span><text:span text:style-name="T68">head</text:span><text:span text:style-name="T34"> = 0;</text:span></text:p>
   <text:p text:style-name="P30"><text:span text:style-name="T34"><text:s text:c="4"/></text:span><text:span text:style-name="T13">this</text:span><text:span text:style-name="T34">-&gt;</text:span><text:span text:style-name="T68">tail</text:span><text:span text:style-name="T34"> = 0;</text:span></text:p>
   <text:p text:style-name="P30">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">There are two methods return<text:span text:style-name="T85">ing</text:span> the buffer <text:span text:style-name="T88">state:</text:span></text:p>
   <text:p text:style-name="P31"><text:span text:style-name="T10">template</text:span><text:span text:style-name="T16">&lt;</text:span><text:span text:style-name="T10">typename</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T58">ObjectType</text:span><text:span text:style-name="T16">, </text:span><text:span text:style-name="T10">typename</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T58">Lock</text:span><text:span text:style-name="T16">, std::</text:span><text:span text:style-name="T39">size_t</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T58">Size</text:span><text:span text:style-name="T16">&gt;</text:span></text:p>
   <text:p text:style-name="P31"><text:span text:style-name="T10">inline</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T10">bool</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T28">CyclicBufferSimple&lt;ObjectType, Lock, Size&gt;::isEmpty</text:span><text:span text:style-name="T16">() {</text:span></text:p>
   <text:p text:style-name="P31"><text:span text:style-name="T16"><text:s text:c="4"/></text:span><text:span text:style-name="T10">bool</text:span><text:span text:style-name="T16"> res = (</text:span><text:span text:style-name="T10">this</text:span><text:span text:style-name="T16">-&gt;</text:span><text:span text:style-name="T64">head</text:span><text:span text:style-name="T16"> == </text:span><text:span text:style-name="T10">this</text:span><text:span text:style-name="T16">-&gt;</text:span><text:span text:style-name="T64">tail</text:span><text:span text:style-name="T16">);</text:span></text:p>
   <text:p text:style-name="P31"><text:span text:style-name="T16"><text:s text:c="4"/></text:span><text:span text:style-name="T10">return</text:span><text:span text:style-name="T16"> res;</text:span></text:p>
   <text:p text:style-name="P31">}</text:p>
   <text:p text:style-name="P31"/>
   <text:p text:style-name="P31"><text:span text:style-name="T10">template</text:span><text:span text:style-name="T16">&lt;</text:span><text:span text:style-name="T10">typename</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T58">ObjectType</text:span><text:span text:style-name="T16">, </text:span><text:span text:style-name="T10">typename</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T58">Lock</text:span><text:span text:style-name="T16">, std::</text:span><text:span text:style-name="T39">size_t</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T58">Size</text:span><text:span text:style-name="T16">&gt;</text:span></text:p>
   <text:p text:style-name="P31"><text:span text:style-name="T10">inline</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T10">bool</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T28">CyclicBufferSimple&lt;ObjectType, Lock, Size&gt;::isFull</text:span><text:span text:style-name="T16">() {</text:span></text:p>
   <text:p text:style-name="P31"><text:span text:style-name="T16"><text:s text:c="4"/></text:span><text:span text:style-name="T39">size_t</text:span><text:span text:style-name="T16"> tail = increment(</text:span><text:span text:style-name="T10">this</text:span><text:span text:style-name="T16">-&gt;</text:span><text:span text:style-name="T64">tail</text:span><text:span text:style-name="T16">);</text:span></text:p>
   <text:p text:style-name="P31"><text:span text:style-name="T16"><text:s text:c="4"/></text:span><text:span text:style-name="T10">bool</text:span><text:span text:style-name="T16"> res = (</text:span><text:span text:style-name="T10">this</text:span><text:span text:style-name="T16">-&gt;</text:span><text:span text:style-name="T64">head</text:span><text:span text:style-name="T16"> == tail);</text:span></text:p>
   <text:p text:style-name="P31"><text:span text:style-name="T16"><text:s text:c="4"/></text:span><text:span text:style-name="T10">return</text:span><text:span text:style-name="T16"> res;</text:span></text:p>
   <text:p text:style-name="P31">}</text:p>
   <text:p text:style-name="P86"/>
   <text:p text:style-name="P58">A method handl<text:span text:style-name="T85">ing</text:span> wrap around of the buffer index:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">, std::</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">&gt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">CyclicBufferSimple&lt;ObjectType, Lock, Size&gt;::increment</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> index) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (index &lt; </text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> (index + 1);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>} </text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> 0;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Add/remove API of the cyclic buffer:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">, std::</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">&gt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">CyclicBufferSimple&lt;ObjectType, Lock, Size&gt;::add</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> object) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T56">Lock </text:span><text:span text:style-name="T21">lock</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (!isFull()) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">data</text:span><text:span text:style-name="T18">[</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18">] = object;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18"> = increment(</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">true</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>} </text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>errorOverflow();</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">false</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">, std::</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">&gt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">CyclicBufferSimple&lt;ObjectType, Lock, Size&gt;::remove</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> &amp;object) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T21">lock</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (!isEmpty()) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>object = </text:span><text:span text:style-name="T66">data</text:span><text:span text:style-name="T18">[</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18">];</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18"> = </text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;increment(</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">true</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>} </text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>errorUnderflow();</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">false</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Instantiate a new type – <text:span text:style-name="T85">a </text:span>lock which does nothing:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">typedef</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Lock</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T41">SynchroObjectDummy</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T41">LockDummy</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Text_20_body">Following function returns a number of <text:span text:style-name="T85">the </text:span>elements in the cyclic buffer. Compiler will fail if the value can not be calculated at the build time:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">constexpr</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">calculateCyclicBufferSize</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> 10;</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P94"><text:span text:style-name="T85">I c</text:span>reate an object of class CyclicBuffer deal<text:span text:style-name="T85">ing</text:span> with unsigned 8 bits integers. I use uint_fast8_t, <text:span text:style-name="T85">which is </text:span>yet another C++11 marvel targeting portability. <text:span text:style-name="T85">Type uint_fast8_t </text:span>allows the <text:span text:style-name="T85">C++ </text:span>compiler to choose best performing integer that has at least 8 bits. <text:span text:style-name="T85">O</text:span>perations with 32 bits integers <text:span text:style-name="T85">can</text:span> faster on <text:span text:style-name="T85">some</text:span> CPU<text:span text:style-name="T85">s than 8 bits operations</text:span>. If the performance is more important than memory allocated by the storage, it makes sense to choose 32 bits integer instead of 8 bits. The smallest possible 8 bits unsigned integer is uint_least8_t, and the maximum unsigned integer available on the platform is uintmax_t.</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">CyclicBufferSimple</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T41">uint_fast8_t</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T41">LockDummy</text:span><text:span text:style-name="T18">, calculateCyclicBufferSize()&gt; myCyclicBuffer;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">In the usage example there is a range loop from the C++11 standard. <text:span text:style-name="T85">The m</text:span>ain function will print numbers 1, 3, 11</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T9">int</text:span><text:span text:style-name="T72"> </text:span><text:span text:style-name="T73">main</text:span><text:span text:style-name="T72">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">for</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> i : { 1, 3, 11 }) {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>myCyclicBuffer.add(i);</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">uint8_t</text:span><text:span text:style-name="T18"> val;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">while</text:span><text:span text:style-name="T18"> (myCyclicBuffer.remove(val)) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>cout &lt;&lt; (</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18">) val &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> 0;</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Let&apos;s examine the assembly generated by the GNUC compiler for the Intel CPU for a single call to the method add(). </text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">xor</text:span><text:span text:style-name="T18"> %esi,%esi</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="2"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> add(</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> ObjectType object) {</text:span></text:p>
   <text:p text:style-name="P22">mov 0x2009c0(%rip),%rax</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="10"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> (index + 1);</text:span></text:p>
   <text:p text:style-name="P22">mov %rsi,%r8</text:p>
   <text:p text:style-name="P22">...............................................</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="2"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> add(</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> ObjectType object) {</text:span></text:p>
   <text:p text:style-name="P22">mov %rcx,%rdx</text:p>
   <text:p text:style-name="P22">cmovbe %rdi,%r8</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="6"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (!isFull()) {</text:span></text:p>
   <text:p text:style-name="P22">cmp %r8,%rax</text:p>
   <text:p text:style-name="P22">...............................................</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="10"/>data[</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;tail] = object;</text:span></text:p>
   <text:p text:style-name="P22">movb $0x0,0x6011a0(%rcx)</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="10"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> (index + 1);</text:span></text:p>
   <text:p text:style-name="P22">mov %r8,%rdx</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="10"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;tail = increment(</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;tail);</text:span></text:p>
   <text:p text:style-name="P22">mov %r8,0x2009a0(%rip)</text:p>
   <text:p text:style-name="P22"/>
   <text:p text:style-name="Text_20_body">I see a couple of move instructions <text:span text:style-name="T85">which </text:span>update the tail, update of the data in the cyclic buffer, a compar<text:span text:style-name="T85">ison</text:span> when the tail is incremented. There are 9 opcodes total. There is no unexpected overhead in this code. </text:p>
   <text:p text:style-name="Text_20_body">I coded one cyclic buffer implementation, but I gained four different cyclic buffers optimized for four different integer types, equally efficient when working with 8, 16, 32, 64 bits integers on different CPUs. Class CyclicBuffer encapsulates the data in the private region. <text:span text:style-name="T85">The private data is </text:span>accessible only via the class methods and this is <text:span text:style-name="T84">supposed to be </text:span>a good thing. </text:p>
   <text:h text:style-name="P113" text:outline-level="2"/>
   <text:p text:style-name="P79"><text:bookmark-start text:name="__RefHeading__2537_977618933"/>Cyclic buffer – C alternative.<text:bookmark-end text:name="__RefHeading__2537_977618933"/></text:p>
   <text:p text:style-name="Quotations">/**</text:p>
   <text:p text:style-name="Quotations"><text:s/>* Returns true</text:p>
   <text:p text:style-name="Quotations"><text:s/>*/</text:p>
   <text:p text:style-name="Quotations">int compare(int C)</text:p>
   <text:p text:style-name="Quotations">{</text:p>
   <text:p text:style-name="Quotations"><text:s text:c="4"/>return (C &gt; C++);</text:p>
   <text:p text:style-name="Quotations">}</text:p>
   <text:p text:style-name="Quotations"/>
   <text:p text:style-name="First_20_line_20_indent">The <text:span text:style-name="T85">following </text:span>C implementation of the cyclic buffer is type safe. <text:span text:style-name="T85">The </text:span>C implementation contains approximately the same number of source code lines: ~80 lines in C vs ~90 lines in C++.</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T9">#undef</text:span><text:span text:style-name="T72"> CYCLIC_BUFFRE_SIZE</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#define</text:span><text:span text:style-name="T18"> CYCLIC_BUFFRE_SIZE 10</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#undef</text:span><text:span text:style-name="T18"> CYCLIC_BUFFER_OBJECT_TYPE</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#define</text:span><text:span text:style-name="T18"> CYCLIC_BUFFER_OBJECT_TYPE uint8_t</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#define</text:span><text:span text:style-name="T18"> CYCLIC_BUFFRE_DECLARE(ObjectType, Size) \</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">typedef</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">struct</text:span><text:span text:style-name="T18"> { \</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>ObjectType data[Size+1]; \</text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>size_t head; \</text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>size_t tail; \</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>} CyclicBuffer;\</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P22">CYCLIC_BUFFRE_DECLARE(CYCLIC_BUFFER_OBJECT_TYPE, CYCLIC_BUFFRE_SIZE);</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T41">CyclicBuffer</text:span><text:span text:style-name="T18"> myCyclicBuffer;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">CyclicBufferIncrement</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> index, </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> size) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (index &lt; size) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> (index + 1);</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> 0;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">CyclicBufferIsEmpty</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">CyclicBuffer</text:span><text:span text:style-name="T18">* cyclicBuffer) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> res = (cyclicBuffer-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18"> == cyclicBuffer-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">CyclicBufferIsFull</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">CyclicBuffer</text:span><text:span text:style-name="T18">* cyclicBuffer) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> tail = CyclicBufferIncrement(cyclicBuffer-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18">, CYCLIC_BUFFRE_SIZE);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> res = (cyclicBuffer-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18"> == tail);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">errorOverflow</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">errorUnderflow</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">CyclicBufferAdd</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">CyclicBuffer</text:span><text:span text:style-name="T18">* cyclicBuffer, </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> CYCLIC_BUFFER_OBJECT_TYPE object) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (!CyclicBufferIsFull(cyclicBuffer)) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>cyclicBuffer-&gt;</text:span><text:span text:style-name="T66">data</text:span><text:span text:style-name="T18">[cyclicBuffer-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18">] = object;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>cyclicBuffer-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18"> = CyclicBufferIncrement(cyclicBuffer-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18">, CYCLIC_BUFFRE_SIZE);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">true</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>} </text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>errorOverflow();</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">false</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">CyclicBufferRemove</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">CyclicBuffer</text:span><text:span text:style-name="T18">* cyclicBuffer, CYCLIC_BUFFER_OBJECT_TYPE* object) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (!CyclicBufferIsEmpty(cyclicBuffer)) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>*object = cyclicBuffer-&gt;</text:span><text:span text:style-name="T66">data</text:span><text:span text:style-name="T18">[cyclicBuffer-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18">];</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>cyclicBuffer-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18"> = CyclicBufferIncrement(cyclicBuffer-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18">, CYCLIC_BUFFRE_SIZE);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">true</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>} </text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>errorUnderflow();</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">false</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Function main prints <text:span text:style-name="T85">digits</text:span> 0,1,2,3</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T9">int</text:span><text:span text:style-name="T72"> </text:span><text:span text:style-name="T73">main</text:span><text:span text:style-name="T72">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">for</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> i = 0;i &lt; 4;i++) {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>CyclicBufferAdd(&amp;myCyclicBuffer, i);</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">uint8_t</text:span><text:span text:style-name="T18"> val;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">while</text:span><text:span text:style-name="T18"> (CyclicBufferRemove(&amp;myCyclicBuffer, &amp;val)) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>cout &lt;&lt; (</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18">) val &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>};</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> 0;</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="P22"/>
   <text:p text:style-name="Text_20_body"><text:span text:style-name="T85">T</text:span>his code <text:span text:style-name="T85">has some limitations. O</text:span>nly cyclic buffers <text:span text:style-name="T85">manipulating</text:span> the same integer type can be <text:span text:style-name="T85">used</text:span> in the same C source file. Add/remove functions can be defined only once in a C file. </text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Corresponding assembly contains 10 opcodes for a call to add<text:span text:style-name="T85">()</text:span> API:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> (index + 1);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="2"/></text:span><text:span text:style-name="T5">xor</text:span><text:span text:style-name="T18"> %esi,%esi</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> CyclicBufferAdd(CyclicBuffer* cyclicBuffer, </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> CYCLIC_BUFFER_OBJECT_TYPE object) {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="2"/>mov 0x2009be(%rip),%rax <text:s text:c="7"/># 0x6011b0 &lt;myCyclicBuffer+16&gt;</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> (index + 1);</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="2"/>mov %rsi,%r8</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> main() {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="2"/>push %rbp</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> (index + 1);</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="2"/>lea 0x1(%rcx),%rdi</text:p>
   <text:p text:style-name="P22">...............................................</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> CyclicBufferAdd(CyclicBuffer* cyclicBuffer, </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> CYCLIC_BUFFER_OBJECT_TYPE object) {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="2"/>mov %rcx,%rdx</text:p>
   <text:p text:style-name="P22"><text:s text:c="2"/>push %rbx</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> (index + 1);</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="2"/>cmovbe %rdi,%r8</text:p>
   <text:p text:style-name="P22">...............................................</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (!CyclicBufferIsFull(cyclicBuffer)) {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="2"/>cmp %r8,%rax</text:p>
   <text:p text:style-name="P22">...............................................</text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>cyclicBuffer-&gt;data[cyclicBuffer-&gt;tail] = object;</text:p>
   <text:p text:style-name="P22"><text:s text:c="2"/>movb $0x0,0x6011a0(%rcx)</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">GNUC for ARM produces essentially the same assembly for <text:span text:style-name="T85">the </text:span>C and <text:span text:style-name="T85">the </text:span>C++ code</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">xor</text:span><text:span text:style-name="T18"> <text:s text:c="3"/>%esi,%esi</text:span></text:p>
   <text:p text:style-name="P22">mov <text:s text:c="3"/>0x2009be(%rip),%rax</text:p>
   <text:p text:style-name="P22">mov <text:s text:c="3"/>%rsi,%r8</text:p>
   <text:p text:style-name="P22">push <text:s text:c="2"/>%rbp</text:p>
   <text:p text:style-name="P22">lea <text:s text:c="3"/>0x1(%rdx),%rdi</text:p>
   <text:p text:style-name="P22">cmp <text:s text:c="3"/>$0x9,%rdx</text:p>
   <text:p text:style-name="P22">mov <text:s text:c="3"/>%rdx,%rcx</text:p>
   <text:p text:style-name="P22">push <text:s text:c="2"/>%rbx</text:p>
   <text:p text:style-name="P22">cmovbe %rdi,%r8</text:p>
   <text:p text:style-name="P22">cmp <text:s text:c="3"/>%r8,%rax</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18">je <text:s text:c="4"/></text:span><text:span text:style-name="T24">40081c</text:span><text:span text:style-name="T18"> &lt;main+0x3c&gt;</text:span></text:p>
   <text:p text:style-name="P22">movb <text:s text:c="2"/>$0x0,0x6011a0(%rdx)</text:p>
   <text:p text:style-name="P22">mov <text:s text:c="3"/>%r8,%rcx</text:p>
   <text:p text:style-name="P22">mov <text:s text:c="3"/>%r8,0x20099c(%rip)</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">xor</text:span><text:span text:style-name="T18"> <text:s text:c="3"/>%r12d,%r12d</text:span></text:p>
   <text:p text:style-name="Text_20_body">Performance of <text:span text:style-name="T85">the </text:span>C and <text:span text:style-name="T85">the </text:span>C++ versions measured on Intel is the same. </text:p>
   <text:h text:style-name="P113" text:outline-level="2"/>
   <text:h text:style-name="P68" text:outline-level="2"><text:bookmark-start text:name="__RefHeading__2646_977618933"/>C++ templates.<text:bookmark-end text:name="__RefHeading__2646_977618933"/></text:h>
   <text:p text:style-name="Quotations">To understand what recursion is, you must first understand recursion.</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="Text_20_body">At this point a patient reader would ask about “code bloat” caused by <text:span text:style-name="T85">the </text:span>C++ templates and object code duplication. Typically, an implementation in C should have a smaller memory footprint, should not it? </text:p>
   <text:p text:style-name="Text_20_body"><text:span text:style-name="T85">In </text:span>the <text:span text:style-name="T85">C++ implementation of the </text:span>cyclic buffer, all methods are inline and there is no any specific “template code”. In <text:span text:style-name="T85">the </text:span>general case, for every <text:span text:style-name="T85">pair</text:span> ObjectType/Size used in the code the C++ compiler is going to instantiate a class and add a full set of methods to the application code. A careful C++ programmer shall move the methods which do not require template arguments to a base class and derive the CyclicBuffer template from the new class. Moving type‑invariant code into a base class sometimes is called “code hoisting”. Code hoisting does not necessary cause a performance hit. I<text:span text:style-name="T85">n the following example I </text:span>call the base class CyclicBufferBase. Constructor of the base class is protected. <text:span text:style-name="T85">An application </text:span>can create <text:span text:style-name="T85">only objects of the child class</text:span>. </text:p>
   <text:p text:style-name="P28"/>
   <text:p text:style-name="P73"><text:span text:style-name="T9">class</text:span><text:span text:style-name="T17"> </text:span><text:span text:style-name="T40">CyclicBufferBase</text:span><text:span text:style-name="T17"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">isEmpty</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> res = (</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18"> == </text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">isFull</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> tail = increment(</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> res = (</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18"> == tail);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">CyclicBufferBase</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> size) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">size</text:span><text:span text:style-name="T18"> = size;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18"> = 0;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18"> = 0;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">errorOverflow</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">errorUnderflow</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">increment</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> index) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (index &lt; </text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">size</text:span><text:span text:style-name="T18">) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> (index + 1);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>} </text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> 0;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>}</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">size</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="P39"/>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58"><text:span text:style-name="T85">The t</text:span>emplate class CyclicBuffer <text:span text:style-name="T85">contains</text:span> data which depends on the template argument Size and add/remove methods which depend on the size of the integer. Class CyclicBuffer <text:span text:style-name="T85">is </text:span>derive<text:span text:style-name="T85">d</text:span> from <text:span text:style-name="T85">the </text:span>class CyclicBufferBase, inherits all methods of the class CyclicBufferBase, and exposes all methods of the class CyclicBufferBase.</text:p>
   <text:p text:style-name="P28"/>
   <text:p text:style-name="P73"><text:span text:style-name="T9">template</text:span><text:span text:style-name="T17">&lt;</text:span><text:span text:style-name="T9">typename</text:span><text:span text:style-name="T17"> </text:span><text:span text:style-name="T57">ObjectType</text:span><text:span text:style-name="T17">, </text:span><text:span text:style-name="T9">typename</text:span><text:span text:style-name="T17"> </text:span><text:span text:style-name="T57">Lock</text:span><text:span text:style-name="T17">, std::</text:span><text:span text:style-name="T40">size_t</text:span><text:span text:style-name="T17"> </text:span><text:span text:style-name="T57">Size</text:span><text:span text:style-name="T17">&gt; </text:span></text:p>
   <text:p text:style-name="P28"><text:span text:style-name="T9">class</text:span><text:span text:style-name="T17"> </text:span><text:span text:style-name="T40">CyclicBuffer</text:span><text:span text:style-name="T17">:</text:span><text:span text:style-name="T9">public</text:span><text:span text:style-name="T17"> </text:span><text:span text:style-name="T40">CyclicBufferBase</text:span><text:span text:style-name="T17"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">CyclicBuffer</text:span><text:span text:style-name="T18">() :</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>CyclicBufferBase(</text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">static_assert</text:span><text:span text:style-name="T18">(std::</text:span><text:span text:style-name="T41">numeric_limits</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">&gt;::</text:span><text:span text:style-name="T66">is_integer</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T51">&quot;CyclicBuffer is intended to work only with integer types&quot;</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">~CyclicBuffer</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">add</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> object) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T22"> </text:span><text:span text:style-name="T21">lock</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (!isFull()) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T66">data</text:span><text:span text:style-name="T18">[</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18">] = object;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18"> = increment(</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">true</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>} </text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="12"/>errorOverflow();</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">false</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">remove</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> &amp;object) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T21">lock</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (!isEmpty()) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/>object = </text:span><text:span text:style-name="T66">data</text:span><text:span text:style-name="T18">[</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18">];</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18"> = </text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;increment(</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">true</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>} </text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="12"/>errorUnderflow();</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">false</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>}</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">private</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">data</text:span><text:span text:style-name="T18">[</text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18"> + 1];</text:span></text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Where <text:span text:style-name="T85">a </text:span>C++ template cause<text:span text:style-name="T85">s</text:span> object code duplication <text:span text:style-name="T85">the </text:span>C code can lead to the source code and object code duplication. Analyzing of the object code generated by the C/C++ compiler <text:span text:style-name="T85">helps to </text:span>locat<text:span text:style-name="T85">e</text:span> <text:span text:style-name="T85">parst of the </text:span>code responsible for the object code duplication. For example, a post build utility can look for patterns in the object code which occur more than once, and use a map file to report the corresponding position in assembly. </text:p>
   <text:p text:style-name="Text_20_body">There is one use case for C++ templates which is rather hard to replicate in <text:span text:style-name="T85">the </text:span>plain vanilla C. It <text:span text:style-name="T85">i</text:span>s called template “metaprogramming”. Let&apos;s declare a template which recursively calculates a factorial:</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">N</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T5">struct</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">factorial</text:span></text:p>
   <text:p text:style-name="P22">{</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">constexpr</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T67">value</text:span><text:span text:style-name="T18"> = </text:span><text:span text:style-name="T56">N</text:span><text:span text:style-name="T18"> * </text:span><text:span text:style-name="T41">factorial</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T56">N</text:span><text:span text:style-name="T18"> - 1&gt;::</text:span><text:span text:style-name="T66">value</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Text_20_body">I need to define factorial of zero explicitly:</text:p>
   <text:p text:style-name="Standard"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;&gt;</text:span><text:span text:style-name="T5">struct</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">factorial</text:span><text:span text:style-name="T18">&lt;0&gt;</text:span></text:p>
   <text:p text:style-name="P9">{</text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">constexpr</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T67">value</text:span><text:span text:style-name="T18"> = 1;</text:span></text:p>
   <text:p text:style-name="P9">};</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Now I can have following line in my C++ code:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">constexpr</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> factorial_3 = </text:span><text:span text:style-name="T41">factorial</text:span><text:span text:style-name="T18">&lt;3&gt;::</text:span><text:span text:style-name="T67">value</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Text_20_body">C++ compiler will replace call to factorial&lt;3&gt; <text:span text:style-name="T85">with</text:span> 6 and the variable factorial_3 <text:span text:style-name="T85">will be </text:span>a constant known at build time. I have never met firmware code which was required to calculate a factorial of numbers, but there are cases when I needed to force the compilation failure instead of run-time error. Calculating <text:span text:style-name="T87">a </text:span>number of bits in the “int” variable and failing the compilation if the integer is not large enough could be a good example, if C++11 already had not std::numeric_limits&lt;T&gt;::max() which returns maximum value representable by type T. Yet another example is calculating non‑trivial constants. In the following example <text:span text:style-name="T87">the </text:span>function testSum will print 15. <text:span text:style-name="T85">The template function accepts variable number of arguments and is called a variadic template function.</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">sum</text:span><text:span text:style-name="T18">()</text:span></text:p>
   <text:p text:style-name="P22">{</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> 0;</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> ... </text:span><text:span text:style-name="T56">Types</text:span><text:span text:style-name="T18">&gt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">sum</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> first, </text:span><text:span text:style-name="T56">Types</text:span><text:span text:style-name="T18"> ... rest)</text:span></text:p>
   <text:p text:style-name="P22">{</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> first + sum(rest...);</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">const</text:span><text:span text:style-name="T22"> </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> SUM = sum(1, 2, 3, 4, 5);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">testSum</text:span><text:span text:style-name="T18">()</text:span></text:p>
   <text:p text:style-name="P22">{</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>cout &lt;&lt; </text:span><text:span text:style-name="T51">&quot;SUM=&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; SUM &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:h text:style-name="P113" text:outline-level="2"/>
   <text:h text:style-name="P68" text:outline-level="2"><text:bookmark-start text:name="__RefHeading__2948_1515059145"/>Memory <text:span text:style-name="T90">m</text:span>anagement.<text:bookmark-end text:name="__RefHeading__2948_1515059145"/></text:h>
   <text:p text:style-name="Quotations">Programming is like sex, one mistake and you have to support it for the rest of your life. </text:p>
   <text:p text:style-name="Quotations"/>
   <text:p text:style-name="Text_20_body">I am going to discuss two frequently used types of memory allocation in the embedded software – static allocation at build time and allocation from memory pools. </text:p>
   <text:p text:style-name="Text_20_body">I will start the discussion of the dynamic memory allocation from memory pools by declaration of a new class Stack. Template class Stack is similar to the class CyclicBuffer used previously. Class Stack implements two methods “push” and “pop”.</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> ObjectType, </text:span><text:span text:style-name="T5">ty</text:span><text:span text:style-name="T22">pen</text:span><text:span text:style-name="T5">a</text:span><text:span text:style-name="T56">me Lock, s</text:span><text:span text:style-name="T18">td::size_t Size&gt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">clas</text:span><text:span text:style-name="T56">s St</text:span><text:span text:style-name="T18">ack: </text:span><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18"> StackBase {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P22"><text:s text:c="4"/>Stack() :</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="5"/></text:span><text:span text:style-name="T66"><text:s text:c="3"/>S</text:span><text:span text:style-name="T18">tackBase(Size) {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P22"><text:s text:c="4"/>~Stack() {</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> push(ObjectType* object);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> pop(ObjectType** object);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">private</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P22"><text:s text:c="4"/>ObjectType* data[Size + 1];</text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="P1"/>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Base class StackBase contains “top” <text:span text:style-name="T85">and</text:span> “size” fields and a couple of useful APIs</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">StackBase</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">isEmpty</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> res = (</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">top</text:span><text:span text:style-name="T18"> == 0);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">isFull</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> res = (</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">top</text:span><text:span text:style-name="T18"> == </text:span><text:span text:style-name="T66">size</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">StackBase</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> size) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">size</text:span><text:span text:style-name="T18"> = size;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">top</text:span><text:span text:style-name="T18"> = 0;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">errorOverflow</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">errorUnderflow</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">top</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">size</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="P58">Example of implementation of the push and pop methods:</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">templa</text:span><text:span text:style-name="T56">te&lt;typenam</text:span><text:span text:style-name="T5">e</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">Obje</text:span><text:span text:style-name="T18">c</text:span><text:span text:style-name="T56">tTyp</text:span><text:span text:style-name="T18">e, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> Lock, std::size_t Size&gt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> Stack&lt;ObjectType, Lock, Size&gt;::</text:span></text:p>
   <text:p text:style-name="P22">push(ObjectType* object) {</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>Lock <text:span text:style-name="T90">lock</text:span>;</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (!isFull()) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>data[</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;top] = object;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;top++;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">true</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>} </text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>errorOverflow();</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">false</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> ObjectType, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> Lock, std::size_t Size&gt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> Stack&lt;ObjectType, Lock, Size&gt;::</text:span></text:p>
   <text:p text:style-name="P22">pop(ObjectType** object) {</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>Lock <text:span text:style-name="T90">lock</text:span>;</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (!isEmpty()) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;top--;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>*object = (data[</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;top]);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">true</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>} </text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>errorUnderflow();</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">false</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:h text:style-name="P113" text:outline-level="2"/>
   <text:p text:style-name="P62">My next step is to define a block of “raw” data memory. A block of memory is a correctly aligned array of bytes, <text:span text:style-name="T87">which,</text:span> optionally, can be placed at a specific memory address. One popular application for <text:span text:style-name="T85">the </text:span>memory blocks <text:span text:style-name="T85">is </text:span>DMA transfers. Data buffer can be placed in the regular RAM or in the dedicated address space. </text:p>
   <text:p text:style-name="P91">I define a memory region. I use operator “new” – a placement new operator – to “place” the data at the specified address. My memory region has a name for debug purposes. A region address is of type uintptr_t <text:span text:style-name="T87">which is </text:span>an unsigned integer that is capable of storing a pointer.</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">MemoryRegion</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">MemoryRegion</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18"> *name, </text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> address, </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> size) :</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">name</text:span><text:span text:style-name="T18">(name), </text:span><text:span text:style-name="T66">address</text:span><text:span text:style-name="T18">(address), </text:span><text:span text:style-name="T66">size</text:span><text:span text:style-name="T18">(size) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">data</text:span><text:span text:style-name="T18"> = </text:span><text:span text:style-name="T5">new</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T5">reinterpret_cast</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18">*&gt;(address)) </text:span><text:span text:style-name="T41">uint8_t</text:span><text:span text:style-name="T18">[size];</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">getSize</text:span><text:span text:style-name="T18">() </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">size</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18">* </text:span><text:span text:style-name="T22">getName</text:span><text:span text:style-name="T18">() </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">name</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">getAddress</text:span><text:span text:style-name="T18">() </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">address</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char </text:span><text:span text:style-name="T18">*</text:span><text:span text:style-name="T66">name</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">address</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">size</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">uint8_t</text:span><text:span text:style-name="T18"> *</text:span><text:span text:style-name="T66">data</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P64">I create an object of MemoryRegion type and point to the area dmaMemoryData in the dynamic data:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint8_t</text:span><text:span text:style-name="T18"> dmaMemoryDummy[512];</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">MemoryRegion</text:span><text:span text:style-name="T18"> dmaMemoryRegion(</text:span><text:span text:style-name="T51">&quot;dmaMem&quot;</text:span><text:span text:style-name="T18">, (</text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18">)dmaMemoryDummy, </text:span><text:span text:style-name="T5">sizeof</text:span><text:span text:style-name="T18">(dmaMemoryDummy));</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P58">I need an allocator. <text:span text:style-name="T85">This is </text:span>a class deal<text:span text:style-name="T85">ing</text:span> with allocation of memory blocks. The allocator handles the correct alignment. I am going to use the allocator code only once (or rarely). <text:span text:style-name="T85">For example, I need an allocator </text:span>when I fill my memory pool with <text:span text:style-name="T85">the </text:span>data blocks. <text:span text:style-name="T85">T</text:span>he performance is not extremely important here. <text:span text:style-name="T85">The m</text:span>ethod reset “frees” all allocated blocks back to the allocator.</text:p>
   <text:p text:style-name="P28"/>
   <text:p text:style-name="P82"><text:span text:style-name="T10">class</text:span> <text:span text:style-name="T39">MemoryAllocatorRaw</text:span> {</text:p>
   <text:p text:style-name="P6"/>
   <text:p text:style-name="P1"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">MemoryAllocatorRaw</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">MemoryRegion</text:span><text:span text:style-name="T18"> memoryRegion,</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> blockSize,</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> count, </text:span><text:span text:style-name="T5">unsigned</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> alignment);</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">uint8_t</text:span><text:span text:style-name="T18">* </text:span><text:span text:style-name="T22">getBlock</text:span><text:span text:style-name="T18">();</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">blockBelongs</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18">* block) </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">MemoryRegion</text:span><text:span text:style-name="T18">&amp; </text:span><text:span text:style-name="T22">getRegion</text:span><text:span text:style-name="T18">() </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">reset</text:span><text:span text:style-name="T18">();</text:span></text:p>
   <text:p text:style-name="P4"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">constexpr</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">predictMemorySize</text:span><text:span text:style-name="T18">(</text:span></text:p>
   <text:p text:style-name="P4"><text:span text:style-name="T18"><text:s text:c="6"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> blockSize, </text:span></text:p>
   <text:p text:style-name="P4"><text:span text:style-name="T18"><text:s text:c="6"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> count, </text:span><text:span text:style-name="T5">unsigned</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> alignment);</text:span></text:p>
   <text:p text:style-name="P6"/>
   <text:p text:style-name="P1"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">alignment</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">blockSize</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">MemoryRegion</text:span><text:span text:style-name="T18">&amp; </text:span><text:span text:style-name="T66">memoryRegion</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">count</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">sizeTotalBytes</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">alignedBlockSize</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">firstNotAllocatedAddress</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P6"/>
   <text:p text:style-name="P4"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">constexpr</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">alignConst</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> value,</text:span></text:p>
   <text:p text:style-name="P4"><text:span text:style-name="T22"><text:s text:c="6"/></text:span><text:span text:style-name="T5">unsigned</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> alignment);</text:span></text:p>
   <text:p text:style-name="P6"/>
   <text:p text:style-name="P4"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">alignAddress</text:span><text:span text:style-name="T18">(</text:span></text:p>
   <text:p text:style-name="P4"><text:span text:style-name="T18"><text:s text:c="6"/></text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> address, </text:span><text:span text:style-name="T5">unsigned</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> alignment);</text:span></text:p>
   <text:p text:style-name="P9">};</text:p>
   <text:p text:style-name="P22"/>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Implementation of the allocator methods follows. The allocator constructor makes sure that there is enough space in the memory region. I initialize the fields in the first line of the constructor, right after the constructor name:</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T22">MemoryAllocatorRaw::MemoryAllocatorRaw</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">MemoryRegion</text:span><text:span text:style-name="T18"> memoryRegion, </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> blockSize, </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> count, </text:span><text:span text:style-name="T5">unsigned</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> alignment) :</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T66">alignment</text:span><text:span text:style-name="T18">(alignment), </text:span><text:span text:style-name="T66">blockSize</text:span><text:span text:style-name="T18">(blockSize), </text:span><text:span text:style-name="T66">memoryRegion</text:span><text:span text:style-name="T18">(memoryRegion), </text:span><text:span text:style-name="T66">count</text:span><text:span text:style-name="T18">(count) <text:s/>{</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T66">alignedBlockSize</text:span><text:span text:style-name="T18"> = </text:span><text:span text:style-name="T26">alignAddress</text:span><text:span text:style-name="T18">(blockSize, alignment);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T66">sizeTotalBytes</text:span><text:span text:style-name="T18"> = </text:span><text:span text:style-name="T66">alignedBlockSize</text:span><text:span text:style-name="T18"> * count;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T66">sizeTotalBytes</text:span><text:span text:style-name="T18"> &gt; memoryRegion.getSize()) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T2">// handle error</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T66">firstNotAllocatedAddress</text:span><text:span text:style-name="T18"> = memoryRegion.getAddress();</text:span></text:p>
   <text:p text:style-name="P29"><text:s text:c="4"/>reset();</text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Allocator implements only <text:span text:style-name="T85">the </text:span>“get a block” API. Memory pool calls <text:span text:style-name="T85">the </text:span>“get block” API from the pool constructor.</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T41">uint8_t</text:span><text:span text:style-name="T18">* </text:span><text:span text:style-name="T22">MemoryAllocatorRaw::getBlock</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> block;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>block = </text:span><text:span text:style-name="T26">alignAddress</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T66">firstNotAllocatedAddress</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T66">alignment</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T66">firstNotAllocatedAddress</text:span><text:span text:style-name="T18"> += </text:span><text:span text:style-name="T66">alignedBlockSize</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T41">uint8_t</text:span><text:span text:style-name="T18">*)block;</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">My pool needs sanity check to ensure that “free” is called only for the blocks <text:span text:style-name="T85">that</text:span> indeed “belong” to the pool.</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">MemoryAllocatorRaw::blockBelongs</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18">* block) </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> blockPtr = (</text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18">)block;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> res = </text:span><text:span text:style-name="T5">true</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>res = res &amp;&amp; blockPtr &gt;= </text:span><text:span text:style-name="T66">memoryRegion</text:span><text:span text:style-name="T18">.getAddress();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> maxAddress = </text:span><text:span text:style-name="T66">memoryRegion</text:span><text:span text:style-name="T18">.getAddress()+</text:span><text:span text:style-name="T66">sizeTotalBytes</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>res = res &amp;&amp; (blockPtr &lt;= maxAddress);</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> alignedAddress = </text:span><text:span text:style-name="T26">alignAddress</text:span><text:span text:style-name="T18">(blockPtr, </text:span><text:span text:style-name="T66">alignment</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>res = res &amp;&amp; (blockPtr == alignedAddress);</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="P62">The rest of the methods:</text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T5">constexpr</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">MemoryAllocatorRaw::alignConst</text:span><text:span text:style-name="T18">(</text:span></text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="3"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> value, </text:span><text:span text:style-name="T5">unsigned</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> alignment) {</text:span></text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> (value + ((</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18">)alignment-1)) &amp; </text:span></text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="6"/>(~((</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18">)alignment-1));</text:span></text:p>
   <text:p text:style-name="P25">}</text:p>
   <text:p text:style-name="P33"/>
   <text:p text:style-name="P33"><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">MemoryAllocatorRaw::alignAddress</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> address, </text:span><text:span text:style-name="T5">unsigned</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> alignment) {</text:span></text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> res = </text:span></text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="6"/>(address+((</text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18">)alignment-1)) &amp; (~((</text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18">)alignment-1));</text:span></text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="P25">}</text:p>
   <text:p text:style-name="P33"/>
   <text:p text:style-name="P33"><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">MemoryRegion</text:span><text:span text:style-name="T18">&amp; </text:span><text:span text:style-name="T22">MemoryAllocatorRaw::getRegion</text:span><text:span text:style-name="T18">() </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">memoryRegion</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P25">}</text:p>
   <text:p text:style-name="P33"/>
   <text:p text:style-name="P33"><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">MemoryAllocatorRaw::reset</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T66">firstNotAllocatedAddress</text:span><text:span text:style-name="T18"> = </text:span></text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="5"/></text:span><text:span text:style-name="T66">memoryRegion</text:span><text:span text:style-name="T18">.getAddress();</text:span></text:p>
   <text:p text:style-name="P25">}</text:p>
   <text:p text:style-name="P33"/>
   <text:p text:style-name="P62">Before I declare an object of the allocator, I check that the memory region is large enough. I want the compilation to fail <text:span text:style-name="T85">i</text:span>f the memory region is too small:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static_assert</text:span><text:span text:style-name="T18">((</text:span><text:span text:style-name="T5">sizeof</text:span><text:span text:style-name="T18">(dmaMemoryDummy) &gt;= </text:span><text:span text:style-name="T41">MemoryAllocatorRaw</text:span><text:span text:style-name="T18">::</text:span><text:span text:style-name="T26">predictMemorySize</text:span><text:span text:style-name="T18">(63, 3, 2)), </text:span><text:span text:style-name="T51">&quot;DmaMemoryDummy region is not large enough&quot;</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">MemoryAllocatorRaw</text:span><text:span text:style-name="T18"> dmaAllocator(dmaMemoryRegion, 63, 3, 2);</text:span></text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P62">My memory pool is a stack of data blocks. The class contains allocate/free API, some debug statistics. Every memory pool has a name. <text:span text:style-name="T85">Providing a name for the objects </text:span>is useful for logging and printing debug statistics. The stack in the memory pool is intentionally protected by a LockDummy <text:span text:style-name="T87">and</text:span> <text:span text:style-name="T87">is </text:span>not <text:span text:style-name="T85">thread safe</text:span>. I am going to use a real synchronizer in the memory pool methods. </text:p>
   <text:p text:style-name="P91">Class methods with “const” keyword in the signature, for example resetMaxInUse(), can not alter any member of the class. How comes that resetMaxInUse() changes the statistics field anyway?. Field “statistics” is mutable <text:span text:style-name="T85">and this</text:span> allows <text:span text:style-name="T85">the “</text:span>const” methods to modify it. Debug counters is a book example of using <text:span text:style-name="T85">of the </text:span>keyword “mutable”. Method resetMaxInUse() does not affect (<text:span text:style-name="T85">not in a </text:span>meaningfull <text:span text:style-name="T85">way</text:span>) the visible state of the object.</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">&gt; </text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">MemoryPoolRaw</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">MemoryPoolRaw</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18">* name, </text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="6"/></text:span><text:span text:style-name="T41">MemoryAllocatorRaw</text:span><text:span text:style-name="T18">* memoryAllocator);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">~MemoryPoolRaw</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">memoryAllocator-&gt;</text:span><text:span text:style-name="T18">reset();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">resetMaxInUse</text:span><text:span text:style-name="T18">() </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">statistics</text:span><text:span text:style-name="T18">.</text:span><text:span text:style-name="T66">maxInUse</text:span><text:span text:style-name="T18"> = 0;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">typedef</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">struct</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">inUse</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">maxInUse</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">errBadBlock</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>} </text:span><text:span text:style-name="T41">Statistics</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">allocate</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">uint8_t</text:span><text:span text:style-name="T18">** block);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">free</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">uint8_t</text:span><text:span text:style-name="T18">* block);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Statistics</text:span><text:span text:style-name="T18"> &amp;</text:span><text:span text:style-name="T22">getStatistics</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18">) </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> {</text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">statistics</text:span><text:span text:style-name="T18">;}</text:span></text:p>
   <text:p text:style-name="P22"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">mutable</text:span><text:span text:style-name="T22"> </text:span><text:span text:style-name="T41">Statistics</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">statistics</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18">* </text:span><text:span text:style-name="T66">name</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">Stack</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T41">uint8_t</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T41">LockDummy</text:span><text:span text:style-name="T18">, <text:s/></text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T66">pool</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">MemoryAllocatorRaw</text:span><text:span text:style-name="T18">* </text:span><text:span text:style-name="T66">memoryAllocator</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">};</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Memory pool constructor calls the allocator to fill the stack of free blocks. Constructor can, for example, register the newly created memory pool in the data base of the memory pools. Application can provide meanings for the run‑time inspection of the memory pools. Destructor would remove the pool from the data base:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">&gt; </text:span></text:p>
   <text:p text:style-name="P27">MemoryPoolRaw&lt;Lock, Size&gt;::</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T22">MemoryPoolRaw</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18">* name, </text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T41">MemoryAllocatorRaw</text:span><text:span text:style-name="T18">* memoryAllocator) :</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T66">name</text:span><text:span text:style-name="T18">(name), </text:span><text:span text:style-name="T66">memoryAllocator</text:span><text:span text:style-name="T18">(memoryAllocator) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T55">memset</text:span><text:span text:style-name="T18">(&amp;</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">statistics</text:span><text:span text:style-name="T18">, 0, </text:span><text:span text:style-name="T5">sizeof</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">statistics</text:span><text:span text:style-name="T18">));</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">for</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> i = 0;i &lt; </text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">;i++) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">uint8_t</text:span><text:span text:style-name="T18"> *block = memoryAllocator-&gt;getBlock();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">pool</text:span><text:span text:style-name="T18">.push(block);</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P62"><text:span text:style-name="T85">If the </text:span>Lock class is not a dummy <text:span text:style-name="T85">lock, m</text:span>emory pool allocate/free API is reentrant and thread safe. All activity which can modify the state of the stack is protected by <text:span text:style-name="T85">the l</text:span>ock. If <text:span text:style-name="T85">an</text:span> application uses the pool only in one context <text:span text:style-name="T85">the application</text:span> can provide LockDummy template argument for the memory pool. LockDummy adds no code to the executable. Statistics counters are relatively low cost, but <text:span text:style-name="T85">are</text:span> immensely helpful for debugging <text:span text:style-name="T85">errors such as </text:span>allocation failure. </text:p>
   <text:p text:style-name="Standard"/>
   <text:p text:style-name="P80"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">&gt;</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">MemoryPoolRaw&lt;Lock, Size&gt;::</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T22">allocate</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">uint8_t</text:span><text:span text:style-name="T18">** block) {</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T21">lock</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/>res = </text:span><text:span text:style-name="T66">pool</text:span><text:span text:style-name="T18">.pop(block);</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (res) {</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">statistics</text:span><text:span text:style-name="T18">.</text:span><text:span text:style-name="T66">inUse</text:span><text:span text:style-name="T18">++;</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T66">statistics</text:span><text:span text:style-name="T18">.</text:span><text:span text:style-name="T66">inUse</text:span><text:span text:style-name="T18"> &gt; </text:span><text:span text:style-name="T66">statistics</text:span><text:span text:style-name="T18">.</text:span><text:span text:style-name="T66">maxInUse</text:span><text:span text:style-name="T18">)</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T66">statistics</text:span><text:span text:style-name="T18">.</text:span><text:span text:style-name="T66">maxInUse</text:span><text:span text:style-name="T18"> = </text:span><text:span text:style-name="T66">statistics</text:span><text:span text:style-name="T18">.</text:span><text:span text:style-name="T66">inUse</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P9"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="P9">}</text:p>
   <text:p text:style-name="Text_20_body">Memory pool “free” makes sure that the pointer belongs to the pool. <text:span text:style-name="T85">The memory</text:span> allocator knows to recognize it&apos;s own blocks. </text:p>
   <text:p text:style-name="P1"/>
   <text:p text:style-name="P17"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">&gt;</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">MemoryPoolRaw&lt;Lock, Size&gt;::</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T22">free</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">uint8_t</text:span><text:span text:style-name="T18">* block) {</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T21">lock</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/>res = </text:span><text:span text:style-name="T66">memoryAllocator</text:span><text:span text:style-name="T18">-&gt;blockBelongs(block);</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (res) {</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="8"/>res = </text:span><text:span text:style-name="T66">pool</text:span><text:span text:style-name="T18">.push(block);</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">statistics</text:span><text:span text:style-name="T18">.</text:span><text:span text:style-name="T66">inUse</text:span><text:span text:style-name="T18">--;</text:span></text:p>
   <text:p text:style-name="P9"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">statistics</text:span><text:span text:style-name="T18">.</text:span><text:span text:style-name="T66">errBadBlock</text:span><text:span text:style-name="T18">++;</text:span></text:p>
   <text:p text:style-name="P9"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Text_20_body">It is going to be fairly easy to prevent release of the same block more than once. If the data blocks are part of the continuous memory, the allocator can provide a method generating a unique index based on the address of the block. Memory pool can contain an array where blocks are marked as allocated or free, and method free() can check the block against this array. If the memory region is not continuous, the allocator can implement a hash function translat<text:span text:style-name="T85">ing</text:span> the address of a data block to a unique data block index.</text:p>
   <text:h text:style-name="P68" text:outline-level="2"><text:bookmark-start text:name="__RefHeading__12039_1005710029"/>Operator new.<text:bookmark-end text:name="__RefHeading__12039_1005710029"/></text:h>
   <text:p text:style-name="Quotations">Algorithm (noun)<text:line-break/>Word used by programmers when they do not want to explain what they did.</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="Text_20_body">Many small microcontrollers have a relatively small heap for dynamic memory allocation. The design choice not to use <text:span text:style-name="T85">the </text:span>dynamic memory allocation at all is very popular. <text:span text:style-name="T85">Often i</text:span>t does not make sense in the firmware to use standard implementations of operators “new” and “delete” from the C/C++ library. Operator new can throw an exception – a dynamically allocated object by itself – if the system runs out of free memory. Calls to new and delete for different objects in run‑time will eventually cause memory fragmentation. Software timers from the <text:span text:style-name="T85">later</text:span> chapter and STL containers can take advantage of <text:span text:style-name="T90">the </text:span>user‑defined memory allocation <text:span text:style-name="T85">that </text:span>employs custom allocators. <text:span text:style-name="T85">C</text:span>ustomized operator <text:span text:style-name="T85">new </text:span>can be based on a “placement new”. Constructor in the CyclicBufferDynamic class can be redefined like this:</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">&gt; </text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">CyclicBufferDynamic</text:span></text:p>
   <text:p text:style-name="P27">&lt;ObjectType, Lock&gt;::</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T22">CyclicBufferDynamic</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> size, </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> *address) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18"> = 0;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18"> = 0;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">size</text:span><text:span text:style-name="T18"> = size;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (address != </text:span><text:span text:style-name="T5">nullptr</text:span><text:span text:style-name="T18">) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">data</text:span><text:span text:style-name="T18"> = </text:span><text:span text:style-name="T5">new</text:span><text:span text:style-name="T18"> (address) </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">[size];</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">data</text:span><text:span text:style-name="T18"> = </text:span><text:span text:style-name="T5">new</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">[size];</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">static_assert</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">sizeof</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">) &lt;= </text:span><text:span text:style-name="T5">sizeof</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18">), </text:span><text:span text:style-name="T51">&quot;CyclicBuffer is intended to work only with integer types or pointers&quot;</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">In the following example I make the compiler to allocate the required memory statically and use the address of the allocated data in the call to the constructor:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> myDynamicCyclicBufferData[calculateCyclicBufferSize()];</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T41">CyclicBufferDynamic</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T41">LockDummy</text:span><text:span text:style-name="T18">&gt; myDynamicCyclicBuffer(calculateCyclicBufferSize(), &amp;myDynamicCyclicBufferData);</text:span></text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:h text:style-name="P67" text:outline-level="1"><text:bookmark-start text:name="__RefHeading__12421_1005710029"/><text:span text:style-name="T84">I/O access</text:span>.<text:bookmark-end text:name="__RefHeading__12421_1005710029"/></text:h>
   <text:p text:style-name="Quotations">How many programmers does it take to change a light bulb? None – it&apos;s a hardware problem.</text:p>
   <text:p text:style-name="P51"/>
   <text:p text:style-name="P91">Embedded software accesses the hardware via hardware registers. I will assume that there are three groups of registers: read and write registers, read only registers and write only registers. All registers are memory mapped <text:span text:style-name="T85">and </text:span>there is an address for every register. The software can access a register in the same way as it reads or writes a variable given the variable&apos;s address. In case of write only registers it is a custom to keep a cached value. <text:span text:style-name="T85">Cache is </text:span>a variable sitting in the data memory <text:span text:style-name="T85">that</text:span> contains the latest value written to the write only register. </text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">The following example is based on the user interface of the Parallel Input/Output controller (PIO) in the Atmel SAMA5d3 microcontroller. I have simplified the interface to save lines of code and text. </text:p>
   <table:table table:name="PIOUserInterface" table:style-name="PIOUserInterface">
    <table:table-column table:style-name="PIOUserInterface.A"/>
    <table:table-column table:style-name="PIOUserInterface.B"/>
    <table:table-column table:style-name="PIOUserInterface.C"/>
    <table:table-column table:style-name="PIOUserInterface.D"/>
    <table:table-row>
     <table:table-cell table:style-name="PIOUserInterface.A1" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">0x0000</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A1" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">PIO Enable Register</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A1" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">PIO_PER</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.D1" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Write‑only</text:p>
     </table:table-cell>
    </table:table-row>
    <table:table-row>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">0x0004</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">PIO Disable Register</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">PIO_PDR</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.D2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Write‑only</text:p>
     </table:table-cell>
    </table:table-row>
    <table:table-row>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">0x0008</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">PIO Status Register</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">PIO_PSR</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.D2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Read‑only</text:p>
     </table:table-cell>
    </table:table-row>
    <table:table-row>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">0x000C</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Reserved</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents"/>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.D2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents"/>
     </table:table-cell>
    </table:table-row>
    <table:table-row>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">0x0010</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Output Enable Register</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">PIO_OER</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.D2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Write‑only</text:p>
     </table:table-cell>
    </table:table-row>
    <table:table-row>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">0x0014</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Output Disable Register</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">PIO_ODR</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.D2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Write‑only</text:p>
     </table:table-cell>
    </table:table-row>
    <table:table-row>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">0x0018</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Output Status Register</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">PIO_OSR</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.D2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Read‑only</text:p>
     </table:table-cell>
    </table:table-row>
    <table:table-row>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">0x001C</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Reserved</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents"/>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.D2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents"/>
     </table:table-cell>
    </table:table-row>
    <table:table-row>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">0x0020</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Not used</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents"/>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.D2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents"/>
     </table:table-cell>
    </table:table-row>
    <table:table-row>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">0x0024</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Not used</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents"/>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.D2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents"/>
     </table:table-cell>
    </table:table-row>
    <table:table-row>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">0x0028</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Not used</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents"/>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.D2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents"/>
     </table:table-cell>
    </table:table-row>
    <table:table-row>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">0x002C</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Reserved</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents"/>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.D2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents"/>
     </table:table-cell>
    </table:table-row>
    <table:table-row>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">0x0030</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Set Output Data Register</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">PIO_SODR</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.D2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Write‑only</text:p>
     </table:table-cell>
    </table:table-row>
    <table:table-row>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">0x0034</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Clear Output Data Register</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">PIO_CODR</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.D2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Write‑only</text:p>
     </table:table-cell>
    </table:table-row>
    <table:table-row>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">0x0038</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Output Status Register</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.A2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">PIO_ODSR</text:p>
     </table:table-cell>
     <table:table-cell table:style-name="PIOUserInterface.D2" office:value-type="string">
      <text:p text:style-name="Table_20_Contents">Read‑only</text:p>
     </table:table-cell>
    </table:table-row>
   </table:table>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="Text_20_body">There are <text:span text:style-name="T85">five</text:span> <text:span text:style-name="T85">blocks</text:span> <text:span text:style-name="T85">such as</text:span> this <text:span text:style-name="T85">one </text:span>called A, B, C, D, E, F in the microcontroller. The registers are mapped starting at the address 0xFFFFF200. <text:span text:style-name="T85">A u</text:span>ser <text:span text:style-name="T85">wishing to modify a write only register </text:span>shall write 1 to the <text:span text:style-name="T85">relevant </text:span>bit<text:span text:style-name="T85">s</text:span>. For example, user <text:span text:style-name="T85">shall</text:span> write 0x04 to PIO_SODR, PIO_PER, PIO_OER to drive pin 2 (zero based) of the PIO high. Write to the PIO registers is an atomic operation. The hardware interface allows to change the configuration of a single bit in a thread safe manner. <text:span text:style-name="T85">The h</text:span>ardware provides convenient <text:span text:style-name="T87">read only </text:span>status registers which keep the current value of the <text:span text:style-name="T87">write only </text:span>registers.</text:p>
   <text:h text:style-name="P113" text:outline-level="2"/>
   <text:h text:style-name="P68" text:outline-level="2"><text:bookmark-start text:name="__RefHeading__8080_1329019087"/>I/O access in C.<text:bookmark-end text:name="__RefHeading__8080_1329019087"/></text:h>
   <text:p text:style-name="Quotations">&quot;Writing in C or C++ is like running a chain saw with all the safety guards removed&quot; – <text:span text:style-name="Citation">Bob Gray.</text:span></text:p>
   <text:p text:style-name="Quotations"/>
   <text:p text:style-name="Text_20_body">I am providing quick and dirty C implementation. Macro RESERVED demonstrates a neat trick to generate <text:span text:style-name="T85">a </text:span>unique identifier name. </text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#define</text:span><text:span text:style-name="T18"> TOKEN_CAT(x, y) x </text:span><text:span text:style-name="T5">##</text:span><text:span text:style-name="T18"> y</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#define</text:span><text:span text:style-name="T18"> TOKEN_CAT2(x, y) TOKEN_CAT(x, y)</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#define</text:span><text:span text:style-name="T18"> RESERVED TOKEN_CAT2(reserved, __COUNTER__)</text:span></text:p>
   <text:p text:style-name="P91">Declar<text:span text:style-name="T85">ation of</text:span> the PIO structure, a group of32 bits registers, <text:span text:style-name="T85">follows</text:span>. I want to ensure that the compiler does not do any paddin<text:span text:style-name="T85">g and I mark t</text:span>he structure “packed”. Pragma “pack” is potentially not safe. <text:span text:style-name="T85">S</text:span>ome architectures, <text:span text:style-name="T85">such as </text:span>ARM or MIPS, do not support non‑aligned access. </text:p>
   <text:p text:style-name="P28"/>
   <text:p text:style-name="P73"><text:span text:style-name="T9">#pragma</text:span><text:span text:style-name="T17"> pack(push)</text:span></text:p>
   <text:p text:style-name="P28"><text:span text:style-name="T9">#pragma</text:span><text:span text:style-name="T17"> pack(1)</text:span></text:p>
   <text:p text:style-name="P28"><text:span text:style-name="T9">struct</text:span><text:span text:style-name="T17"> </text:span><text:span text:style-name="T40">PIO</text:span><text:span text:style-name="T17"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">volatile</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">PIO_PER</text:span><text:span text:style-name="T18"> <text:s/>;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">volatile</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">PIO_PDR</text:span><text:span text:style-name="T18"> <text:s/>;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">volatile</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">PIO_PSR</text:span><text:span text:style-name="T18"> <text:s/>;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">volatile</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> RESERVED ;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">volatile</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">PIO_OER</text:span><text:span text:style-name="T18"> <text:s/>;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">volatile</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">PIO_ODR</text:span><text:span text:style-name="T18"> <text:s/>;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">volatile</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">PIO_OSR</text:span><text:span text:style-name="T18"> <text:s/>;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">volatile</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> RESERVED ;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">volatile</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> RESERVED ;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">volatile</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> RESERVED ;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">volatile</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> RESERVED ;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">volatile</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> RESERVED ;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">volatile</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">PIO_SODR</text:span><text:span text:style-name="T18"> ;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">volatile</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">PIO_CODR</text:span><text:span text:style-name="T18"> ;</text:span></text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="P28"><text:span text:style-name="T9">#pragma</text:span><text:span text:style-name="T72"> pack(pop)</text:span></text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Declar<text:span text:style-name="T85">ation</text:span> <text:span text:style-name="T85">of the</text:span> pointer to the memory area:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#ifdef</text:span><text:span text:style-name="T18"> REAL_HARDWARE</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> PIO *pios = (PIO*)0xFFFFF200;</text:span></text:p>
   <text:p text:style-name="P20">#else</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">PIO</text:span><text:span text:style-name="T18"> pioDummy[5];</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">PIO</text:span><text:span text:style-name="T18"> *pios = pioDummy;</text:span></text:p>
   <text:p text:style-name="P20">#endif</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Five PIO blocks:</text:p>
   <text:p text:style-name="P34"><text:span text:style-name="T5">typedef</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">enum</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T67">PIO_A</text:span><text:span text:style-name="T18">,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T67">PIO_B</text:span><text:span text:style-name="T18">,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T67">PIO_C</text:span><text:span text:style-name="T18">,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T67">PIO_D</text:span><text:span text:style-name="T18">,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T67">PIO_E</text:span><text:span text:style-name="T18">,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T67">PIO_F</text:span><text:span text:style-name="T18">,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18">} </text:span><text:span text:style-name="T41">PIO_NAME</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Function which configures a pin as output:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">enableOutput</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">PIO_NAME</text:span><text:span text:style-name="T18"> name, </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> pin, </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> value) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">PIO</text:span><text:span text:style-name="T18"> *pio = &amp;pios[name];</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> mask = 1 &lt;&lt; pin;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (value) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>pio-&gt;</text:span><text:span text:style-name="T66">PIO_SODR</text:span><text:span text:style-name="T18"> = mask;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>pio-&gt;</text:span><text:span text:style-name="T66">PIO_CODR</text:span><text:span text:style-name="T18"> = mask;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>pio-&gt;</text:span><text:span text:style-name="T66">PIO_PER</text:span><text:span text:style-name="T18"> = mask;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>pio-&gt;</text:span><text:span text:style-name="T66">PIO_OER</text:span><text:span text:style-name="T18"> = mask;</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Function which drives PIO A, pin 2 high can look like this:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">main</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>enableOutput(</text:span><text:span text:style-name="T67">PIO_A</text:span><text:span text:style-name="T18">, 2, 1);</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Text_20_body">This is how the relevant assembly for Intel looks like – as expected there are three 32‑bits moves </text:p>
   <text:p text:style-name="P22"/>
   <text:p text:style-name="P75"><text:s text:c="2"/>PIO *pio = &amp;pios[name];</text:p>
   <text:p text:style-name="P22"><text:s text:c="2"/>uint32_t mask = 1 &lt;&lt; pin;</text:p>
   <text:p text:style-name="P22"><text:s text:c="2"/>if (value) {</text:p>
   <text:p text:style-name="P22"><text:s text:c="6"/>pio-&gt;PIO_SODR = mask;</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">4007e0:</text:span><text:span text:style-name="T18"><text:tab/>c7 05 e6 19 20 00 04 <text:tab/>movl <text:s text:c="2"/>$0x4,0x2019e6(</text:span><text:span text:style-name="T5">%rip</text:span><text:span text:style-name="T18">)</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">4007e7:</text:span><text:span text:style-name="T18"><text:tab/>00 00 00 </text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">4007ea:</text:span><text:span text:style-name="T18"><text:tab/>31 c0 <text:s text:c="15"/><text:tab/>xor <text:s text:c="3"/></text:span><text:span text:style-name="T5">%eax</text:span><text:span text:style-name="T18">,</text:span><text:span text:style-name="T5">%eax</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="6"/>pio-&gt;PIO_SODR = mask;</text:p>
   <text:p text:style-name="P22"><text:s text:c="2"/>}</text:p>
   <text:p text:style-name="P22"><text:s text:c="2"/>else {</text:p>
   <text:p text:style-name="P22"><text:s text:c="6"/>pio-&gt;PIO_CODR = mask;</text:p>
   <text:p text:style-name="P22"><text:s text:c="2"/>}</text:p>
   <text:p text:style-name="P22"><text:s text:c="2"/>pio-&gt;PIO_PER = mask;</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">4007ec:</text:span><text:span text:style-name="T18"><text:tab/>c7 05 aa 19 20 00 04 <text:tab/>movl <text:s text:c="2"/>$0x4,0x2019aa(</text:span><text:span text:style-name="T5">%rip</text:span><text:span text:style-name="T18">)</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">4007f3:</text:span><text:span text:style-name="T18"><text:tab/>00 00 00 </text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="2"/>pio-&gt;PIO_OER = mask;</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">4007f6:</text:span><text:span text:style-name="T18"><text:tab/>c7 05 b0 19 20 00 04 <text:tab/>movl <text:s text:c="2"/>$0x4,0x2019b0(</text:span><text:span text:style-name="T5">%rip</text:span><text:span text:style-name="T18">)</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">4007fd:</text:span><text:span text:style-name="T18"><text:tab/>00 00 00 </text:span></text:p>
   <text:p text:style-name="Text_20_body">Assembly generated for ARM is slightly longer. In ARM an address should be loaded to a register before a value can be stored.</text:p>
   <text:p text:style-name="P22"/>
   <text:p text:style-name="P75">PIO *pio = &amp;pios[name];</text:p>
   <text:p text:style-name="P22">uint32_t mask = 1 &lt;&lt; pin;</text:p>
   <text:p text:style-name="P22">if (value) {</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>pio-&gt;PIO_SODR = mask;</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">8650:</text:span><text:span text:style-name="T18"><text:tab/>e59f3014 <text:tab/>ldr<text:tab/>r3, [pc, #20]</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">8654:</text:span><text:span text:style-name="T18"><text:tab/>e3a02004 <text:tab/>mov<text:tab/>r2, #4</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">8658:</text:span><text:span text:style-name="T18"><text:tab/>e5832090 <text:tab/>str<text:tab/>r2, [r3, #144]</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">865c:</text:span><text:span text:style-name="T18"><text:tab/>e3a00000 <text:tab/>mov<text:tab/>r0, #0</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>pio-&gt;PIO_SODR = mask;</text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="P22">else {</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>pio-&gt;PIO_CODR = mask;</text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="P22">pio-&gt;PIO_PER = mask;</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">8660:</text:span><text:span text:style-name="T18"><text:tab/>e5832060 <text:tab/>str<text:tab/>r2, [r3, #96]</text:span></text:p>
   <text:p text:style-name="P22">pio-&gt;PIO_OER = mask;</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">8664:</text:span><text:span text:style-name="T18"><text:tab/>e5832070 <text:tab/>str<text:tab/>r2, [r3, #112]</text:span></text:p>
   <text:h text:style-name="P113" text:outline-level="2"/>
   <text:h text:style-name="P68" text:outline-level="2"><text:bookmark-start text:name="__RefHeading__8082_1329019087"/>I/O access in C++.<text:bookmark-end text:name="__RefHeading__8082_1329019087"/></text:h>
   <text:p text:style-name="P50">&quot;C(++) is a write‑only, high‑level assembler language.&quot; <text:span text:style-name="Citation">Stefan Van Baelen.</text:span></text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="Text_20_body">This is not easy to compete with <text:span text:style-name="T85">the </text:span>C <text:span text:style-name="T85">implementation </text:span>when accessing the I/O. <text:span text:style-name="T85">The C c</text:span>ompiler <text:span text:style-name="T85">for i386 </text:span>translate<text:span text:style-name="T85">d</text:span> every line of <text:span text:style-name="T90">the </text:span>C code into a single machine opcode. There is no need to manually specify an address for every register. <text:span text:style-name="T85">I</text:span>t <text:span text:style-name="T85">is</text:span> enough to create a pointer which references <text:span text:style-name="T90">the </text:span>physical address <text:span text:style-name="T85">of the first register in the block</text:span>. I <text:span text:style-name="T90">want</text:span> <text:span text:style-name="T90">a </text:span>C++ implementation with the same perfect performance score, similar convenience of usage AND some added value, for example type safety.</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P62">First class is an abstraction of a hardware module. The class constructor is protected. <text:span text:style-name="T85">A</text:span>pplication can create <text:span text:style-name="T85">only </text:span>objects of <text:span text:style-name="T85">the </text:span>derived classes.</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">HardwareModule</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">HardwareModule</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> address): </text:span><text:span text:style-name="T66">address</text:span><text:span text:style-name="T18">(address) {}</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">~HardwareModule</text:span><text:span text:style-name="T18">() {}</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">address</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">I declare a template for all hardware registers. Static assert will fail compilation if <text:span text:style-name="T85">the </text:span>argument IntegerType specified in the type instantiation is not an integer type. API “std::atomic” ensures an atomic read/write operation on any architecture, <text:span text:style-name="T85">such as</text:span> reading of 32 bis value on 8 bits CPU</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">IntegerType</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">HardwareRegister</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">HardwareRegister</text:span><text:span text:style-name="T18">() {}</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">IntegerType</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">get</text:span><text:span text:style-name="T18">() </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> atomic_load(&amp;</text:span><text:span text:style-name="T66">value</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">set</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">IntegerType</text:span><text:span text:style-name="T18"> value) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>atomic_store(&amp;</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">value</text:span><text:span text:style-name="T18">, value);</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">volatile</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">atomic</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T56">IntegerType</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T66">value</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">static_assert</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">numeric_limits</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T56">IntegerType</text:span><text:span text:style-name="T18">&gt;::</text:span><text:span text:style-name="T66">is_integer</text:span><text:span text:style-name="T18">,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T51">&quot;HardwareRegister works only with integer types&quot;</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Next class is a 32 bits register. Static assertion will fail the build if the object consumes more than 32 bits. <text:span text:style-name="T85">Correct size of the data</text:span> is absolutely vital for the access to the hardware and comes instead of the “packed” attribute in the C version.</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">HardwareRegister32</text:span><text:span text:style-name="T18">: </text:span><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">HardwareRegister</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18">&gt; {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">HardwareRegister32</text:span><text:span text:style-name="T18">() {}</text:span></text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static_assert</text:span><text:span text:style-name="T18">((</text:span><text:span text:style-name="T5">sizeof</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">HardwareRegister32</text:span><text:span text:style-name="T18">) == </text:span><text:span text:style-name="T5">sizeof</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18">)), </text:span><text:span text:style-name="T51">&quot;HardwareRegister32 is not 32 bits&quot;</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P62">Read only and write only registers follow. The <text:span text:style-name="T85">read only</text:span> <text:span text:style-name="T85">register</text:span> <text:span text:style-name="T85">class </text:span>overload<text:span text:style-name="T85">s</text:span> <text:span text:style-name="T85">the </text:span>type cast operator and allow<text:span text:style-name="T85">s</text:span> to use <text:span text:style-name="T85">an </text:span>assignment to read the register value. The <text:span text:style-name="T85">write only</text:span> <text:span text:style-name="T85">register</text:span> <text:span text:style-name="T85">class </text:span>overload<text:span text:style-name="T85">s</text:span> <text:span text:style-name="T85">the </text:span>assignment operator and allow<text:span text:style-name="T85">s</text:span> to use <text:span text:style-name="T85">an </text:span>assignment <text:span text:style-name="T85">to </text:span>write the register value. Read/write registers would implement both <text:span text:style-name="T85">the </text:span>assignment operator and <text:span text:style-name="T85">the </text:span>type cast operator.</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P58">Read only register:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">HardwareRegister32RO</text:span><text:span text:style-name="T18"> : </text:span><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">HardwareRegister32</text:span><text:span text:style-name="T18">{</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">operator uint32_t</text:span><text:span text:style-name="T18">() </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> get();</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static_assert</text:span><text:span text:style-name="T18">((</text:span><text:span text:style-name="T5">sizeof</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">HardwareRegister32RO</text:span><text:span text:style-name="T18">) == </text:span><text:span text:style-name="T5">sizeof</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18">)), </text:span><text:span text:style-name="T51">&quot;HardwareRegister32RO is not 32 bits&quot;</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P58">Write only register:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">HardwareRegister32WO</text:span><text:span text:style-name="T18"> : </text:span><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">HardwareRegister32</text:span><text:span text:style-name="T18">{</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">operator=</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> value) {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>set(value);</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> value;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static_assert</text:span><text:span text:style-name="T18">((</text:span><text:span text:style-name="T5">sizeof</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">HardwareRegister32WO</text:span><text:span text:style-name="T18">) == </text:span><text:span text:style-name="T5">sizeof</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18">)), </text:span><text:span text:style-name="T51">&quot;HardwareRegister32WO is not 32 bits&quot;</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">For the clarity I add a register “reserved” – I call it “not used”:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">HardwareRegister32NotUsed</text:span><text:span text:style-name="T18"> : </text:span><text:span text:style-name="T41">HardwareRegister32</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">HardwareRegister32NotUsed</text:span><text:span text:style-name="T18">() {}</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">~HardwareRegister32NotUsed</text:span><text:span text:style-name="T18">() {}</text:span></text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static_assert</text:span><text:span text:style-name="T18">((</text:span><text:span text:style-name="T5">sizeof</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">HardwareRegister32NotUsed</text:span><text:span text:style-name="T18">) == </text:span><text:span text:style-name="T5">sizeof</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18">)), </text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T51">&quot;HardwareRegister32NotUsed is not 32 bits&quot;</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Text_20_body">The framework is in place and can serve any 32 bits register. Declare the PIO hardware module. There is nothing unexpected, but just a repetition of all the same tricks including <text:span text:style-name="T85">build</text:span> time check of the size of the structure. An object of <text:span text:style-name="T85">the </text:span>type HardwarePIO requires about the same amount data as the competing C version. Depending on the optimization level and complexity of the class there is going to be one additional pointer in the RAM, <text:span text:style-name="T85">a </text:span>pointer “this”. In the specific implementation below all methods of the class are “inline” and the object data <text:span text:style-name="T85">gets</text:span> optimized out completely. </text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">HardwarePIO</text:span><text:span text:style-name="T18"> : </text:span><text:span text:style-name="T41">HardwareModule</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">HardwarePIO</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> address) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">interface</text:span><text:span text:style-name="T18"> = (</text:span><text:span text:style-name="T5">struct</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Interface</text:span><text:span text:style-name="T18">*)address;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">~HardwarePIO</text:span><text:span text:style-name="T18">() {}</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">struct</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Interface</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">HardwareRegister32WO</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">PIO_PER</text:span><text:span text:style-name="T18"> <text:s/>;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">HardwareRegister32WO</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">PIO_PDR</text:span><text:span text:style-name="T18"> <text:s/>;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">HardwareRegister32RO</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">PIO_PSR</text:span><text:span text:style-name="T18"> <text:s/>;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">HardwareRegister32NotUsed</text:span><text:span text:style-name="T18"> RESERVED ;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">HardwareRegister32WO</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">PIO_OER</text:span><text:span text:style-name="T18"> <text:s/>;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">HardwareRegister32WO</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">PIO_ODR</text:span><text:span text:style-name="T18"> <text:s/>;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">HardwareRegister32RO</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">PIO_OSR</text:span><text:span text:style-name="T18"> <text:s/>;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">HardwareRegister32NotUsed</text:span><text:span text:style-name="T18"> RESERVED ;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">HardwareRegister32NotUsed</text:span><text:span text:style-name="T18"> RESERVED ;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">HardwareRegister32NotUsed</text:span><text:span text:style-name="T18"> RESERVED ;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">HardwareRegister32NotUsed</text:span><text:span text:style-name="T18"> RESERVED ;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">HardwareRegister32NotUsed</text:span><text:span text:style-name="T18"> RESERVED ;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">HardwareRegister32WO</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">PIO_SODR</text:span><text:span text:style-name="T18"> ;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">HardwareRegister32WO</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">PIO_CODR</text:span><text:span text:style-name="T18"> ;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>};</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">static_assert</text:span><text:span text:style-name="T18">((</text:span><text:span text:style-name="T5">sizeof</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">struct</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Interface</text:span><text:span text:style-name="T18">) == (14*</text:span><text:span text:style-name="T5">sizeof</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18">))), </text:span><text:span text:style-name="T51">&quot;</text:span><text:span text:style-name="T53">struct</text:span><text:span text:style-name="T51"> interface is of wrong size, broken alignment?&quot;</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">enum</text:span><text:span text:style-name="T18"> Name {</text:span><text:span text:style-name="T67">A</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T67">B</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T67">C</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T67">D</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T67">E</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T67">F</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T67">LAST</text:span><text:span text:style-name="T18">};</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Interface </text:span><text:span text:style-name="T18">&amp;</text:span><text:span text:style-name="T22">getInterface</text:span><text:span text:style-name="T18">(Name name) </text:span><text:span text:style-name="T5">const </text:span><text:span text:style-name="T18">{</text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">interface</text:span><text:span text:style-name="T18">[name];};</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">enableOutput</text:span><text:span text:style-name="T18">(Name name, </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> pin, </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> value);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">struct</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Interface </text:span><text:span text:style-name="T18">*</text:span><text:span text:style-name="T66">interface</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Implementation of the method enableOutput is similar to the C version:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">HardwarePIO::enableOutput</text:span><text:span text:style-name="T18">(Name name, </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> pin, </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> value)</text:span></text:p>
   <text:p text:style-name="P22">{</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">struct</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Interface </text:span><text:span text:style-name="T18">&amp;interface = getInterface(name);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> mask = 1 &lt;&lt; pin;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (value) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>interface.</text:span><text:span text:style-name="T66">PIO_SODR</text:span><text:span text:style-name="T18"> = mask;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>interface.</text:span><text:span text:style-name="T66">PIO_CODR</text:span><text:span text:style-name="T18"> = mask;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>interface.</text:span><text:span text:style-name="T66">PIO_PER</text:span><text:span text:style-name="T18"> = mask;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>interface.</text:span><text:span text:style-name="T66">PIO_OER</text:span><text:span text:style-name="T18"> = mask;</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Usage example:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">HardwarePIO</text:span><text:span text:style-name="T18"> hardwarePIO(</text:span><text:span text:style-name="T5">reinterpret_cast</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18">&gt;(pioDummy));</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">main</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>hardwarePIO.enableOutput(</text:span><text:span text:style-name="T41">HardwarePIO</text:span><text:span text:style-name="T18">::</text:span><text:span text:style-name="T67">A</text:span><text:span text:style-name="T18">, 2, 1);</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Text_20_body">This C++ implementation produces the same assembly as the old trusty C one. There is no more “code bloat” than in the C implementation. C++ framework comes with some worthy benefits. If a user attempts to read a write only register <text:span text:style-name="T85">the </text:span>build will fail. The following statement will break the compilation:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> per = hardwarePIO.getInterface(</text:span><text:span text:style-name="T41">HardwarePIO</text:span><text:span text:style-name="T18">::</text:span><text:span text:style-name="T67">A</text:span><text:span text:style-name="T18">).</text:span><text:span text:style-name="T66">PIO_PER</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P94">Access to the PIO registers is encapsulated in the class methods of the hardware module. The methods in the HardwarePIO class are the only way to modify a register. C++ implementation allows to catch other wrong doings at compilation time, for example reading or writing reserved registers. </text:p>
   <text:p text:style-name="Text_20_body">It is easy to cache all written values in the hardware module. One way to cache or log the read and write transactions is to add a “shadow” interface field to the hardware module class.</text:p>
   <text:h text:style-name="P113" text:outline-level="2"/>
   <text:h text:style-name="P68" text:outline-level="2"><text:bookmark-start text:name="__RefHeading__11237_696237465"/>Indirect I/O access.<text:bookmark-end text:name="__RefHeading__11237_696237465"/></text:h>
   <text:p text:style-name="Text_20_body">In some case the hardware is accessible via a serial interface. <text:span text:style-name="T85">One example of such interface is </text:span>SPI. I am using a direct access API for the sake of brevity. A real access interface for a real SPI device can contain system calls or calls to the serial interface driver:</text:p>
   <text:p text:style-name="P1"/>
   <text:p text:style-name="P18"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">IntegerType</text:span><text:span text:style-name="T18">&gt; </text:span></text:p>
   <text:p text:style-name="P3"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">HardwareDirectAccessAPI</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">get</text:span><text:span text:style-name="T18">() </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> atomic_load(&amp;</text:span><text:span text:style-name="T66">value</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="P9"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">set</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18"> value) {</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="8"/>atomic_store(&amp;</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">value</text:span><text:span text:style-name="T18">, value);</text:span></text:p>
   <text:p text:style-name="P9"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">volatile</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">atomic</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T56">IntegerType</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T66">value</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">static_assert</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">numeric_limits</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T56">IntegerType</text:span><text:span text:style-name="T18">&gt;::</text:span><text:span text:style-name="T66">is_integer</text:span><text:span text:style-name="T18">,</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="6"/></text:span><text:span text:style-name="T51">&quot;HardwareDirectAccessAPI works only with integer types&quot;</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="P9">};</text:p>
   <text:p text:style-name="P22"/>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">I am adding an argument to the template class HardwareRegister:</text:p>
   <text:p text:style-name="P42"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">IntegerType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">AccessAPI</text:span><text:span text:style-name="T18">&gt; </text:span></text:p>
   <text:p text:style-name="P42"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">HardwareRegister</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">HardwareRegister</text:span><text:span text:style-name="T18">() {}</text:span></text:p>
   <text:p text:style-name="P6"/>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">IntegerType</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">get</text:span><text:span text:style-name="T18">() </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">api</text:span><text:span text:style-name="T18">.get();</text:span></text:p>
   <text:p text:style-name="P9"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">set</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">IntegerType</text:span><text:span text:style-name="T18"> value) {</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">api</text:span><text:span text:style-name="T18">.set(value);</text:span></text:p>
   <text:p text:style-name="P9"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P6"/>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T56">AccessAPI</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">api</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P9">};</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Instance of the HardwareRegister for 32 bits registers, direct access will look like this:</text:p>
   <text:p text:style-name="P42"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">HardwareRegister32</text:span><text:span text:style-name="T18">: </text:span></text:p>
   <text:p text:style-name="P42"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">HardwareRegister</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T41">HardwareDirectAccessAPI</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T41">uint32_t</text:span><text:span text:style-name="T18">&gt; &gt; {</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">HardwareRegister32</text:span><text:span text:style-name="T18">() {}</text:span></text:p>
   <text:p text:style-name="P9">};</text:p>
   <text:p text:style-name="Text_20_body"><text:span text:style-name="T84">The r</text:span>est of the classes remain<text:span text:style-name="T84">s</text:span> the same. </text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:h text:style-name="P67" text:outline-level="1"><text:bookmark-start text:name="__RefHeading__7726_2007975351"/>Code ROM and data RAM.<text:bookmark-end text:name="__RefHeading__7726_2007975351"/></text:h>
   <text:p text:style-name="Quotations">If at first you don&apos;t succeed; call it version 1.0. </text:p>
   <text:p text:style-name="Quotations"/>
   <text:p text:style-name="Text_20_body">There are very popular hardware platforms, where ROM and RAM distinction is very important. One example of such device is rather popular 8 bits microcontrollers Atmega. In the Atmega MCUs code can not be placed in the data memory <text:span text:style-name="T85">and </text:span>CPU can not execute code sitting in the RAM. <text:span text:style-name="T85">Any a</text:span>ccess to the data in the code memory requires special instructions. Another example is Application Specific Integration Circuits or ASICs. An ASIC often contains integrated ROM and RAM. Integrated, also called on die or on chip, ROM storage is relatively cheap, because it requires relatively small amount of space on the silicone wafer. RAM is relatively expensive because it requires more logic per bit of memory and square inches on the integrated circuit (die) come at premium. RAM consumes significantly more power. I think that the vast majority of the electronic device around us have integrated ROM and RAM (frequently SRAM) inside. <text:span text:style-name="T85">T</text:span>ypically <text:span text:style-name="T85">the </text:span>on chip RAM is much smaller than the ROM.</text:p>
   <text:p text:style-name="Text_20_body">There are two types of ROM: erasable and not erasable. In the Atmega MCUs different areas of the ROM can be programmed by the firmware, assuming that the firmware runs from another area. In case of ASICs <text:span text:style-name="T85">the </text:span>ROM is often not erasable. <text:span text:style-name="T85">Programming of the </text:span>ROM is a part of the ASIC production process. The ROM can not be modified after the chip leaves the factory (<text:span text:style-name="T85">the </text:span>FAB). </text:p>
   <text:p text:style-name="Text_20_body">If there is not enough RAM to load the firmware, then parts of the firmware code should be located in the chip ROM. In case of an ASIC it means that the ROM based parts of the firmware can be changed only in the future versions of the chip. High complexity of the modern ASIC firmware makes it very hard to reach 100% code coverage in the ASIC verification process. Even if the ROM based firmware is verified and tested completely, still there is a chance that this or that protocol has been misunderstood by the development team, <text:span text:style-name="T85">or </text:span>product requirements has changed. The development team prepares the firmware and the hardware for the not unlikely event that <text:span text:style-name="T85">a </text:span>need to patch the ROM will arise.</text:p>
   <text:p text:style-name="Text_20_body">This chapter covers some of the ROM related problems.</text:p>
   <text:h text:style-name="P113" text:outline-level="2"/>
   <text:h text:style-name="P68" text:outline-level="2"><text:bookmark-start text:name="__RefHeading__7728_2007975351"/>C++ Initialized data.<text:bookmark-end text:name="__RefHeading__7728_2007975351"/></text:h>
   <text:p text:style-name="P94">At least one code section, <text:span text:style-name="T85">a</text:span> boot, constants and initialized data are parts of the ROM. Initialized, non‑zero data is going to consume memory two times. Initialization values of the initialized data are part of the ROM. Usually boot process copies the values from the ROM to the RAM. If I inspect an object file generated by a compiler, I can easily find initialization data for the strings. There are utilities which help to inspect the object files, dump different section into separate files, and prepare the images for <text:span text:style-name="T85">the </text:span>ROM programming. <text:span text:style-name="T85">One e</text:span>xample of such utility is GNU objdump. Let&apos;s see some C++ initialized data in action. Following code produces two line<text:span text:style-name="T85">s</text:span> of output: “Hello, world!”, <text:span text:style-name="T85">followed by </text:span>“Hello from main()!”</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">HelloWorld</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">HelloWorld</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>cout &lt;&lt; </text:span><text:span text:style-name="T51">&quot;Hello, world!&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">HelloWorld</text:span><text:span text:style-name="T18"> helloWorld;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">main</text:span><text:span text:style-name="T18">()</text:span></text:p>
   <text:p text:style-name="P22">{</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>cout &lt;&lt; </text:span><text:span text:style-name="T51">&quot;Hello from main()!&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> 0;</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Text_20_body"><text:span text:style-name="T85">The f</text:span>unction main() contains only one output. <text:span text:style-name="T85">The e</text:span>ntity responsible for initializing of the C++ object helloWorld and printing the first line is an object loader running in my operating system. In case of the embedded systems this code is usually part of the boot process. <text:span text:style-name="T85">The c</text:span>onstructor of the HelloWorld class is “text” and appears only once in the ROM. Arguments of the cout, the strings, can exist in two places in the memory: <text:span text:style-name="T85">o</text:span>riginal or “master copy” is in the ROM, a second copy, created by the loader, is in the RAM. Pointer “this” which contains address of the statically allocated object helloWorld has two copies too. There is an initialization value for “this” pointer in the ROM and “this” pointer in the RAM. <text:s/>Size allocated by helloWorld object in the ROM of 32 bits CPU is at least 4 bytes of “this” and 14 bytes of <text:span text:style-name="T85">the </text:span>zero terminated string. <text:span text:style-name="T85">The l</text:span>inker script is responsible for correct placement of different sections of the code and <text:span text:style-name="T85">the </text:span>data. If the CPU can not access data stored in the code memory, <text:span text:style-name="T85">the </text:span>linker script should contain relevant allocation instructions. Specifically place for the constant data section will be allocated two times: in the code ROM address space and in the RAM. <text:s/></text:p>
   <text:p text:style-name="Text_20_body">In a typical case, a linker script will add global variables <text:span text:style-name="T85">that</text:span> reference <text:span text:style-name="T85">the </text:span>start and <text:span text:style-name="T85">the </text:span>end address of the not initialized data section(s) “bss”, initialize<text:span text:style-name="T85">d</text:span> data, and <text:span text:style-name="T87">a </text:span>table of “ctor” functions. Usually <text:span text:style-name="T85">the </text:span>ctor section is a table or tables of functions <text:span text:style-name="T85">that</text:span> the boot code calls to initialize static C++ objects. See your linker documentation for details.</text:p>
   <text:h text:style-name="P68" text:outline-level="2"><text:bookmark-start text:name="__RefHeading__7954_2007975351"/>ROM patching.<text:bookmark-end text:name="__RefHeading__7954_2007975351"/></text:h>
   <text:p text:style-name="Quotations">Programming is a lot like sex. One mistake and you&apos;re providing support for a lifetime.</text:p>
   <text:p text:style-name="Quotations"/>
   <text:p text:style-name="Text_20_body">I want to prepare the constructor code for a patch in the future. I will check some <text:span text:style-name="T85">location</text:span> in the RAM. If there is a non‑zero entry, <text:span text:style-name="T85">then </text:span>I will use the string from there. <text:span text:style-name="T85">I</text:span>f not, I will print the default value – the ROMed one.</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18"> *helloWorldStr = 0;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">HelloWorld</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">HelloWorld</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (helloWorldStr == 0)</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/>cout &lt;&lt; </text:span><text:span text:style-name="T51">&quot;Hello, world!&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">else</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/>cout &lt;&lt; helloWorldStr &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Text_20_body">Loading of an ASIC which can be patched contains two stages. In the first phase external CPU (also called a host processor) loads some firmware to the ASIC RAM. <text:span text:style-name="T85">T</text:span>here is a dedicated hardware/boot firmware support<text:span text:style-name="T85">ing</text:span> load of the application firmware to the RAM. An alternative can be that <text:span text:style-name="T85">the </text:span>boot code in the ASIC loads the application firmware from some external programmable memory chip, for example, EEPROM or SPI FLASH. The second phase is when <text:span text:style-name="T85">the </text:span>boot jumps to the application code in the RAM. If the code loaded by the host processor contains non‑zero at the address helloWorldStr the ROM based application code will print a new string. I am calling this type of <text:span text:style-name="T87">patch a p</text:span>atch <text:span text:style-name="T87">t</text:span>ype A. In the patch type A I fix <text:span text:style-name="T85">a </text:span>part of the function. </text:p>
   <text:p text:style-name="Text_20_body">For the <text:span text:style-name="T87">p</text:span>atch type B I need <text:span text:style-name="T87">the </text:span>hardware support. If the CPU fetches an instruction from a specific address or a range of addresses – in case of the code below this is an address of the function printHello() – I want to “interrupt” <text:span text:style-name="T85">the execution </text:span>and switch control to the interrupt handler located in the RAM. Default interrupt handler does nothing. <text:span text:style-name="T85">The handler </text:span>is empty and simply returns allowing the function printHello() to complete it&apos;s useful work. <text:span text:style-name="T85">The p</text:span>atched interrupt handler can modify the string “Hello, world” in the RAM before letting the function printHello() to print it The interrupt handler can execute some arbitrary code and return the control to the caller of the printHello(), skipping the original print code completely.</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">HelloWorld</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">HelloWorld</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>printHello();</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">printHello</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>cout &lt;&lt; </text:span><text:span text:style-name="T51">&quot;Hello, world!&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Text_20_body">For <text:span text:style-name="T87">the p</text:span>atch <text:span text:style-name="T87">t</text:span>ype C I need support in the linker script. I want to place <text:span text:style-name="T85">the </text:span>constructor of the HelloWorld in the ROM, but method printHello() I want to execute in the RAM. If the HelloWorld constructor calls a function in the RAM I can easily patch the function code. </text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:h text:style-name="P67" text:outline-level="1"><text:bookmark-start text:name="__RefHeading__12357_1195782936"/>Operating system.<text:bookmark-end text:name="__RefHeading__12357_1195782936"/></text:h>
   <text:p text:style-name="P49">Have you ever noticed the difference between a &apos;C&apos; project plan, and a C++ project plan? The planning stage for a C++ project is three times as long. Precisely to make sure that everything which should be inherited is, and what shouldn&apos;t isn&apos;t. Then, they still get it wrong. </text:p>
   <text:p text:style-name="P49">Remember the length of the average‑sized &apos;C&apos; project? About 6 months. Not nearly long enough for a guy with a wife and kids to earn enough to have a decent standard of living. Take the same project, design it in C++ and what do you get? I&apos;ll tell you. One to two years. Isn&apos;t that great?</text:p>
   <text:p text:style-name="Quotations"/>
   <text:p text:style-name="Text_20_body">I will attempt to write a wrapper for the “create task” API. A typical wrapper for APIs similar to <text:span text:style-name="T85">the </text:span>pthread_create or FreeRTOS xTaskCreate is based on a static method in a class called, for example, MyThread. Indeed this is the only way I know to write a portable C++ wrapper <text:span text:style-name="T85">that </text:span>will work for most operating systems. I will duly present a basic example of this approach not because it is fascinating, but because it is expected of a reasonable “C++ for embedded” book. Feel free to jump right to the next paragraph where I present non‑portable code of C++ create task wrapper. </text:p>
   <text:h text:style-name="P113" text:outline-level="2"/>
   <text:h text:style-name="P68" text:outline-level="2"><text:bookmark-start text:name="__RefHeading__13575_1195782936"/>Static (class) member.<text:bookmark-end text:name="__RefHeading__13575_1195782936"/></text:h>
   <text:p text:style-name="Quotations"><text:span text:style-name="Emphasis">C </text:span>allows you to shoot yourself in the foot. <text:span text:style-name="Emphasis">C++ </text:span>allows you to re‑use the bullet.</text:p>
   <text:p text:style-name="Quotations"/>
   <text:p text:style-name="P107">I am going to allocate my job thread objects from a pool. For example an implementation of <text:span text:style-name="T85">the </text:span>R<text:span text:style-name="T85">emote </text:span>P<text:span text:style-name="T85">rocedure </text:span>C<text:span text:style-name="T85">all</text:span> <text:span text:style-name="T85">could</text:span> use a pool of job threads to execute procedures locally. <text:span text:style-name="T95">Allocation of a thread object from the memory pool is faster than calling the operating system API to create a new thread. </text:span>MemoryPool is a generic pool of objects which allocates the objects statically. <text:span text:style-name="T95">T</text:span>his is a reuse of the memory pool class from the previous chapters. I <text:span text:style-name="T85">am </text:span>skip<text:span text:style-name="T85">ping</text:span> the details here, <text:span text:style-name="T95">such as name for the pool, debug statistics.</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P101"><text:span text:style-name="T9">template</text:span><text:span text:style-name="T72">&lt;</text:span><text:span text:style-name="T9">typename</text:span><text:span text:style-name="T72"> </text:span><text:span text:style-name="T57">Lock</text:span><text:span text:style-name="T72">, </text:span><text:span text:style-name="T9">typename</text:span><text:span text:style-name="T72"> </text:span><text:span text:style-name="T57">ObjectType</text:span><text:span text:style-name="T72">, </text:span><text:span text:style-name="T40">size_t</text:span><text:span text:style-name="T72"> </text:span><text:span text:style-name="T57">Size</text:span><text:span text:style-name="T72">&gt;</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">MemoryPool</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">MemoryPool</text:span><text:span text:style-name="T18">();</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">~MemoryPool</text:span><text:span text:style-name="T18">() {}</text:span></text:p>
   <text:p text:style-name="P6"/>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">allocate</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> **obj);</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">free</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> *obj);</text:span></text:p>
   <text:p text:style-name="P6"/>
   <text:p text:style-name="P1"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">Stack</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T41">LockDummy</text:span><text:span text:style-name="T18">, <text:s/></text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T66">pool</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">objects</text:span><text:span text:style-name="T18">[</text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">];</text:span></text:p>
   <text:p text:style-name="P1"><text:span text:style-name="T18">};</text:span></text:p>
   <text:p text:style-name="P25"/>
   <text:p text:style-name="P58"><text:span text:style-name="T95">The stack keeps reference to the free (not allocated) objects. </text:span>The pool <text:span text:style-name="T95">constructor fills the stack of objects:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">&gt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T22">MemoryPool&lt;Lock, ObjectType, Size&gt;::MemoryPool</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">for</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> i = 0;i &lt; </text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">;i++) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">pool</text:span><text:span text:style-name="T18">.push(&amp;</text:span><text:span text:style-name="T66">objects</text:span><text:span text:style-name="T18">[i]);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>}</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18">}</text:span></text:p>
   <text:p text:style-name="P108"/>
   <text:p text:style-name="P104">Allocate and free methods call the stack pop and push API:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">&gt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">MemoryPool&lt;Lock, ObjectType, Size&gt;::allocate</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> **obj) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18"> lock;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>res = </text:span><text:span text:style-name="T66">pool</text:span><text:span text:style-name="T18">.pop(obj);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18">}</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">&gt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">MemoryPool&lt;Lock, ObjectType, Size&gt;::free</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> *obj) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18"> lock;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>res = </text:span><text:span text:style-name="T66">pool</text:span><text:span text:style-name="T18">.push(obj);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18">}</text:span></text:p>
   <text:p text:style-name="Text_20_body">A JobThread implements a “start” API and a static method with loop forever. More realistic implementations would add “wait for completion”, some mechanism for asynchronous notifications of the call<text:span text:style-name="T85">ing</text:span> context that the job is done, support for arguments <text:span text:style-name="T85">for</text:span> the job function.</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18"> &lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">JobType</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">JobThread</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">JobThread</text:span><text:span text:style-name="T18">();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">start</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">JobType</text:span><text:span text:style-name="T18"> *job);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T56">JobType</text:span><text:span text:style-name="T18"> *</text:span><text:span text:style-name="T66">job</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">xTaskHandle</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">pxCreatedTask</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">xQueueHandle</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">signal</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">mainLoop</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">JobThread</text:span><text:span text:style-name="T18"> *jobThread);</text:span></text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">JobThread constructor creates a binary semaphore and spawns <text:span text:style-name="T85">(</text:span>this specific choice of verb is based on “taskSpawn” which is a create task API in vxWorks<text:span text:style-name="T85">)</text:span> a new thread. I am assuming FreeRTOS API in this example, but any other API would work here:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">JobType</text:span><text:span text:style-name="T18">&gt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T22">JobThread&lt;JobType&gt;::JobThread</text:span><text:span text:style-name="T18">() : </text:span><text:span text:style-name="T66">job</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">nullptr</text:span><text:span text:style-name="T18">) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18"> *name = </text:span><text:span text:style-name="T51">&quot;a job&quot;</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>vSemaphoreCreateBinary(</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">signal</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>portBASE_TYPE res = xTaskCreate((</text:span><text:span text:style-name="T41">pdTASK_CODE</text:span><text:span text:style-name="T18">)</text:span><text:span text:style-name="T26">mainLoop</text:span><text:span text:style-name="T18">, (</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">signed</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18"> *)name, 300, </text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">, 1, &amp;</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">pxCreatedTask</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (res != pdPASS) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>cout &lt;&lt; </text:span><text:span text:style-name="T51">&quot;Failed to create a task&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">The thread entry, <text:span text:style-name="T85">the </text:span>mainLoop method, enters <text:span text:style-name="T85">the while loop </text:span>and waits for the binary semaphore. In the real code I would probably test an object variable “bool exitFlag” instead of <text:span text:style-name="T87">the condition which is </text:span>always true:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">JobType</text:span><text:span text:style-name="T18">&gt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">JobThread&lt;JobType&gt;::mainLoop</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">JobThread</text:span><text:span text:style-name="T18"> *jobThread) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">while</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T5">true</text:span><text:span text:style-name="T18">) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>xSemaphoreTake(jobThread-&gt;</text:span><text:span text:style-name="T66">signal</text:span><text:span text:style-name="T18">, portMAX_DELAY);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (jobThread-&gt;</text:span><text:span text:style-name="T66">job</text:span><text:span text:style-name="T18"> != </text:span><text:span text:style-name="T5">nullptr</text:span><text:span text:style-name="T18">) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/>jobThread-&gt;</text:span><text:span text:style-name="T66">job</text:span><text:span text:style-name="T18">-&gt;run();</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>jobThread-&gt;</text:span><text:span text:style-name="T66">job</text:span><text:span text:style-name="T18"> = </text:span><text:span text:style-name="T5">nullptr</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Method “start” sets the job pointer and wakes up the mainLoop:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">JobType</text:span><text:span text:style-name="T18">&gt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">JobThread&lt;JobType&gt;::start</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">JobType</text:span><text:span text:style-name="T18"> *job) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">job</text:span><text:span text:style-name="T18"> = job;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>xSemaphoreGive(</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">signal</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58"><text:span text:style-name="T85">In the</text:span> example <text:span text:style-name="T85">below</text:span> the code <text:span text:style-name="T85">prints</text:span> “Print job is running”:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">struct</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">PrintJob</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">run</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18">) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>cout &lt;&lt; </text:span><text:span text:style-name="T51">&quot;Print job is running&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T41">MemoryPool</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T41">LockDummy</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T41">JobThread</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T41">PrintJob</text:span><text:span text:style-name="T18">&gt;, 3&gt; jobThreads;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T41">PrintJob</text:span><text:span text:style-name="T18"> printJob;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">main</text:span><text:span text:style-name="T18">( </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> )</text:span></text:p>
   <text:p text:style-name="P22">{</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">JobThread</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T41">PrintJob</text:span><text:span text:style-name="T18">&gt; *jobThread;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>jobThreads.allocate(&amp;jobThread);</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>jobThread-&gt;start(&amp;printJob);</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P22"><text:s text:c="4"/>vTaskStartScheduler();</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T22"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> 1;</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:h text:style-name="P113" text:outline-level="2"/>
   <text:h text:style-name="P68" text:outline-level="2"><text:bookmark-start text:name="__RefHeading__13577_1195782936"/>Non static member.<text:bookmark-end text:name="__RefHeading__13577_1195782936"/></text:h>
   <text:p text:style-name="Quotations">&quot;C makes it easy to shoot yourself in the foot; C++ makes it harder, but when you do it blows your whole leg.</text:p>
   <text:p text:style-name="Quotations"/>
   <text:p text:style-name="Text_20_body">I am modifying only two lines in the code above. The call to xTaskCreate gets a pointer to a member function. <text:span text:style-name="T85">The C++</text:span> compiler warns about converting <text:span text:style-name="T85">of the address of the </text:span>method to a generic pointer:</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> *pMainLoop = (</text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18">*)&amp;</text:span><text:span text:style-name="T41">JobThread</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T56">JobType</text:span><text:span text:style-name="T18">&gt;::mainLoop;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18">portBASE_TYPE res = xTaskCreate((</text:span><text:span text:style-name="T41">pdTASK_CODE</text:span><text:span text:style-name="T18">)pMainLoop, (</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">signed</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18"> *)name, 300, </text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">, 1, &amp;</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">pxCreatedTask</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Main loop method is not a static method anymore and does not need any argument:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">JobType</text:span><text:span text:style-name="T18">&gt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">JobThread&lt;JobType&gt;::mainLoop</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">while</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T5">true</text:span><text:span text:style-name="T18">) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>xSemaphoreTake(</text:span><text:span text:style-name="T66">signal</text:span><text:span text:style-name="T18">, portMAX_DELAY);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T66">job</text:span><text:span text:style-name="T18"> != </text:span><text:span text:style-name="T5">nullptr</text:span><text:span text:style-name="T18">) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T66">job</text:span><text:span text:style-name="T18">-&gt;run();</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">job</text:span><text:span text:style-name="T18"> = </text:span><text:span text:style-name="T5">nullptr</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Text_20_body">The trick works because most (all?) C++ compilers push “this”, a pointer to the object, first to the arguments stack. The trick can fail if C and C++ code use stack frames differently. Pointers to virtual methods can fail too. This is always possible to use brute force – disassembly, and figure out how to call the member function correctly. <text:span text:style-name="T87">The implementation of the c</text:span>alls to virtual functions <text:span text:style-name="T87">differ widely between</text:span> compilers. Most C++ compilers replace the call to a virtual member <text:span text:style-name="T85">with</text:span> a small chunk of assembly code <text:span text:style-name="T85">which </text:span>calculates the method address.</text:p>
   <text:p text:style-name="Text_20_body">A reader of this text could ask what is the point behind this pointer‑to‑member exercise. When I run the application under a debugger, sometimes I want to set a break point using an absolute address. I can print an absolute address of a member and see in run‑time how many instances of the same method my generic class creates. Taking a pointer of a function insures that the function is not an “inline” function.</text:p>
   <text:h text:style-name="P71" text:outline-level="2"><text:bookmark-start text:name="__RefHeading__16996_386140696"/>Interprocess <text:span text:style-name="T90">c</text:span>ommunication.<text:bookmark-end text:name="__RefHeading__16996_386140696"/></text:h>
   <text:p text:style-name="P50">I hate threading anyway. Multiprocessing is the way to go, and message‑passing, not shared memory. That just doesn&apos;t scale. I use multithreading so I can use all of my 16 cores, or whatever is the average number of cores in a machine these days. Big furry deal. I&apos;ve got a few thousand servers waiting for me in the data center and how do I use those with threading? – <text:span text:style-name="T89">Alex Martelli.</text:span></text:p>
   <text:p text:style-name="P50"/>
   <text:p text:style-name="P95">The classical Interprocess Communication (IPC) design pattern is a mailbox or a message queue. The mailbox design pattern has gained popularity when Windows 3.11 and the first real‑time operating systems, such as RT Kernel and vxWorks, were a bleeding edge of the technology. Some operating systems support the message queue API. I am going to demonstrate a message queue that based on two primitives: a semaphore and a FIFO. </text:p>
   <text:p text:style-name="P95"/>
   <text:p text:style-name="P65">The mailbox API has two methods: send a message and wait for a message.</text:p>
   <text:p text:style-name="P35"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">&gt;</text:span></text:p>
   <text:p text:style-name="P35"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Mailbox</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="P35"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="P35"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">Mailbox</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18"> *name, </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> size);</text:span></text:p>
   <text:p text:style-name="P35"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18"> *</text:span><text:span text:style-name="T22">getName</text:span><text:span text:style-name="T18">() {</text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">name</text:span><text:span text:style-name="T18">;}</text:span></text:p>
   <text:p text:style-name="P35"/>
   <text:p text:style-name="P35"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">send</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> msg);</text:span></text:p>
   <text:p text:style-name="P35"/>
   <text:p text:style-name="P35"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">enum</text:span><text:span text:style-name="T18"> TIMEOUT {</text:span><text:span text:style-name="T67">NORMAL</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T67">NONE</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T67">FOREVER</text:span><text:span text:style-name="T18">};</text:span></text:p>
   <text:p text:style-name="P35"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">wait</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> *msg,</text:span></text:p>
   <text:p text:style-name="P35"><text:span text:style-name="T18"><text:s text:c="8"/>TIMEOUT waitType, </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> timeout);</text:span></text:p>
   <text:p text:style-name="P35"/>
   <text:p text:style-name="P35"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="P35"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18"> *</text:span><text:span text:style-name="T66">name</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P35"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">xQueueHandle</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">semaphore</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P35"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">CyclicBufferDynamic</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T66">fifo</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P26">};</text:p>
   <text:p text:style-name="P43"/>
   <text:p text:style-name="P83">The mailbox constructor employs the FreeRTOS counting semaphore:</text:p>
   <text:p text:style-name="P35"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">&gt;</text:span></text:p>
   <text:p text:style-name="P35"><text:span text:style-name="T22">Mailbox&lt;ObjectType, Lock&gt;::Mailbox</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18"> *name, </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> size) :</text:span></text:p>
   <text:p text:style-name="P35"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T66">fifo</text:span><text:span text:style-name="T18">(size),</text:span></text:p>
   <text:p text:style-name="P35"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T66">name</text:span><text:span text:style-name="T18">(name) {</text:span></text:p>
   <text:p text:style-name="P35"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T66">semaphore</text:span><text:span text:style-name="T18"> = xSemaphoreCreateCounting(size+1, 0);</text:span></text:p>
   <text:p text:style-name="P26">}</text:p>
   <text:p text:style-name="P43"/>
   <text:p text:style-name="P83">The send method adds a message to the FIFO and bumps the semaphore:</text:p>
   <text:p text:style-name="P43"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">&gt;</text:span></text:p>
   <text:p text:style-name="P5"><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">Mailbox&lt;ObjectType, Lock&gt;::send</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> msg) {</text:span></text:p>
   <text:p text:style-name="P5"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="P5"><text:span text:style-name="T18"><text:s text:c="4"/>res = </text:span><text:span text:style-name="T66">fifo</text:span><text:span text:style-name="T18">.add(msg);</text:span></text:p>
   <text:p text:style-name="P5"><text:span text:style-name="T18"><text:s text:c="4"/>xSemaphoreGive(</text:span><text:span text:style-name="T66">semaphore</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="P5"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="P10">}</text:p>
   <text:p text:style-name="P43"/>
   <text:p text:style-name="P83">Receive message handles different types of the timeout:</text:p>
   <text:p text:style-name="P43"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">&gt;</text:span></text:p>
   <text:p text:style-name="P5"><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">Mailbox&lt;ObjectType, Lock&gt;::wait</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> *msg,</text:span></text:p>
   <text:p text:style-name="P5"><text:span text:style-name="T18"><text:s text:c="8"/>TIMEOUT waitType, </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> timeout) {</text:span></text:p>
   <text:p text:style-name="P5"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> res = </text:span><text:span text:style-name="T5">false</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P10"><text:s text:c="4"/>portBASE_TYPE semaphoreRes = pdFALSE;</text:p>
   <text:p text:style-name="P5"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">while</text:span><text:span text:style-name="T18"> (semaphoreRes == pdFALSE) {</text:span></text:p>
   <text:p text:style-name="P5"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (waitType == TIMEOUT::</text:span><text:span text:style-name="T67">FOREVER</text:span><text:span text:style-name="T18">) {</text:span></text:p>
   <text:p text:style-name="P5"><text:span text:style-name="T18"><text:s text:c="12"/>semaphoreRes = xSemaphoreTake(</text:span><text:span text:style-name="T66">semaphore</text:span><text:span text:style-name="T18">, portMAX_DELAY);</text:span></text:p>
   <text:p text:style-name="P10"><text:s text:c="8"/>}</text:p>
   <text:p text:style-name="P5"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (waitType == TIMEOUT::</text:span><text:span text:style-name="T67">NORMAL</text:span><text:span text:style-name="T18">) {</text:span></text:p>
   <text:p text:style-name="P5"><text:span text:style-name="T18"><text:s text:c="12"/>semaphoreRes = xSemaphoreTake(</text:span><text:span text:style-name="T66">semaphore</text:span><text:span text:style-name="T18">, timeout);</text:span></text:p>
   <text:p text:style-name="P5"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T5">break</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P10"><text:s text:c="8"/>}</text:p>
   <text:p text:style-name="P5"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="P5"><text:span text:style-name="T18"><text:s text:c="12"/>semaphoreRes = xSemaphoreTake(</text:span><text:span text:style-name="T66">semaphore</text:span><text:span text:style-name="T18">, 0);</text:span></text:p>
   <text:p text:style-name="P5"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T5">break</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P10"><text:s text:c="8"/>}</text:p>
   <text:p text:style-name="P10"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P7"/>
   <text:p text:style-name="P5"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> ((semaphoreRes == pdTRUE) &amp;&amp; !</text:span><text:span text:style-name="T66">fifo</text:span><text:span text:style-name="T18">.isEmpty()) {</text:span></text:p>
   <text:p text:style-name="P5"><text:span text:style-name="T18"><text:s text:c="8"/>res = </text:span><text:span text:style-name="T66">fifo</text:span><text:span text:style-name="T18">.remove(msg);</text:span></text:p>
   <text:p text:style-name="P10"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P7"/>
   <text:p text:style-name="P5"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="P10">}</text:p>
   <text:p text:style-name="P43"/>
   <text:p text:style-name="P83">In the example application an interrupt (a producer) reads data from the UART devices, and sends the collected data to the processing task (a consumer). My message object contains two things: a message event and some data. The consumer task is expected to switch by the message event:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">enum</text:span><text:span text:style-name="T18"> EVENT {</text:span><text:span text:style-name="T67">UART0</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T67">UART1</text:span><text:span text:style-name="T18">};</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">typedef</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">struct</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">enum</text:span><text:span text:style-name="T18"> EVENT </text:span><text:span text:style-name="T66">event</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">data</text:span><text:span text:style-name="T18">[32];</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">dataSize</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18">} </text:span><text:span text:style-name="T41">Message</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P41"/>
   <text:p text:style-name="P43"/>
   <text:p text:style-name="P83">In the example below I reuse the memory pool from the previous chapter:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T41">MemoryPool</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T41">LockDummy</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T41">Message</text:span><text:span text:style-name="T18">, 3&gt; pool;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T41">Mailbox</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T41">Message</text:span><text:span text:style-name="T18">*, </text:span><text:span text:style-name="T41">LockDummy</text:span><text:span text:style-name="T18">&gt; myMailbox(</text:span><text:span text:style-name="T51">&quot;</text:span><text:span text:style-name="T53">mbx</text:span><text:span text:style-name="T51">&quot;</text:span><text:span text:style-name="T18">, 3);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T8">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T23">rxTask</text:span><text:span text:style-name="T18">( </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> ) </text:span><text:span text:style-name="T21">{</text:span></text:p>
   <text:p text:style-name="P26"><text:s text:c="4"/>myMailbox.wait(&amp;message, </text:p>
   <text:p text:style-name="P35"><text:span text:style-name="T18"><text:s text:c="6"/>myMailbox.TIMEOUT::</text:span><text:span text:style-name="T67">FOREVER</text:span><text:span text:style-name="T18">, 0);</text:span></text:p>
   <text:p text:style-name="P26"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>cout &lt;&lt; </text:span><text:span text:style-name="T51">&quot;data=&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; </text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="7"/>message-&gt;</text:span><text:span text:style-name="T66">data</text:span><text:span text:style-name="T18"> &lt;&lt; </text:span><text:span text:style-name="T51">&quot;, event=&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; </text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="7"/>message-&gt;</text:span><text:span text:style-name="T66">event</text:span><text:span text:style-name="T18"> &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"/>
   <text:p text:style-name="P22"><text:s text:c="4"/>pool.free(message);</text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">main</text:span><text:span text:style-name="T18">( </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> ) </text:span><text:span text:style-name="T21">{</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T41"><text:s text:c="4"/>Message</text:span><text:span text:style-name="T18"> *message;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>pool.allocate(&amp;message);</text:p>
   <text:p text:style-name="P22"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>message-&gt;</text:span><text:span text:style-name="T66">data</text:span><text:span text:style-name="T18">[0] = 0x30;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>message-&gt;</text:span><text:span text:style-name="T66">dataSize</text:span><text:span text:style-name="T18"> = 1;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>message-&gt;</text:span><text:span text:style-name="T66">event</text:span><text:span text:style-name="T18"> = EVENT::</text:span><text:span text:style-name="T67">UART0</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"/>
   <text:p text:style-name="P22"><text:s text:c="4"/>myMailbox.send(message);</text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="P96"><text:span text:style-name="T90">In many cases a modern firmware developer will use a “pipeline”. </text:span>A “pipeline is a set of data processing elements connected in series, where the output of one element is the input of the next one” <text:span text:style-name="T90">(Wikipedia)</text:span>. <text:span text:style-name="T90">A processing element, for example a thread, wakes up and checks the mailbox – the job queue. If the queue is not empty, the thread executes one stage of processing and forwards the processed data to the next thread in the pipeline. </text:span></text:p>
   <text:p text:style-name="P96"/>
   <text:p text:style-name="P65">The pipeline task has two methods: add a new job and process the data. <text:span text:style-name="T95">A pipeline task – a</text:span> stage – has a name and keeps a reference to the next stage:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">, std::</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">&gt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">PipelineTask</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="P35"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">PipelineTask</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18"> *name, </text:span></text:p>
   <text:p text:style-name="P35"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">PipelineTask</text:span><text:span text:style-name="T18"> *nextStage = </text:span><text:span text:style-name="T5">nullptr</text:span><text:span text:style-name="T18">) :</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">name</text:span><text:span text:style-name="T18">(name),</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">nextStage</text:span><text:span text:style-name="T18">(nextStage){}</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">doJob</text:span><text:span text:style-name="T18">();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">addJob</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> &amp;data);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18"> *</text:span><text:span text:style-name="T66">name</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">PipelineTask</text:span><text:span text:style-name="T18"> *</text:span><text:span text:style-name="T66">nextStage</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">CyclicBuffer</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T66">fifo</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P96"/>
   <text:p text:style-name="P103">The add job API adds data to the FIFO:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">, std::</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">&gt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">PipelineTask&lt;ObjectType, Lock, Size&gt;::addJob</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> &amp;data) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T66">fifo</text:span><text:span text:style-name="T18">.add(data);</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="P95"/>
   <text:p text:style-name="P65">The method doJob() fetches data from the FIFO, increments it – I assume that the data type supports operator++(), pushes the data to the next stage: </text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">, std::</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Size</text:span><text:span text:style-name="T18">&gt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">PipelineTask&lt;ObjectType, Lock, Size&gt;::doJob</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">while</text:span><text:span text:style-name="T18"> (!</text:span><text:span text:style-name="T66">fifo</text:span><text:span text:style-name="T18">.isEmpty()) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> data;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">fifo</text:span><text:span text:style-name="T18">.remove(data);</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>data++;</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>cout &lt;&lt; </text:span><text:span text:style-name="T51">&quot;Stage:&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; </text:span><text:span text:style-name="T66">name</text:span><text:span text:style-name="T18"> &lt;&lt; </text:span><text:span text:style-name="T51">&quot;, data=&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; data &lt;&lt; endl;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">nextStage</text:span><text:span text:style-name="T18">-&gt;addJob(data);</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="P95"/>
   <text:p text:style-name="P65">A new type MyPipelineTask:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">typedef</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">PipelineTask</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T41">LockDummy</text:span><text:span text:style-name="T18">, 3&gt; </text:span><text:span text:style-name="T41">MyPipelineTask</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Text_20_body">Three stages of the pipeline – <text:span text:style-name="T92">the third last stage does not have a “next”</text:span>:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T41">MyPipelineTask</text:span><text:span text:style-name="T18"> pipelineTask3(</text:span><text:span text:style-name="T51">&quot;3&quot;</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T41">MyPipelineTask</text:span><text:span text:style-name="T18"> pipelineTask2(</text:span><text:span text:style-name="T51">&quot;2&quot;</text:span><text:span text:style-name="T18">, &amp;pipelineTask3);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T41">MyPipelineTask</text:span><text:span text:style-name="T18"> pipelineTask1(</text:span><text:span text:style-name="T51">&quot;1&quot;</text:span><text:span text:style-name="T18">, &amp;pipelineTask2);</text:span></text:p>
   <text:p text:style-name="Text_20_body">I can <text:span text:style-name="T90">invoke stages of the pipeline from interrupts or from a main loop, for example, like this:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">testPipeline</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> data = 0;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>pipelineTask1.addJob(data);</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>pipelineTask1.doJob();</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>pipelineTask2.doJob();</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>pipelineTask3.doJob();</text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="P95">The code above generates the output:</text:p>
   <text:p text:style-name="Preformatted_20_Text">Stage:1, data=1 </text:p>
   <text:p text:style-name="Preformatted_20_Text">Stage:2, data=2 </text:p>
   <text:p text:style-name="Preformatted_20_Text">Stage:3, data=3 </text:p>
   <text:p text:style-name="P95">The pipeline paradigm can improve utilization of the CPU, pipelines make it easier to leverage multi‑core systems.</text:p>
   <text:p text:style-name="P95"/>
   <text:h text:style-name="P68" text:outline-level="2"><text:bookmark-start text:name="__RefHeading__14433_1195782936"/>Log.<text:bookmark-end text:name="__RefHeading__14433_1195782936"/></text:h>
   <text:p text:style-name="Quotations">Perfection is achieved, not when there is nothing left to add, but when there is nothing left to take away – Antoine de St. Exupery</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="Text_20_body">In one C project I have seen following code for generating log entries:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">enum</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T67">LOG_LEVEL_INFO</text:span><text:span text:style-name="T18">,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T67">LOG_LEVEL_ERROR</text:span><text:span text:style-name="T18">,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T67">LOG_LEVEL_LAST</text:span><text:span text:style-name="T18">,</text:span></text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18"> *LOG_LEVEL_NAME[] = {</text:span><text:span text:style-name="T51">&quot;INFO&quot;</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T51">&quot;ERROR&quot;, “UKNOWN”</text:span><text:span text:style-name="T18">};</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">#define</text:span><text:span text:style-name="T18"> LOG_INFO(fmt, ...) log_print(__LINE__, LOG_LEVEL_INFO, fmt, </text:span><text:span text:style-name="T5">##</text:span><text:span text:style-name="T18">__VA_ARGS__ )</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#define</text:span><text:span text:style-name="T18"> LOG_ERROR(fmt, ...) log_print(__LINE__, LOG_LEVEL_ERROR, fmt, </text:span><text:span text:style-name="T5">##</text:span><text:span text:style-name="T18">__VA_ARGS__ )</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">log_print</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> line, </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> level, </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18"> *fmt, ...)</text:span></text:p>
   <text:p text:style-name="P22">{</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">va_list</text:span><text:span text:style-name="T18"> ap;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T55">printf</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T51">&quot;%s: line=%d, </text:span><text:span text:style-name="T53">msg</text:span><text:span text:style-name="T51">=&quot;</text:span><text:span text:style-name="T18">, LOG_LEVEL_NAME[level], line);</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>va_start(ap, fmt);</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T55">vprintf</text:span><text:span text:style-name="T18">(fmt, ap);</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>va_end(ap);</text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">testLog</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18">) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>LOG_INFO(</text:span><text:span text:style-name="T51">&quot;This is info %d&quot;</text:span><text:span text:style-name="T18">, 1);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>LOG_ERROR(</text:span><text:span text:style-name="T51">&quot;This is error %d&quot;</text:span><text:span text:style-name="T18">, 2);</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">On my machine the code above generates output:</text:p>
   <text:p text:style-name="Preformatted_20_Text">INFO: line=402, msg=This is info 1</text:p>
   <text:p text:style-name="Preformatted_20_Text">ERROR: line=403, msg=This is error 2</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">There are many calls to the log API and size of the image is important. Calls to log_print() push at least three arguments <text:span text:style-name="T85">in</text:span>to the stack. I think that I can save one push – <text:span text:style-name="T85">a </text:span>log level. In <text:span text:style-name="T85">the </text:span>C <text:span text:style-name="T85">implementation </text:span>I would add functions log_print_info(...) and log_print_error(...) which in turn call log_print(), and fix the macros accordingly. In C++ I have a template. <text:span text:style-name="T85">The c</text:span>onstructor is an exact copy of the original log_print function minus log level:</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18"> &lt;</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Level</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Log</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">Log</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> line, </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18"> *fmt, ...) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">va_list</text:span><text:span text:style-name="T18"> ap;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T55">printf</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T51">&quot;%s: line=%d, </text:span><text:span text:style-name="T53">msg</text:span><text:span text:style-name="T51">=&quot;</text:span><text:span text:style-name="T18">, LOG_LEVEL_NAME[</text:span><text:span text:style-name="T56">Level</text:span><text:span text:style-name="T18">], line);</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>va_start(ap, fmt);</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T55">vprintf</text:span><text:span text:style-name="T18">(fmt, ap);</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>va_end(ap);</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58"><text:span text:style-name="T85">The l</text:span>og macros call the constructor:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#define</text:span><text:span text:style-name="T18"> LOG_INFO(fmt, ...) Log&lt;LOG_LEVEL_INFO&gt;(__LINE__, fmt, </text:span><text:span text:style-name="T5">##</text:span><text:span text:style-name="T18">__VA_ARGS__ )</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#define</text:span><text:span text:style-name="T18"> LOG_ERROR(fmt, ...) Log&lt;LOG_LEVEL_ERROR&gt;(__LINE__, fmt, </text:span><text:span text:style-name="T5">##</text:span><text:span text:style-name="T18">__VA_ARGS__ )</text:span></text:p>
   <text:p text:style-name="P88">C++ compiler has duplicated two print log functions for me and saved a push to the stack for every call to the log API. I could save 512 bytes of the stack by using a static buffer (and <text:span text:style-name="T85">the l</text:span>ock I have demonstrated earlier). Class log is a “functoid – <text:span text:style-name="T85">it is </text:span>a function on steroids. I can use a functoid based on a regular class instead of a template like this:</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Log</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">Log</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18"> *level) : </text:span><text:span text:style-name="T66">level</text:span><text:span text:style-name="T18">(level) {}</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">print</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> line, </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18"> *fmt, ...) </text:span><text:span text:style-name="T5">const </text:span><text:span text:style-name="T18">{</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">va_list</text:span><text:span text:style-name="T18"> ap;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T55">printf</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T51">&quot;%s: line=%d, </text:span><text:span text:style-name="T53">msg</text:span><text:span text:style-name="T51">=&quot;</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T66">level</text:span><text:span text:style-name="T18">, line);</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>va_start(ap, fmt);</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T55">vprintf</text:span><text:span text:style-name="T18">(fmt, ap);</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>va_end(ap);</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18"> *</text:span><text:span text:style-name="T66">level</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Log</text:span><text:span text:style-name="T18"> LogInfo(</text:span><text:span text:style-name="T51">&quot;INFO&quot;</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Log</text:span><text:span text:style-name="T18"> LogError(</text:span><text:span text:style-name="T51">&quot;ERROR&quot;</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#define</text:span><text:span text:style-name="T18"> LOG_INFO(fmt, ...) LogInfo.print(__LINE__, fmt, </text:span><text:span text:style-name="T5">##</text:span><text:span text:style-name="T18">__VA_ARGS__ )</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#define</text:span><text:span text:style-name="T18"> LOG_ERROR(fmt, ...) LogError.print(__LINE__, fmt, </text:span><text:span text:style-name="T5">##</text:span><text:span text:style-name="T18">__VA_ARGS__ )</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P58">I dropped array LOG_LEVEL_NAME <text:span text:style-name="T85">and</text:span> now it is easier to expand an enumeration of log levels. There is only one instance of the print function in the object code. The cost is a couple of words in the data RAM <text:span text:style-name="T85">or</text:span> two objects of <text:span text:style-name="T85">the </text:span>type Log. The code and the data can be placed in <text:span text:style-name="T85">the </text:span>ROM.</text:p>
   <text:p text:style-name="Text_20_body">Call to vprintf() is not something firmware developers do often. Indeed the code calls vprintf() again and again for the same set of format strings. I can send to the console only the arguments to the vprintf() <text:span text:style-name="T85">and</text:span> the exact location in the source code or <text:span text:style-name="T85">the </text:span>offset in the object file. </text:p>
   <text:p text:style-name="Text_20_body">Class BinaryLog below handles only arguments of type “int”. A location in the source code is defined by <text:span text:style-name="T85">a </text:span>“unique” file identifier and <text:span text:style-name="T85">a </text:span>source line number:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">BinaryLog</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">BinaryLog</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> fileId, </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> line, </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> count, ...);</text:span></text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Text_20_body">I assume that there is “sendData” API which can send arbitrary number of integers to the console: </text:p>
   <text:p text:style-name="P72"><text:span text:style-name="T22">BinaryLog::BinaryLog</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> fileId, </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> line, </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> count, ...) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> HEADER_SIZE = 3;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> header[HEADER_SIZE];</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P22"><text:s text:c="4"/>header[0] = fileId;</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>header[1] = line;</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>header[2] = count;</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>sendDataStart();</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>sendData(header, HEADER_SIZE);</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">va_list</text:span><text:span text:style-name="T18"> ap;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>va_start(ap, count);</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">for</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> j=0; j &lt; count; j++) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> arg = va_arg(ap, </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>sendData(arg);</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>va_end(ap);</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>sendDataEnd();</text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Text_20_body">API “send data” in my simulation environment looks like this:</text:p>
   <text:p text:style-name="Standard"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">inline void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">sendData</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> data) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>cout &lt;&lt; dec &lt;&lt; data &lt;&lt; </text:span><text:span text:style-name="T51">&quot; &quot;</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">inline void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">sendDataStart</text:span><text:span text:style-name="T18">() {cout &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;}</text:span></text:p>
   <text:p text:style-name="P22"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">inline void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">sendDataEnd</text:span><text:span text:style-name="T18">() {cout &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;}</text:span></text:p>
   <text:p text:style-name="P22"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">sendData</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> *data, </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> count) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">for</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> i = 0;i &lt; count;i++) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>cout &lt;&lt; hex &lt;&lt; data[i] &lt;&lt; </text:span><text:span text:style-name="T51">&quot; &quot;</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P58">Two macro definitions call constructor BinaryLog. Macro ARGUMENTS_COUNT is fairly portable <text:span text:style-name="T85">and</text:span> shall return number of arguments in a variadic macro:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#define</text:span><text:span text:style-name="T18"> ARGUMENTS_COUNT(...) (</text:span><text:span text:style-name="T5">sizeof</text:span><text:span text:style-name="T18">((</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18">[]){__VA_ARGS__})/</text:span><text:span text:style-name="T5">sizeof</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18">))</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#define</text:span><text:span text:style-name="T18"> LOG_INFO(fmt, ...) BinaryLog(FILE_ID, __LINE__, ARGUMENTS_COUNT(__VA_ARGS__), __VA_ARGS__ )</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#define</text:span><text:span text:style-name="T18"> LOG_ERROR(fmt, ...) BinaryLog(FILE_ID, __LINE__, ARGUMENTS_COUNT(__VA_ARGS__), __VA_ARGS__ )</text:span></text:p>
   <text:p text:style-name="P22"/>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P66"><text:span text:style-name="T85">The f</text:span>ile identifier is generated <text:span text:style-name="T85">by the compiler </text:span>from the file name during <text:span text:style-name="T95">the build</text:span>. I use a simple hash function. A real thing, <text:span text:style-name="T95">an </text:span>MD5 hash, can be found in <text:a xlink:type="simple" xlink:href="https://github.com/mfontanini/Programs-Scripts/tree/master/constexpr_hashes">https://github.com/mfontanini/Programs-Scripts/tree/master/constexpr_hashes</text:a></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T11">constexpr</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T11">int</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T29">hashData</text:span><text:span text:style-name="T16">(</text:span><text:span text:style-name="T11">const</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T11">char</text:span><text:span text:style-name="T16">* s, </text:span><text:span text:style-name="T11">int</text:span><text:span text:style-name="T16"> accumulator) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T16"><text:s text:c="4"/></text:span><text:span text:style-name="T11">return</text:span><text:span text:style-name="T16"> *s ? hashData(s + 1, (accumulator &lt;&lt; 1) | *s) : accumulator;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T11">constexpr</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T11">int</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T29">hashMetafunction</text:span><text:span text:style-name="T16">(</text:span><text:span text:style-name="T11">const</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T11">char</text:span><text:span text:style-name="T16">* s) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T16"><text:s text:c="4"/></text:span><text:span text:style-name="T11">return</text:span><text:span text:style-name="T16"> hashData(s, 0);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T11">constexpr</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T11">int</text:span><text:span text:style-name="T16"> FILE_ID = hashMetafunction(__FILE__);</text:span></text:p>
   <text:p text:style-name="P85"/>
   <text:p text:style-name="P59">Usage example:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T11">void</text:span><text:span text:style-name="T16"> </text:span><text:span text:style-name="T29">testBinaryLog</text:span><text:span text:style-name="T16">(</text:span><text:span text:style-name="T11">void</text:span><text:span text:style-name="T16">) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T16"><text:s text:c="4"/>LOG_INFO(</text:span><text:span text:style-name="T50">&quot;This is info %d %d&quot;</text:span><text:span text:style-name="T16">, 1, 2);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T16"><text:s text:c="4"/>LOG_ERROR(</text:span><text:span text:style-name="T50">&quot;This is error %d %d %d&quot;</text:span><text:span text:style-name="T16">, 0, 1, 2);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="P85"/>
   <text:p text:style-name="P105">In my system the test function produces output:</text:p>
   <text:p text:style-name="Preformatted_20_Text">262140 511 2 1 2 262140 512 3 0 1 2</text:p>
   <text:p text:style-name="P109">All I need now is a short (Python?) script <text:span text:style-name="T85">that</text:span> calculates file identifiers for all my source files, find<text:span text:style-name="T85">s</text:span> the right file according to the file identifier 262140, parses lines 511 and 512 in the C++ file and produces two readable output lines:</text:p>
   <text:p text:style-name="P21">This is info 1 2 </text:p>
   <text:p text:style-name="P21">This is error 0 1 2 </text:p>
   <text:p text:style-name="Text_20_body">Yet another post build script can ensure that format strings correctly represent arguments in calls to the macros. </text:p>
   <text:p text:style-name="Text_20_body">By removing an expensive call to vprintf() I saved lot of CPU cycles, lot of ROM and some bandwidth. The binary log API does not use any static data and the API is thread safe. My system generates logs which require additional processing before they can be read by a human, but there are situations when this is <text:span text:style-name="T95">a </text:span>small price to pay. </text:p>
   <text:p text:style-name="Text_20_body"><text:span text:style-name="T85">In the next example </text:span>I assume that the application is statically linked and all addresses <text:span text:style-name="T85">are getting </text:span>resolved at build time. I can get rid of the line number and file identifier and, <text:span text:style-name="T85">instead, </text:span>use value of the program counter. Code below will work only for GCC. GCC compiler allows to get <text:span text:style-name="T85">the </text:span>address of a label. </text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58"><text:span text:style-name="T85">The BinaryLog c</text:span>onstructor accepts <text:span text:style-name="T85">an </text:span>address of the log entr<text:span text:style-name="T85">y</text:span>:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T73">BinaryLog::BinaryLog</text:span><text:span text:style-name="T72">(</text:span><text:span text:style-name="T9">void</text:span><text:span text:style-name="T72"> *address, </text:span><text:span text:style-name="T9">int</text:span><text:span text:style-name="T72"> line, </text:span><text:span text:style-name="T9">int</text:span><text:span text:style-name="T72"> count, ...) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> HEADER_SIZE = 2;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> header[HEADER_SIZE];</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>header[0] = ((</text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18">)address) &amp; INTMAX_MAX;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>header[1] = count;</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>sendDataStart();</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>sendData(header, HEADER_SIZE);</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">va_list</text:span><text:span text:style-name="T18"> ap;</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>va_start(ap, count);</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">for</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> j=0; j &lt; count; j++) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> arg = va_arg(ap, </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>sendData(arg);</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>va_end(ap);</text:p>
   <text:p text:style-name="P22"><text:s text:c="4"/>sendDataEnd();</text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="P40"/>
   <text:p text:style-name="Standard"/>
   <text:p text:style-name="P58"><text:span text:style-name="T85">The m</text:span>agic macros generate unique labels and forward the labels address to the BinaryLog constructor:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#define</text:span><text:span text:style-name="T18"> TOKEN_CAT(x, y) x </text:span><text:span text:style-name="T5">##</text:span><text:span text:style-name="T18"> y</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#define</text:span><text:span text:style-name="T18"> TOKEN_CAT2(x, y) TOKEN_CAT(x, y)</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#define</text:span><text:span text:style-name="T18"> LABEL TOKEN_CAT2 (logLabel_, __LINE__)</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T9">#define</text:span><text:span text:style-name="T72"> LOG_INFO(fmt, ...) { <text:s/>\</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>LABEL:\</text:p>
   <text:p text:style-name="P22"><text:s text:c="8"/>BinaryLog(&amp;&amp;LABEL, __LINE__, ARGUMENTS_COUNT(__VA_ARGS__), __VA_ARGS__ ); \</text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Text_20_body">A post build script shall read a map file generated by the linker, collect list of labels according to the pattern logLabel_XX and process format strings in the source code.</text:p>
   <text:p text:style-name="Text_20_body"><text:span text:style-name="T85">It is not done yet. </text:span>I can save one <text:span text:style-name="T85">more </text:span>argument – <text:span text:style-name="T85">an</text:span> address of the label. GCC allows to find out <text:span text:style-name="T95">a </text:span>return address of the function. <text:span text:style-name="T85">The functoid can look like this:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">FastLog</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">FastLog</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> count, ...);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18">};</text:span></text:p>
   <text:p text:style-name="P108"/>
   <text:p text:style-name="P106"><text:span text:style-name="T95">The FastLog constructor calls</text:span> __builtin_return_address() <text:span text:style-name="T95">to get the return address:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T73">FastLog::FastLog</text:span><text:span text:style-name="T72">(</text:span><text:span text:style-name="T9">int</text:span><text:span text:style-name="T72"> count, ...) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> HEADER_SIZE = 2;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> header[HEADER_SIZE];</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> *retAddress =</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="7"/>__builtin_extract_return_addr(</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="7"/>__builtin_return_address(0));</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>header[0] = ((</text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18">)retAddress) &amp; INTMAX_MAX;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>header[1] = count;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>sendDataStart();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>sendData(header, 2);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">va_list</text:span><text:span text:style-name="T18"> ap;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>va_start(ap, count);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">for</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> j=0; j &lt; count; j++) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> arg = va_arg(ap, </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>sendData(arg);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>}</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>va_end(ap);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>sendDataEnd();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18">}</text:span></text:p>
   <text:p text:style-name="P22"><text:span text:style-name="T72"/></text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">And the macros do not forward <text:span text:style-name="T95">an </text:span>address anymore:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">#define</text:span><text:span text:style-name="T18"> LOG_INFO(fmt, ...)\</text:span></text:p>
   <text:p text:style-name="P22"><text:s text:c="2"/>FastLog(ARGUMENTS_COUNT(__VA_ARGS__), __VA_ARGS__ );</text:p>
   <text:p text:style-name="P108">If I need to support two or more configurable destinations – log sinks – I need only to add to the functoid FastLoad a method which switches the destination. The logic of the code remains encapsulated in the class. They say in the academic world that the encapsulation is a good thing.</text:p>
   <text:p text:style-name="P108"/>
   <text:h text:style-name="P113" text:outline-level="2"/>
   <text:h text:style-name="P68" text:outline-level="2"><text:bookmark-start text:name="__RefHeading__14278_363426044"/>Software Timers.<text:bookmark-end text:name="__RefHeading__14278_363426044"/></text:h>
   <text:p text:style-name="Quotations">C++: Hard to learn and built to stay that way.</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="Text_20_body">So far I have demonstrated fairly simple software components, <text:span text:style-name="T85">such as</text:span> a mutex or a cyclic buffer. In this chapter I am going to implement a software timer.</text:p>
   <text:p text:style-name="Text_20_body">Modern operating systems provide timers API. Typically an application can start a timer with arbitrary expiration time. When the timer expires the operating system calls the application hook from a dedicated timer thread or a system interrupt. Performance of such API can degrade quickly if an application starts a lot of different timers. There is usually no control over the priority of the process which handles the timers. The API presented here allows an application to handle all timer related code in a single context or in multiple contexts running with different priorities.</text:p>
   <text:p text:style-name="Text_20_body">The software timers API will have O(1) complexity. The API is going to be thread safe. The source code for the software timer can be found in <text:a xlink:type="simple" xlink:href="https://github.com/larytet/emcpp/blob/master/src/timers.cpp">https://github.com/larytet/emcpp/blob/master/src/Timers.h</text:a></text:p>
   <text:p text:style-name="Text_20_body"><text:span text:style-name="T85">Y</text:span>ou <text:span text:style-name="T85">already </text:span>know the object‑oriented design routine. Let&apos;s declare a timer object first. A timer object keeps a unique timer identifier. </text:p>
   <text:p text:style-name="Text_20_body">A unique timer identifier can be used to solve possible race conditions between stopTimer and timerExpired. Consider following scenario: timer “a” is started by context A. Timer “a” is stopped by context A, but too late ‑ timer “a” has just expired and the application code handl<text:span text:style-name="T85">ing</text:span> the expiration is running. Depending on the implementation of the application callback the processing of the event can be done asynchronously. Meanwhile the same timer object can be allocated and modified by context B, a different thread. If context A keeps identities of all started timers, the application callback can check if the timer identifier is on the list of running timers. If the timer was stopped, the callback can ignore the timer expiration. Using <text:span text:style-name="T85">the reference to</text:span> the timer object itself for such bookkeeping is not good because <text:span text:style-name="T85">the </text:span>pool of timer objects is probably a shared resource.</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">When starting a timer the user can supply optional pointer to the application data, a cookie. <text:span text:style-name="T85">The t</text:span>imer class could be a template like this:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">CookieType</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Timer</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T56">CookieType</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">cookie</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">};</text:p>
   <text:p text:style-name="Text_20_body">I want to simplify the interface and avoid using of virtual methods – more on virtual methods in a moment – in the timer objects. Instead of objects of an arbitrary type a timer object will keep a pointer to the application data. </text:p>
   <text:p text:style-name="Text_20_body">A user can access the timer&apos;s data only via the public methods: getters and setters. This approach helps to maintain the code in the future. </text:p>
   <text:p text:style-name="Text_20_body"><text:span text:style-name="T85">The c</text:span>lass Timer implements a constructor without arguments. I want to be able to create a static array of timers with<text:span text:style-name="T85">out</text:span> too much of trouble. <text:span text:style-name="T85">The TimerList class, which is not declared yet, is a friend class of the class Timer and can call protected methods of the Timer. Method start() is protected, because application shall start timers using the TimerList methods.</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Timer</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">Timer</text:span><text:span text:style-name="T18">();</text:span></text:p>
   <text:p text:style-name="P32"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">stop</text:span><text:span text:style-name="T18">();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">isRunning</text:span><text:span text:style-name="T18">() </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P32"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">TimerID</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">getId</text:span><text:span text:style-name="T18">() </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P32"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">getApplicationData</text:span><text:span text:style-name="T18">() </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P32"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">getStartTime</text:span><text:span text:style-name="T18">() </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P24"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">friend</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">TimerList</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">TimerID</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">id</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">applicationData</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">running</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">startTime</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="P32"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">start</text:span><text:span text:style-name="T18">();</text:span></text:p>
   <text:p text:style-name="P32"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">setApplicationData</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> applicationData);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">setId</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">TimerID</text:span><text:span text:style-name="T18"> id);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">setStartTime</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> systemTime);</text:span></text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P58"><text:span text:style-name="T85">The i</text:span>mplementation of the methods is straightforward:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T22">Timer::Timer</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>stop();</text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T41">TimerID</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">Timer::getId</text:span><text:span text:style-name="T18">() </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">id</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">Timer::getStartTime</text:span><text:span text:style-name="T18">() </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">startTime</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">Timer::isRunning</text:span><text:span text:style-name="T18">() </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">running</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">Timer::stop</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T66">running</text:span><text:span text:style-name="T18"> = </text:span><text:span text:style-name="T5">false</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> <text:s/></text:span><text:span text:style-name="T22">Timer::start</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T66">running</text:span><text:span text:style-name="T18"> = </text:span><text:span text:style-name="T5">true</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">Timer::setApplicationData</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> applicationData) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">applicationData</text:span><text:span text:style-name="T18"> = applicationData;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">Timer::getApplicationData</text:span><text:span text:style-name="T18">() </text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">applicationData</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">Timer::setId</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">TimerID</text:span><text:span text:style-name="T18"> id) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">id</text:span><text:span text:style-name="T18"> = id;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">Timer::setStartTime</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> systemTime) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">startTime</text:span><text:span text:style-name="T18"> = systemTime;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58"><text:span text:style-name="T85">The s</text:span>ystem time is often a tick incremented by an interrupt or read from the hardware. In this example I use size_t type. In a more advanced design <text:span text:style-name="T85">the </text:span>System Time <text:span text:style-name="T85">type </text:span>and <text:span text:style-name="T85">the </text:span>Timeout <text:span text:style-name="T85">type </text:span>could be two classes. The timer API only needs a function with <text:span text:style-name="T85">the </text:span>signature “bool isTimerExpired(SystemTime, Timeout, SystemTime)”. In the following implementation I handle SystemTime wrap around, assuming that timers timeouts are small relatively to the SystemTime maximum value. </text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">typedef</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">typedef</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Timeout</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">isTimerExpired</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> startTime, </text:span><text:span text:style-name="T41">Timeout</text:span><text:span text:style-name="T18"> timeout,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> currentTime) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> timerExpired = </text:span><text:span text:style-name="T5">false</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> timerExpiartionTime = startTime + timeout;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>timerExpired = timerExpired</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="12"/>|| ((timerExpiartionTime &gt;= currentTime)</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="20"/>&amp;&amp; (startTime &lt; currentTime));</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>timerExpired = timerExpired</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="12"/>|| ((timerExpiartionTime &gt;= currentTime)</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="20"/>&amp;&amp; (startTime &gt; currentTime));</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>timerExpired = timerExpired</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="12"/>|| ((timerExpiartionTime &lt;= currentTime)</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="20"/>&amp;&amp; (startTime &gt; currentTime)</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="20"/>&amp;&amp; (timerExpiartionTime &lt; startTime));</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> timerExpired;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">My API has an enumeration of possible return codes of <text:span text:style-name="T85">the </text:span>C+11 kind. C++11 “enum class” is not an integer and can not be converted to <text:span text:style-name="T85">an </text:span>integer. A member of one enumeration can not be assigned to a member of another enumeration.</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">enum</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> TimerError {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T67">Ok</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T67">Expired</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T67">Stopped</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T67">Illegal</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T67">NoFreeTimer</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T67">NoRunningTimers</text:span></text:p>
   <text:p text:style-name="P22">};</text:p>
   <text:p text:style-name="Text_20_body">I need an application callback which handles timer expiration. The callback could be a template function in a more advanced design:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">typedef</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> (*</text:span><text:span text:style-name="T41">TimerExpirationHandler</text:span><text:span text:style-name="T18">)(</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Timer</text:span><text:span text:style-name="T18">&amp; timer);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Text_20_body">I am going to provide synchronization API via an argument to the constructor. In the base class TimerLock I set the get/release interface to zero. <text:span text:style-name="T85">T</text:span>he <text:span text:style-name="T85">lock API is</text:span> going to be implemented by the derivative. Typical performance overhead of a virtual function is 1 or 2 opcodes.</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">TimerLock</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">virtual</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">get</text:span><text:span text:style-name="T18">() = 0;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">virtual</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">release</text:span><text:span text:style-name="T18">() = 0;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">virtual</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">~TimerLock</text:span><text:span text:style-name="T18">() {}</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text">};</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">TimerLockDummy</text:span><text:span text:style-name="T18"> : </text:span><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">TimerLock</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">virtual</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">get</text:span><text:span text:style-name="T18">() {}</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">virtual</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">release</text:span><text:span text:style-name="T18">() {}</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">};</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P62">I need a cyclic buffer <text:span text:style-name="T85">that </text:span>uses <text:span text:style-name="T85">the </text:span>dynamic allocation from the heap via operator new[]. <text:span text:style-name="T85">I</text:span>n the previous chapters I have discussed the operator new[] and situations when <text:span text:style-name="T85">an </text:span>allocation from the memory heap is not possible.</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T5">class</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">CyclicBufferDynamic</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">CyclicBufferDynamic</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> size);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">~CyclicBufferDynamic</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">isEmpty</text:span><text:span text:style-name="T18">();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">isFull</text:span><text:span text:style-name="T18">();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">add</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> object);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">remove</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> *object);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">getHead</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> *object);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">private</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">errorOverflow</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">void</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">errorUnderflow</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">increment</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> index);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> *</text:span><text:span text:style-name="T66">data</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">size</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">};</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Constructor calls <text:span text:style-name="T85">the operator </text:span>new[] to allocate array of pointers. There is a static assert which insures that the template class is used only for pointers:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">CyclicBufferDynamic&lt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T22"><text:s text:c="8"/>ObjectType, Lock&gt;::CyclicBufferDynamic</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> size) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18"> = 0;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18"> = 0;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">size</text:span><text:span text:style-name="T18"> = size;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">data</text:span><text:span text:style-name="T18"> = </text:span><text:span text:style-name="T5">new</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">[size];</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">static_assert</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">sizeof</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">) &lt;= </text:span><text:span text:style-name="T5">sizeof</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18">), </text:span><text:span text:style-name="T51">&quot;CyclicBuffer is intended to work only with integer types or pointers&quot;</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58"><text:span text:style-name="T85">The r</text:span>est of the code is similar to the previous implementation:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">CyclicBufferDynamic&lt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T22"><text:s text:c="8"/>ObjectType, Lock&gt;::isEmpty</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> res = (</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18"> == </text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">CyclicBufferDynamic&lt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T22"><text:s text:c="8"/>ObjectType, Lock&gt;::isFull</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> tail = increment(</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> res = (</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18"> == tail);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">CyclicBufferDynamic&lt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T22"><text:s text:c="8"/>ObjectType, Lock&gt;::add</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> object) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T22"> </text:span><text:span text:style-name="T21">lock</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (!isFull()) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">data</text:span><text:span text:style-name="T18">[</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18">] = object;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18"> = increment(</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">tail</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">true</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>} </text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="8"/>errorOverflow();</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">false</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">CyclicBufferDynamic&lt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T22"><text:s text:c="8"/>ObjectType, Lock&gt;::remove</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> *object) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T22"> </text:span><text:span text:style-name="T21">lock</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (!isEmpty()) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>*object = </text:span><text:span text:style-name="T66">data</text:span><text:span text:style-name="T18">[</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18">];</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18"> = </text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;increment(</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">true</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>} </text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="8"/>errorUnderflow();</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">false</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">CyclicBufferDynamic&lt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T22"><text:s text:c="8"/>ObjectType, Lock&gt;::getHead</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18"> *object) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T21">lock</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (!isEmpty()) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>*object = </text:span><text:span text:style-name="T66">data</text:span><text:span text:style-name="T18">[</text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">head</text:span><text:span text:style-name="T18">];</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">true</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>} </text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="8"/>errorUnderflow();</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">false</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">template</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">ObjectType</text:span><text:span text:style-name="T18">, </text:span><text:span text:style-name="T5">typename</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T56">Lock</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">CyclicBufferDynamic&lt;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T22">ObjectType, Lock&gt;::increment</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> index) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (index &lt; </text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">size</text:span><text:span text:style-name="T18">) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> (index + 1);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>} </text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> 0;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Use of LockDummy is deliberate here. I do not need reentrant cyclic buffers to store pointer<text:span text:style-name="T85">s</text:span> to objects of <text:span text:style-name="T85">the </text:span>class Timer:</text:p>
   <text:p text:style-name="Standard"><text:span text:style-name="T5">typedef</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">CyclicBufferDynamic</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T41">Timer</text:span><text:span text:style-name="T18">*, </text:span><text:span text:style-name="T41">LockDummy</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T41">TimerCyclicBuffer</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Text_20_body">A list of timers keeps timers with the same timeout. <text:span text:style-name="T85">The t</text:span>imers expiration time depends on the start time. The timer API assumes that there are finite and relatively small number of different timers, timers with different timeout, in the system. <text:span text:style-name="T85">Often </text:span>I know what timers I need in the system <text:span text:style-name="T85">even </text:span>before I start to write the code: </text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T6">class</text:span><text:span text:style-name="T19"> </text:span><text:span text:style-name="T42">TimerList</text:span><text:span text:style-name="T19"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">public</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">TimerList</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> size, </text:span><text:span text:style-name="T41">Timeout</text:span><text:span text:style-name="T18"> timeout, </text:span></text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="7"/></text:span><text:span text:style-name="T41">TimerExpirationHandler</text:span><text:span text:style-name="T18"> expirationHandler,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="7"/></text:span><text:span text:style-name="T41">TimerLock </text:span><text:span text:style-name="T18">&amp;timerLock,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="7"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> callExpiredForStoppedTimers=</text:span><text:span text:style-name="T5">false</text:span><text:span text:style-name="T18">) :</text:span></text:p>
   <text:p text:style-name="P22"/>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="7"/></text:span><text:span text:style-name="T66">timeout</text:span><text:span text:style-name="T18">(timeout), </text:span></text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="7"/></text:span><text:span text:style-name="T66">expirationHandler</text:span><text:span text:style-name="T18">(expirationHandler), </text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="7"/></text:span><text:span text:style-name="T66">callExpiredForStoppedTimers</text:span><text:span text:style-name="T18">(</text:span></text:p>
   <text:p text:style-name="P25"><text:s text:c="7"/>callExpiredForStoppedTimers), </text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="7"/></text:span><text:span text:style-name="T66">freeTimers</text:span><text:span text:style-name="T18">(size), </text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="7"/></text:span><text:span text:style-name="T66">runningTimers</text:span><text:span text:style-name="T18">(size),</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="7"/></text:span><text:span text:style-name="T66">timerLock</text:span><text:span text:style-name="T18">(timerLock) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="7"/></text:span><text:span text:style-name="T41">Timer</text:span><text:span text:style-name="T18"> *timers = </text:span><text:span text:style-name="T5">new</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Timer</text:span><text:span text:style-name="T18">[size];</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="7"/></text:span><text:span text:style-name="T5">for</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> i = 0;i &lt; size;i++) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="11"/></text:span><text:span text:style-name="T66">freeTimers</text:span><text:span text:style-name="T18">.add(&amp;timers[i]);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="7"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T18"><text:s text:c="4"/>TimerError </text:span><text:span text:style-name="T22">processExpiredTimers</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">enum</text:span><text:span text:style-name="T18"> TimerError </text:span><text:span text:style-name="T22">startTimer</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> currentTime,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T41">SystemTime </text:span><text:span text:style-name="T18">&amp;nearestExpirationTime, </text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> applicationData = 0,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Timer </text:span><text:span text:style-name="T18">**timer = </text:span><text:span text:style-name="T5">nullptr</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">enum</text:span><text:span text:style-name="T18"> TimerError </text:span><text:span text:style-name="T22">stopTimer</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">Timer </text:span><text:span text:style-name="T18">&amp;timer) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="8"/>timer.stop();</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> TimerError::</text:span><text:span text:style-name="T67">Ok</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">getNearestExpirationTime</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">nearestExpirationTime</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">inline</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">TimerID</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">getNextId</text:span><text:span text:style-name="T18">();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">enum</text:span><text:span text:style-name="T18"> TimerError </text:span><text:span text:style-name="T22">_startTimer</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> currentTime,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T41">SystemTime </text:span><text:span text:style-name="T18">&amp;nearestExpirationTime, </text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> applicationData = 0,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Timer </text:span><text:span text:style-name="T18">**timer = </text:span><text:span text:style-name="T5">nullptr</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>TimerError </text:span><text:span text:style-name="T22">_processExpiredTimers</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">Timeout</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">timeout</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">TimerExpirationHandler</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">expirationHandler</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">callExpiredForStoppedTimers</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">nearestExpirationTime</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">CyclicBufferDynamic</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T41">Timer</text:span><text:span text:style-name="T18">*, </text:span><text:span text:style-name="T41">LockDummy</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T66">freeTimers</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">CyclicBufferDynamic</text:span><text:span text:style-name="T18">&lt;</text:span><text:span text:style-name="T41">Timer</text:span><text:span text:style-name="T18">*, </text:span><text:span text:style-name="T41">LockDummy</text:span><text:span text:style-name="T18">&gt; </text:span><text:span text:style-name="T66">runningTimers</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">TimerLock </text:span><text:span text:style-name="T18">&amp;</text:span><text:span text:style-name="T66">timerLock</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">};</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Protected methods of the TimerList class are not necessary thread safe. For example getNextId() implementation is not thread safe. Only a child class or another method can access protected class members and shall take care of <text:span text:style-name="T85">the </text:span>synchronization:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T39">TimerID</text:span> <text:span text:style-name="T70">TimerList::getNextId</text:span>() {</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">TimerID</text:span><text:span text:style-name="T18"> id = 0;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>id++;</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> id;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T5">enum</text:span><text:span text:style-name="T18"> TimerError </text:span><text:span text:style-name="T22">TimerList::startTimer</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> currentTime,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">SystemTime </text:span><text:span text:style-name="T18">&amp;nearestExpirationTime, </text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> applicationData,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Timer </text:span><text:span text:style-name="T18">**timer) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T66">timerLock</text:span><text:span text:style-name="T18">.get();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>TimerError res = </text:span><text:span text:style-name="T41">TimerList</text:span><text:span text:style-name="T18">::_startTimer(currentTime,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="12"/>nearestExpirationTime, applicationData,</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="12"/>timer);</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T66">timerLock</text:span><text:span text:style-name="T18">.release();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58"><text:span text:style-name="T85">The protected m</text:span>ethod _startTimer() moves a timer from the list of <text:span text:style-name="T85">the </text:span>free timers to the list of <text:span text:style-name="T85">the </text:span>running timers</text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T5">enum</text:span><text:span text:style-name="T18"> TimerError </text:span><text:span text:style-name="T22">TimerList::_startTimer</text:span><text:span text:style-name="T18">(</text:span></text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="3"/></text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> currentTime,</text:span></text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="3"/></text:span><text:span text:style-name="T41">SystemTime </text:span><text:span text:style-name="T18">&amp;nearestExpirationTime, </text:span></text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="3"/></text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> applicationData,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="3"/></text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">Timer </text:span><text:span text:style-name="T18">**timer) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">Timer</text:span><text:span text:style-name="T18">* newTimer;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T66">freeTimers</text:span><text:span text:style-name="T18">.isEmpty())</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> TimerError::</text:span><text:span text:style-name="T67">NoFreeTimer</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T66">freeTimers</text:span><text:span text:style-name="T18">.remove(&amp;newTimer);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>newTimer-&gt;setStartTime(currentTime);</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>newTimer-&gt;setApplicationData(applicationData);</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>newTimer-&gt;setId(</text:span><text:span text:style-name="T26">getNextId</text:span><text:span text:style-name="T18">());</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>newTimer-&gt;start();</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T66">runningTimers</text:span><text:span text:style-name="T18">.add(newTimer);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">Timer</text:span><text:span text:style-name="T18">* headTimer;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T66">runningTimers</text:span><text:span text:style-name="T18">.getHead(&amp;headTimer);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>nearestExpirationTime = headTimer-&gt;getStartTime() + </text:span><text:span text:style-name="T66">timeout</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">nearestExpirationTime</text:span><text:span text:style-name="T18"> = nearestExpirationTime;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (timer != </text:span><text:span text:style-name="T5">nullptr</text:span><text:span text:style-name="T18">)</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="8"/>*timer = newTimer;</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> TimerError::</text:span><text:span text:style-name="T67">Ok</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Text_20_body"><text:span text:style-name="T85">The m</text:span>ethod _processExpiredTimers() moves stopped and expired timers from the head of the list of <text:span text:style-name="T85">the </text:span>running timers to the list of <text:span text:style-name="T85">the </text:span>free timers. A user of the timer list shall call processExpiredTimers() which will call the application callback for expired timers. The user shall call getNearestExpirationTime() to get expiration time for the next timer, time when processExpiredTimers() shall be called again. Difference between <text:span text:style-name="T85">the </text:span>nearestExpirationTime and currentTime can be used, for example, in the system call to sleep(). <text:span text:style-name="T85">T</text:span>imers on the runningTimers list is ordered by expiration time. I always add timer<text:span text:style-name="T85">s</text:span> to the tail and timeout is the same for all timers on the list. <text:span text:style-name="T85">The p</text:span>rotected method is not reentrant:</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="P72"><text:span text:style-name="T18">TimerError </text:span><text:span text:style-name="T22">TimerList::_processExpiredTimers</text:span><text:span text:style-name="T18">(</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> currentTime) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">Timer</text:span><text:span text:style-name="T18">* timer;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">while</text:span><text:span text:style-name="T18"> (!</text:span><text:span text:style-name="T66">runningTimers</text:span><text:span text:style-name="T18">.isEmpty()) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (!</text:span><text:span text:style-name="T66">runningTimers</text:span><text:span text:style-name="T18">.getHead(&amp;timer))</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T5">break</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> timerExpired = isTimerExpired(timer-&gt;getStartTime(), </text:span><text:span text:style-name="T66">timeout</text:span><text:span text:style-name="T18">,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="16"/>currentTime);</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> timerIsRunning = timer-&gt;isRunning();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> callExpirationHandler = timerExpired;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="8"/>callExpirationHandler = callExpirationHandler</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="16"/>|| (!timerIsRunning &amp;&amp; </text:span><text:span text:style-name="T66">callExpiredForStoppedTimers</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (callExpirationHandler) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/>(</text:span><text:span text:style-name="T66">expirationHandler</text:span><text:span text:style-name="T18">)(*timer);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="8"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (timerExpired || !timerIsRunning) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T66">runningTimers</text:span><text:span text:style-name="T18">.remove(&amp;timer);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T66">freeTimers</text:span><text:span text:style-name="T18">.add(timer);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="8"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (!timerExpired &amp;&amp; timerIsRunning) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T66">nearestExpirationTime</text:span><text:span text:style-name="T18"> = timer-&gt;getStartTime() + </text:span><text:span text:style-name="T66">timeout</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="8"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (!</text:span><text:span text:style-name="T66">runningTimers</text:span><text:span text:style-name="T18">.isEmpty())</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> TimerError::</text:span><text:span text:style-name="T67">Ok</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">else</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> TimerError::</text:span><text:span text:style-name="T67">NoRunningTimers</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Public method is reentrant:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18">TimerError </text:span><text:span text:style-name="T22">TimerList::processExpiredTimers</text:span><text:span text:style-name="T18">(</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> currentTime) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T66">timerLock</text:span><text:span text:style-name="T18">.get();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>TimerError res = </text:span><text:span text:style-name="T41">TimerList</text:span><text:span text:style-name="T18">::_processExpiredTimers(currentTime);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T66">timerLock</text:span><text:span text:style-name="T18">.release();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> res;</text:span></text:p>
   <text:p text:style-name="P22">}</text:p>
   <text:p text:style-name="P22"/>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">I group timer lists in “sets”. For example, a set of relatively long, low priority timers with timeouts 5s, 20s, 60s and a set of high priority timers. Different sets can be served by threads running in different priorities. I know what timers types belong to a set at <text:span text:style-name="T85">the </text:span>compilation time. </text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T10">class</text:span> <text:span text:style-name="T39">TimerSet</text:span> {</text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T5">p</text:span><text:span text:style-name="T7">ublic</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T22">TimerSet</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18">* name, </text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> size) :</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T66">name</text:span><text:span text:style-name="T18">(name), </text:span><text:span text:style-name="T66">listCount</text:span><text:span text:style-name="T18">(size) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">this</text:span><text:span text:style-name="T18">-&gt;</text:span><text:span text:style-name="T66">size</text:span><text:span text:style-name="T18"> = size;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">timerLists</text:span><text:span text:style-name="T18"> = </text:span><text:span text:style-name="T5">new</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">TimerList</text:span><text:span text:style-name="T18">*[size];</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18"> *</text:span><text:span text:style-name="T22">getName</text:span><text:span text:style-name="T18">() {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">name</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>TimerError </text:span><text:span text:style-name="T22">processExpiredTimers</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> currentTime,</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18">&amp; expirationTime);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">addList</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">TimerList</text:span><text:span text:style-name="T18">* list);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">protected</text:span><text:span text:style-name="T18">:</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">const</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">char</text:span><text:span text:style-name="T18"> *</text:span><text:span text:style-name="T66">name</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">TimerList</text:span><text:span text:style-name="T18"> **</text:span><text:span text:style-name="T66">timerLists</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">listCount</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T66">size</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">};</text:p>
   <text:p text:style-name="P40"/>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Add list API fills the array timerLists:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">TimerSet::addList</text:span><text:span text:style-name="T18">(</text:span><text:span text:style-name="T41">TimerList</text:span><text:span text:style-name="T18">* list) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T66">listCount</text:span><text:span text:style-name="T18"> &lt; </text:span><text:span text:style-name="T66">size</text:span><text:span text:style-name="T18">) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">timerLists</text:span><text:span text:style-name="T18">[</text:span><text:span text:style-name="T66">listCount</text:span><text:span text:style-name="T18">] = list;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T66">listCount</text:span><text:span text:style-name="T18">++;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">true</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>} </text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T5">false</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="P22"/>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Method processExpiredTimers() calls corresponding API in all timer lists and conveniently returns next time the method should be called. Complexity of the method is O(number of timer lists).</text:p>
   <text:p text:style-name="Preformatted_20_Text">TimerError <text:span text:style-name="T70">TimerSet::processExpiredTimers</text:span>(</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> currentTime, </text:span><text:span text:style-name="T41">SystemTime </text:span><text:span text:style-name="T18">&amp;expirationTime) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">TimerList</text:span><text:span text:style-name="T18">* timerList;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">size_t</text:span><text:span text:style-name="T18"> i;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> nearestExpirationTime;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">bool</text:span><text:span text:style-name="T18"> res = </text:span><text:span text:style-name="T5">false</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">for</text:span><text:span text:style-name="T18"> (i = 0; i &lt; </text:span><text:span text:style-name="T66">listCount</text:span><text:span text:style-name="T18">; i++) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>timerList = </text:span><text:span text:style-name="T66">timerLists</text:span><text:span text:style-name="T18">[i];</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="8"/>TimerError timerRes = timerList-&gt;processExpiredTimers(currentTime);</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/>res = res || (timerRes == TimerError::</text:span><text:span text:style-name="T67">Ok</text:span><text:span text:style-name="T18">);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (timerRes == TimerError::</text:span><text:span text:style-name="T67">Ok</text:span><text:span text:style-name="T18">) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> listExpirationTime =</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="20"/>timerList-&gt;getNearestExpirationTime();</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (!res) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="16"/>nearestExpirationTime = listExpirationTime;</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="12"/>} </text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="16"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (nearestExpirationTime &gt; listExpirationTime) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="20"/>nearestExpirationTime = listExpirationTime;</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="16"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="12"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="8"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (res)</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> TimerError::</text:span><text:span text:style-name="T67">Ok</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">else</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> TimerError::</text:span><text:span text:style-name="T67">NoRunningTimers</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:p text:style-name="P58">Finally a usage example:</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T10">static</text:span> <text:span text:style-name="T10">void</text:span> <text:span text:style-name="T70">mainExpirationHandler</text:span>(<text:span text:style-name="T10">const</text:span> <text:span text:style-name="T39">Timer</text:span>&amp; timer) {</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">TimerID</text:span><text:span text:style-name="T18"> timerId = timer.getId();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">uintptr_t</text:span><text:span text:style-name="T18"> data = timer.getApplicationData();</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/>cout &lt;&lt; </text:span><text:span text:style-name="T51">&quot;Expired id=&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; timerId &lt;&lt; </text:span><text:span text:style-name="T51">&quot;,</text:span><text:span text:style-name="T53">appdata</text:span><text:span text:style-name="T51">=&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; data &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T41">TimerLockDummy</text:span><text:span text:style-name="T18"> timerLock;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">static</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T41">TimerList</text:span><text:span text:style-name="T18"> timerList(3, 3, mainExpirationHandler, timerLock);</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> </text:span><text:span text:style-name="T22">main</text:span><text:span text:style-name="T18">()</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">{</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> currentTime = 0;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">for</text:span><text:span text:style-name="T18"> (</text:span><text:span text:style-name="T5">int</text:span><text:span text:style-name="T18"> i = 0;i &lt; 3;i++) {</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T41">SystemTime</text:span><text:span text:style-name="T18"> nearestExpirationTime;</text:span></text:p>
   <text:p text:style-name="P33"><text:s text:c="8"/>TimerError err = </text:p>
   <text:p text:style-name="P33"><text:s text:c="10"/>timerList.startTimer(currentTime, </text:p>
   <text:p text:style-name="P33"><text:s text:c="10"/>nearestExpirationTime, i);</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">if</text:span><text:span text:style-name="T18"> (err == TimerError::</text:span><text:span text:style-name="T67">Ok</text:span><text:span text:style-name="T18">) {</text:span></text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="12"/>cout &lt;&lt; </text:span><text:span text:style-name="T51">&quot;nearestExpirationTime=&quot;</text:span><text:span text:style-name="T18"> &lt;&lt; </text:span></text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="12"/>nearestExpirationTime &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="8"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="8"/></text:span><text:span text:style-name="T5">else</text:span><text:span text:style-name="T18"> {</text:span></text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="12"/>cout &lt;&lt; </text:span><text:span text:style-name="T51">&quot;timer start failed for timer &quot;</text:span><text:span text:style-name="T18"> </text:span></text:p>
   <text:p text:style-name="P33"><text:span text:style-name="T18"><text:s text:c="12"/>&lt;&lt; i &lt;&lt; </text:span><text:span text:style-name="T55">endl</text:span><text:span text:style-name="T18">;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="8"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>}</text:p>
   <text:p text:style-name="Preformatted_20_Text"/>
   <text:p text:style-name="Preformatted_20_Text"><text:s text:c="4"/>timerList.processExpiredTimers(3);</text:p>
   <text:p text:style-name="Preformatted_20_Text"><text:span text:style-name="T18"><text:s text:c="4"/></text:span><text:span text:style-name="T5">return</text:span><text:span text:style-name="T18"> 0;</text:span></text:p>
   <text:p text:style-name="Preformatted_20_Text">}</text:p>
   <text:p text:style-name="Text_20_body"/>
   <text:h text:style-name="P110" text:outline-level="1"/>
   <text:h text:style-name="P67" text:outline-level="1"><text:bookmark-start text:name="__RefHeading__12016_732733800"/>Conclusion.<text:bookmark-end text:name="__RefHeading__12016_732733800"/></text:h>
   <text:p text:style-name="Quotations">You have delighted us long enough. Let the other young ladies have time to exhibit – Jane Austen, Pride and Prejudice.</text:p>
   <text:p text:style-name="Quotations"/>
   <text:p text:style-name="Text_20_body">I hope you have found the book interesting and worth the time and money spent. This book gets updates often. You can always get the updated version by turning “Automatic Update” on in the “Manage Your Content and Devices” <text:span text:style-name="T90">part of the Amazon WEB site</text:span>. </text:p>
   <text:p text:style-name="Text_20_body">Please let me know what do you think or ask questions. <text:span text:style-name="T85">M</text:span>y e‑mail <text:span text:style-name="T85">is</text:span> <text:a xlink:type="simple" xlink:href="mailto:larytet@yahoo.com?subject=C++%20for%20embedded%20systems:%20...">mailto:arkady.miasnikov@gmail.com?subject=C++ for embedded systems: …</text:a></text:p>
   <text:p text:style-name="Text_20_body">Thank you, Arkady.</text:p>
  </office:text>
 </office:body>
</office:document>